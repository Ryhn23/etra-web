(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const Ee=class Ee{constructor(e=0){e<1?(this._ptr=[],this._capacity=0,this._size=0):(this._ptr=new Array(e),this._capacity=e,this._size=0)}at(e){return this._ptr[e]}set(e,t){this._ptr[e]=t}get(e=0){const t=new Array;for(let i=e;i<this._size;i++)t.push(this._ptr[i]);return t}pushBack(e){this._size>=this._capacity&&this.prepareCapacity(this._capacity==0?Ee.DefaultSize:this._capacity*2),this._ptr[this._size++]=e}clear(){this._ptr.length=0,this._size=0}getSize(){return this._size}assign(e,t){this._size<e&&this.prepareCapacity(e);for(let s=0;s<e;s++)this._ptr[s]=t;this._size=e}resize(e,t=null){this.updateSize(e,t,!0)}updateSize(e,t=null,i=!0){if(this._size<e)if(this.prepareCapacity(e),i)for(let r=this._size;r<e;r++)typeof t=="function"?this._ptr[r]=JSON.parse(JSON.stringify(new t)):this._ptr[r]=t;else for(let r=this._size;r<e;r++)this._ptr[r]=t;else{const r=this._size-e;this._ptr.splice(this._size-r,r)}this._size=e}insert(e,t,i){let s=e._index;const r=t._index,n=i._index,o=n-r;this.prepareCapacity(this._size+o);const l=this._size-s;if(l>0)for(let h=0;h<l;h++)this._ptr.splice(s+h,0,null);for(let h=r;h<n;h++,s++)this._ptr[s]=t._vector._ptr[h];this._size=this._size+o}remove(e){return e<0||this._size<=e?!1:(this._ptr.splice(e,1),--this._size,!0)}erase(e){const t=e._index;return t<0||this._size<=t?e:(this._ptr.splice(t,1),--this._size,new st(this,t))}prepareCapacity(e){e>this._capacity&&(this._capacity==0?(this._ptr=new Array(e),this._capacity=e):(this._ptr.length=e,this._capacity=e))}begin(){return this._size==0?this.end():new st(this,0)}end(){return new st(this,this._size)}getOffset(e){const t=new Ee;return t._ptr=this.get(e),t._size=this.get(e).length,t._capacity=this.get(e).length,t}};Ee.DefaultSize=10;let C=Ee,st=class Mt{constructor(e,t){this._vector=e??null,this._index=t??0}set(e){return this._index=e._index,this._vector=e._vector,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new Mt(this._vector,this._index++)}decrement(){return new Mt(this._vector,this._index--)}ptr(){return this._vector._ptr[this._index]}substitution(e){return this._index=e._index,this._vector=e._vector,this}notEqual(e){return this._index!=e._index||this._vector!=e._vector}};var Dt;(a=>{a.csmVector=C,a.iterator=st})(Dt||(Dt={}));class ${append(e,t){return this.s+=t!==void 0?e.substr(0,t):e,this}expansion(e,t){for(let i=0;i<e;i++)this.append(t);return this}getBytes(){return encodeURIComponent(this.s).replace(/%../g,"x").length}getLength(){return this.s.length}isLess(e){return this.s<e.s}isGreat(e){return this.s>e.s}isEqual(e){return this.s==e}isEmpty(){return this.s.length==0}constructor(e){this.s=e}}var Lt;(a=>{a.csmString=$})(Lt||(Lt={}));class Be{static createIdInternal(e){return new Be(e)}getString(){return this._id}isEqual(e){return typeof e=="string"?this._id.isEqual(e):e instanceof $?this._id.isEqual(e.s):e instanceof Be?this._id.isEqual(e._id.s):!1}isNotEqual(e){return typeof e=="string"?!this._id.isEqual(e):e instanceof $?!this._id.isEqual(e.s):e instanceof Be?!this._id.isEqual(e._id.s):!1}constructor(e){if(typeof e=="string"){this._id=new $(e);return}this._id=e}}var At;(a=>{a.CubismId=Be})(At||(At={}));class is{constructor(){this._ids=new C}release(){for(let e=0;e<this._ids.getSize();++e)this._ids.set(e,void 0);this._ids=null}registerIds(e){for(let t=0;t<e.length;t++)this.registerId(e[t])}registerId(e){let t=null;if(typeof e=="string"){if((t=this.findId(e))!=null)return t;t=Be.createIdInternal(e),this._ids.pushBack(t)}else return this.registerId(e.s);return t}getId(e){return this.registerId(e)}isExist(e){return typeof e=="string"?this.findId(e)!=null:this.isExist(e.s)}findId(e){for(let t=0;t<this._ids.getSize();++t)if(this._ids.at(t).getString().isEqual(e))return this._ids.at(t);return null}}var kt;(a=>{a.CubismIdManager=is})(kt||(kt={}));class M{constructor(e,t){this.x=e,this.y=t,this.x=e??0,this.y=t??0}add(e){const t=new M(0,0);return t.x=this.x+e.x,t.y=this.y+e.y,t}substract(e){const t=new M(0,0);return t.x=this.x-e.x,t.y=this.y-e.y,t}multiply(e){const t=new M(0,0);return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByScaler(e){return this.multiply(new M(e,e))}division(e){const t=new M(0,0);return t.x=this.x/e.x,t.y=this.y/e.y,t}divisionByScalar(e){return this.division(new M(e,e))}getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)}getDistanceWith(e){return Math.sqrt((this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y))}dot(e){return this.x*e.x+this.y*e.y}normalize(){const e=Math.pow(this.x*this.x+this.y*this.y,.5);this.x=this.x/e,this.y=this.y/e}isEqual(e){return this.x==e.x&&this.y==e.y}isNotEqual(e){return!this.isEqual(e)}}var Nt;(a=>{a.CubismVector2=M})(Nt||(Nt={}));const Me=class Me{static range(e,t,i){return e<t?e=t:e>i&&(e=i),e}static sin(e){return Math.sin(e)}static cos(e){return Math.cos(e)}static abs(e){return Math.abs(e)}static sqrt(e){return Math.sqrt(e)}static cbrt(e){if(e===0)return e;let t=e;const i=t<0;i&&(t=-t);let s;return t===1/0?s=1/0:(s=Math.exp(Math.log(t)/3),s=(t/(s*s)+2*s)/3),i?-s:s}static getEasingSine(e){return e<0?0:e>1?1:.5-.5*this.cos(e*Math.PI)}static max(e,t){return e>t?e:t}static min(e,t){return e>t?t:e}static clamp(e,t,i){return e<t?t:i<e?i:e}static degreesToRadian(e){return e/180*Math.PI}static radianToDegrees(e){return e*180/Math.PI}static directionToRadian(e,t){const i=Math.atan2(t.y,t.x),s=Math.atan2(e.y,e.x);let r=i-s;for(;r<-Math.PI;)r+=Math.PI*2;for(;r>Math.PI;)r-=Math.PI*2;return r}static directionToDegrees(e,t){const i=this.directionToRadian(e,t);let s=this.radianToDegrees(i);return t.x-e.x>0&&(s=-s),s}static radianToDirection(e){const t=new M;return t.x=this.sin(e),t.y=this.cos(e),t}static quadraticEquation(e,t,i){return this.abs(e)<Me.Epsilon?this.abs(t)<Me.Epsilon?-i:-i/t:-(t+this.sqrt(t*t-4*e*i))/(2*e)}static cardanoAlgorithmForBezier(e,t,i,s){if(this.abs(e)<Me.Epsilon)return this.range(this.quadraticEquation(t,i,s),0,1);const r=t/e,n=i/e,o=s/e,l=(3*n-r*r)/3,h=l/3,u=(2*r*r*r-9*r*n+27*o)/27,d=u/2,_=d*d+h*h*h,g=.5,c=g+.01;if(_<0){const m=-l/3,y=m*m*m,v=this.sqrt(y),B=-u/(2*v),I=this.range(B,-1,1),O=Math.acos(I),de=2*this.cbrt(v),Ot=de*this.cos(O/3)-r/3;if(this.abs(Ot-g)<c)return this.range(Ot,0,1);const Et=de*this.cos((O+2*Math.PI)/3)-r/3;if(this.abs(Et-g)<c)return this.range(Et,0,1);const Us=de*this.cos((O+4*Math.PI)/3)-r/3;return this.range(Us,0,1)}if(_==0){let m;d<0?m=this.cbrt(-d):m=-this.cbrt(d);const y=2*m-r/3;if(this.abs(y-g)<c)return this.range(y,0,1);const v=-m-r/3;return this.range(v,0,1)}const p=this.sqrt(_),f=this.cbrt(p-d),x=this.cbrt(p+d),P=f-x-r/3;return this.range(P,0,1)}static mod(e,t){if(!isFinite(e)||t===0||isNaN(e)||isNaN(t))return console.warn(`divided: ${e}, divisor: ${t} mod() returns 'NaN'.`),NaN;const i=Math.abs(e),s=Math.abs(t);let r=i-Math.floor(i/s)*s;return r*=Math.sign(e),r}constructor(){}};Me.Epsilon=1e-5;let S=Me;var Ut;(a=>{a.CubismMath=S})(Ut||(Ut={}));class E{constructor(){this._tr=new Float32Array(16),this.loadIdentity()}static multiply(e,t,i){const s=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),r=4;for(let n=0;n<r;++n)for(let o=0;o<r;++o)for(let l=0;l<r;++l)s[o+n*4]+=e[l+n*4]*t[o+l*4];for(let n=0;n<16;++n)i[n]=s[n]}loadIdentity(){const e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setMatrix(e)}setMatrix(e){for(let t=0;t<16;++t)this._tr[t]=e[t]}getArray(){return this._tr}getScaleX(){return this._tr[0]}getScaleY(){return this._tr[5]}getTranslateX(){return this._tr[12]}getTranslateY(){return this._tr[13]}transformX(e){return this._tr[0]*e+this._tr[12]}transformY(e){return this._tr[5]*e+this._tr[13]}invertTransformX(e){return(e-this._tr[12])/this._tr[0]}invertTransformY(e){return(e-this._tr[13])/this._tr[5]}translateRelative(e,t){const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e,t,0,1]);E.multiply(i,this._tr,this._tr)}translate(e,t){this._tr[12]=e,this._tr[13]=t}translateX(e){this._tr[12]=e}translateY(e){this._tr[13]=e}scaleRelative(e,t){const i=new Float32Array([e,0,0,0,0,t,0,0,0,0,1,0,0,0,0,1]);E.multiply(i,this._tr,this._tr)}scale(e,t){this._tr[0]=e,this._tr[5]=t}multiplyByMatrix(e){E.multiply(e.getArray(),this._tr,this._tr)}getInvert(){const e=this._tr[0],t=this._tr[1],i=this._tr[2],s=this._tr[4],r=this._tr[5],n=this._tr[6],o=this._tr[8],l=this._tr[9],h=this._tr[10],u=this._tr[12],d=this._tr[13],_=this._tr[14],g=e*(r*h-l*n)-s*(t*h-l*i)+o*(t*n-r*i),c=new E;if(S.abs(g)<S.Epsilon)return c.loadIdentity(),c;const p=1/g,f=(r*h-l*n)*p,x=-(s*h-o*n)*p,P=(s*l-o*r)*p,m=-(t*h-l*i)*p,y=(e*h-o*i)*p,v=-(e*l-o*t)*p,B=(t*n-r*i)*p,I=-(e*n-s*i)*p,O=(e*r-s*t)*p;return c._tr[0]=f,c._tr[1]=m,c._tr[2]=B,c._tr[3]=0,c._tr[4]=x,c._tr[5]=y,c._tr[6]=I,c._tr[7]=0,c._tr[8]=P,c._tr[9]=v,c._tr[10]=O,c._tr[11]=0,c._tr[12]=-(f*u+x*d+P*_),c._tr[13]=-(m*u+y*d+v*_),c._tr[14]=-(B*u+I*d+O*_),c._tr[15]=1,c}clone(){const e=new E;for(let t=0;t<this._tr.length;t++)e._tr[t]=this._tr[t];return e}}var zt;(a=>{a.CubismMatrix44=E})(zt||(zt={}));class at{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}getCenterX(){return this.x+.5*this.width}getCenterY(){return this.y+.5*this.height}getRight(){return this.x+this.width}getBottom(){return this.y+this.height}setRect(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height}expand(e,t){this.x-=e,this.y-=t,this.width+=e*2,this.height+=t*2}}var Xt;(a=>{a.csmRect=at})(Xt||(Xt={}));const zs=(a,e,t)=>{vt.print(a,"[CSM]"+e,t)},$e=(a,e,t)=>{zs(a,e+`
`,t)},G=a=>{console.assert(a)};let Ae,z,F,w;Ae=(a,...e)=>{$e(ue.LogLevel_Debug,"[D]"+a,e)},z=(a,...e)=>{$e(ue.LogLevel_Info,"[I]"+a,e)},F=(a,...e)=>{$e(ue.LogLevel_Warning,"[W]"+a,e)},w=(a,...e)=>{$e(ue.LogLevel_Error,"[E]"+a,e)};class vt{static print(e,t,i){if(e<T.getLoggingLevel())return;const s=T.coreLogFunction;if(!s)return;const r=t.replace(/\{(\d+)\}/g,(n,o)=>i[o]);s(r)}static dumpBytes(e,t,i){for(let s=0;s<i;s++)s%16==0&&s>0?this.print(e,`
`):s%8==0&&s>0&&this.print(e,"  "),this.print(e,"{0} ",[t[s]&255]);this.print(e,`
`)}constructor(){}}var Gt;(a=>{a.CubismDebug=vt})(Gt||(Gt={}));class ut{static create(){return null}static delete(e){}initialize(e){this._model=e,e.isBlendModeEnabled()&&(this.useHighPrecisionMask(!0),z("This model uses a high-resolution mask because it operates in blend mode."))}drawModel(){this.getModel()!=null&&this.doDrawModel()}setMvpMatrix(e){this._mvpMatrix4x4.setMatrix(e.getArray())}getMvpMatrix(){return this._mvpMatrix4x4}setModelColor(e,t,i,s){this._modelColor.r=S.clamp(e,0,1),this._modelColor.g=S.clamp(t,0,1),this._modelColor.b=S.clamp(i,0,1),this._modelColor.a=S.clamp(s,0,1)}getModelColor(){return JSON.parse(JSON.stringify(this._modelColor))}getModelColorWithOpacity(e){const t=this.getModelColor();return t.a*=e,this.isPremultipliedAlpha()&&(t.r*=t.a,t.g*=t.a,t.b*=t.a),t}setIsPremultipliedAlpha(e){this._isPremultipliedAlpha=e}isPremultipliedAlpha(){return this._isPremultipliedAlpha}setIsCulling(e){this._isCulling=e}isCulling(){return this._isCulling}setAnisotropy(e){this._anisotropy=e}getAnisotropy(){return this._anisotropy}getModel(){return this._model}useHighPrecisionMask(e){this._useHighPrecisionMask=e}isUsingHighPrecisionMask(){return this._useHighPrecisionMask}setRenderTargetSize(e,t){this._modelRenderTargetWidth=e,this._modelRenderTargetHeight=t}constructor(e,t){this._modelRenderTargetWidth=e,this._modelRenderTargetHeight=t,this._isCulling=!1,this._isPremultipliedAlpha=!1,this._anisotropy=0,this._model=null,this._modelColor=new D,this._useHighPrecisionMask=!1,this._mvpMatrix4x4=new E,this._mvpMatrix4x4.loadIdentity()}}var ne=(a=>(a[a.CubismBlendMode_Normal=0]="CubismBlendMode_Normal",a[a.CubismBlendMode_Additive=1]="CubismBlendMode_Additive",a[a.CubismBlendMode_Multiplicative=2]="CubismBlendMode_Multiplicative",a))(ne||{}),A=(a=>(a[a.DrawableObjectType_Drawable=0]="DrawableObjectType_Drawable",a[a.DrawableObjectType_Offscreen=1]="DrawableObjectType_Offscreen",a))(A||{});class D{constructor(e=1,t=1,i=1,s=1){this.r=e,this.g=t,this.b=i,this.a=s}}class Xs{constructor(e,t){this._clippingIdList=e,this._clippingIdCount=t,this._allClippedDrawRect=new at,this._layoutBounds=new at,this._clippedDrawableIndexList=[],this._clippedOffscreenIndexList=[],this._matrixForMask=new E,this._matrixForDraw=new E,this._bufferIndex=0,this._layoutChannelIndex=0}release(){this._layoutBounds!=null&&(this._layoutBounds=null),this._allClippedDrawRect!=null&&(this._allClippedDrawRect=null),this._clippedDrawableIndexList!=null&&(this._clippedDrawableIndexList=null),this._clippedOffscreenIndexList!=null&&(this._clippedOffscreenIndexList=null)}addClippedDrawable(e){this._clippedDrawableIndexList.push(e)}addClippedOffscreen(e){this._clippedOffscreenIndexList.push(e)}}var jt;(a=>{a.CubismBlendMode=ne,a.CubismRenderer=ut,a.CubismTextureColor=D})(jt||(jt={}));class ss{constructor(e,t){this.first=e??null,this.second=t??null}}const De=class De{constructor(e){e!=null?e<1?(this._keyValues=[],this._dummyValue=null,this._size=0):(this._keyValues=new Array(e),this._size=e):(this._keyValues=[],this._dummyValue=null,this._size=0)}release(){this.clear()}appendKey(e){let t=-1;for(let i=0;i<this._size;i++)if(this._keyValues[i].first==e){t=i;break}if(t!=-1){F("The key `{0}` is already append.",e);return}this.prepareCapacity(this._size+1,!1),this._keyValues[this._size]=new ss(e),this._size+=1}getValue(e){let t=-1;for(let i=0;i<this._size;i++)if(this._keyValues[i].first==e){t=i;break}return t>=0?this._keyValues[t].second:(this.appendKey(e),this._keyValues[this._size-1].second)}setValue(e,t){let i=-1;for(let s=0;s<this._size;s++)if(this._keyValues[s].first==e){i=s;break}i>=0?this._keyValues[i].second=t:(this.appendKey(e),this._keyValues[this._size-1].second=t)}isExist(e){for(let t=0;t<this._size;t++)if(this._keyValues[t].first==e)return!0;return!1}clear(){this._keyValues=void 0,this._keyValues=null,this._keyValues=[],this._size=0}getSize(){return this._size}prepareCapacity(e,t){e>this._keyValues.length&&(this._keyValues.length==0?(!t&&e<De.DefaultSize&&(e=De.DefaultSize),this._keyValues.length=e):(!t&&e<this._keyValues.length*2&&(e=this._keyValues.length*2),this._keyValues.length=e))}begin(){return new ge(this,0)}end(){return new ge(this,this._size)}erase(e){const t=e._index;return t<0||this._size<=t?e:(this._keyValues.splice(t,1),--this._size,new ge(this,t))}dumpAsInt(){for(let e=0;e<this._size;e++)Ae("{0} ,",this._keyValues[e]),Ae(`
`)}};De.DefaultSize=10;let N=De;class ge{constructor(e,t){this._map=e??new N,this._index=t??0}set(e){return this._index=e._index,this._map=e._map,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new ge(this._map,this._index++)}decrement(){const e=new ge(this._map,this._index);return this._map=e._map,this._index=e._index,this}ptr(){return this._map._keyValues[this._index]}notEqual(e){return this._index!=e._index||this._map!=e._map}}var Yt;(a=>{a.csmMap=N,a.csmPair=ss,a.iterator=ge})(Yt||(Yt={}));class nt{static parseJsonObject(e,t){return Object.keys(e).forEach(i=>{if(typeof e[i]=="boolean"){const s=!!e[i];t.put(i,new K(s))}else if(typeof e[i]=="string"){const s=String(e[i]);t.put(i,new we(s))}else if(typeof e[i]=="number"){const s=Number(e[i]);t.put(i,new lt(s))}else e[i]instanceof Array?t.put(i,nt.parseJsonArray(e[i])):e[i]instanceof Object?t.put(i,nt.parseJsonObject(e[i],new ve)):e[i]==null?t.put(i,new Pe):t.put(i,e[i])}),t}static parseJsonArray(e){const t=new wt;return Object.keys(e).forEach(i=>{if(typeof Number(i)=="number")if(typeof e[i]=="boolean"){const r=!!e[i];t.add(new K(r))}else if(typeof e[i]=="string"){const r=String(e[i]);t.add(new we(r))}else if(typeof e[i]=="number"){const r=Number(e[i]);t.add(new lt(r))}else e[i]instanceof Array?t.add(this.parseJsonArray(e[i])):e[i]instanceof Object?t.add(this.parseJsonObject(e[i],new ve)):e[i]==null?t.add(new Pe):t.add(e[i]);else if(e[i]instanceof Array)t.add(this.parseJsonArray(e[i]));else if(e[i]instanceof Object)t.add(this.parseJsonObject(e[i],new ve));else if(e[i]==null)t.add(new Pe);else{const r=Array(e[i]);for(let n=0;n<r.length;n++)t.add(r[n])}}),t}}const ot="Error: type mismatch",Gs="Error: index out of bounds";let X=class Q{constructor(){}getRawString(e,t){return this.getString(e,t)}toInt(e=0){return e}toFloat(e=0){return e}toBoolean(e=!1){return e}getSize(){return 0}getArray(e=null){return e}getVector(e=new C){return e}getMap(e){return e}getValueByIndex(e){return Q.errorValue.setErrorNotForClientCall(ot)}getValueByString(e){return Q.nullValue.setErrorNotForClientCall(ot)}getKeys(){return Q.dummyKeys}isError(){return!1}isNull(){return!1}isBool(){return!1}isFloat(){return!1}isString(){return!1}isArray(){return!1}isMap(){return!1}equals(e){return!1}isStatic(){return!1}setErrorNotForClientCall(e){return ke.errorValue}static staticInitializeNotForClientCall(){K.trueValue=new K(!0),K.falseValue=new K(!1),Q.errorValue=new ke("ERROR",!0),Q.nullValue=new Pe,Q.dummyKeys=new C}static staticReleaseNotForClientCall(){K.trueValue=null,K.falseValue=null,Q.errorValue=null,Q.nullValue=null,Q.dummyKeys=null}};class U{constructor(e,t){this._parseCallback=nt.parseJsonObject,this._error=null,this._lineCount=0,this._root=null,e!=null&&this.parseBytes(e,t,this._parseCallback)}static create(e,t){const i=new U;return i.parseBytes(e,t,i._parseCallback)?i:(U.delete(i),null)}static delete(e){}getRoot(){return this._root}static arrayBufferToString(e){const t=new Uint8Array(e);let i="";for(let s=0,r=t.length;s<r;++s)i+="%"+this.pad(t[s].toString(16));return i=decodeURIComponent(i),i}static pad(e){return e.length<2?"0"+e:e}parseBytes(e,t,i){const s=new Array(1),r=U.arrayBufferToString(e);if(i==null?this._root=this.parseValue(r,t,0,s):this._root=i(JSON.parse(r),new ve),this._error){let n="\0";return n="Json parse error : @line "+(this._lineCount+1)+`
`,this._root=new we(n),z("{0}",this._root.getRawString()),!1}else if(this._root==null)return this._root=new ke(new $(this._error),!1),!1;return!0}getParseError(){return this._error}checkEndOfFile(){return this._root.getArray()[1].equals("EOF")}parseValue(e,t,i,s){if(this._error)return null;let r=null,n=i,o;for(;n<t;n++)switch(e[n]){case"-":case".":case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const h=new Array(1);return o=js(e.slice(n),h),s[0]=e.indexOf(h[0]),new lt(o)}case'"':return new we(this.parseString(e,t,n+1,s));case"[":return r=this.parseArray(e,t,n+1,s),r;case"{":return r=this.parseObject(e,t,n+1,s),r;case"n":return n+3<t?(r=new Pe,s[0]=n+4):this._error="parse null",r;case"t":return n+3<t?(r=K.trueValue,s[0]=n+4):this._error="parse true",r;case"f":return n+4<t?(r=K.falseValue,s[0]=n+5):this._error="illegal ',' position",r;case",":return this._error="illegal ',' position",null;case"]":return s[0]=n,null;case`
`:this._lineCount++}return this._error="illegal end of value",null}parseString(e,t,i,s){if(this._error)return null;if(!e)return this._error="string is null",null;let r=i,n,o;const l=new $("");let h=i;for(;r<t;r++)switch(n=e[r],n){case'"':return s[0]=r+1,l.append(e.slice(h),r-h),l.s;case"//":if(r++,r-1>h&&l.append(e.slice(h),r-h),h=r+1,r<t)switch(o=e[r],o){case"\\":l.expansion(1,"\\");break;case'"':l.expansion(1,'"');break;case"/":l.expansion(1,"/");break;case"b":l.expansion(1,"\b");break;case"f":l.expansion(1,"\f");break;case"n":l.expansion(1,`
`);break;case"r":l.expansion(1,"\r");break;case"t":l.expansion(1,"	");break;case"u":this._error="parse string/unicord escape not supported";break}else this._error="parse string/escape error"}return this._error="parse string/illegal end",null}parseObject(e,t,i,s){if(this._error)return null;if(!e)return this._error="buffer is null",null;const r=new ve;let n="",o=i,l="";const h=Array(1);let u=!1;for(;o<t;o++){e:for(;o<t;o++)switch(l=e[o],l){case'"':if(n=this.parseString(e,t,o+1,h),this._error)return null;o=h[0],u=!0;break e;case"}":return s[0]=o+1,r;case":":this._error="illegal ':' position";break;case`
`:this._lineCount++}if(!u)return this._error="key not found",null;u=!1;e:for(;o<t;o++)switch(l=e[o],l){case":":u=!0,o++;break e;case"}":this._error="illegal '}' position";break;case`
`:this._lineCount++}if(!u)return this._error="':' not found",null;const d=this.parseValue(e,t,o,h);if(this._error)return null;o=h[0],r.put(n,d);e:for(;o<t;o++)switch(l=e[o],l){case",":break e;case"}":return s[0]=o+1,r;case`
`:this._lineCount++}}return this._error="illegal end of perseObject",null}parseArray(e,t,i,s){if(this._error)return null;if(!e)return this._error="buffer is null",null;let r=new wt,n=i,o;const l=new Array(1);for(;n<t;n++){const h=this.parseValue(e,t,n,l);if(this._error)return null;n=l[0],h&&r.add(h);e:for(;n<t;n++)switch(o=e[n],o){case",":break e;case"]":return s[0]=n+1,r;case`
`:++this._lineCount}}return r=void 0,this._error="illegal end of parseObject",null}}class lt extends X{constructor(e){super(),this._value=e}isFloat(){return!0}getString(e,t){const i="\0";return this._value=parseFloat(i),this._stringBuffer=i,this._stringBuffer}toInt(e=0){return parseInt(this._value.toString())}toFloat(e=0){return this._value}equals(e){return typeof e=="number"?Math.round(e)?!1:e==this._value:!1}}class K extends X{isBool(){return!0}toBoolean(e=!1){return this._boolValue}getString(e,t){return this._stringBuffer=this._boolValue?"true":"false",this._stringBuffer}equals(e){return typeof e=="boolean"?e==this._boolValue:!1}isStatic(){return!0}constructor(e){super(),this._boolValue=e}}class we extends X{constructor(e){super(),typeof e=="string"&&(this._stringBuffer=e),e instanceof $&&(this._stringBuffer=e.s)}isString(){return!0}getString(e,t){return this._stringBuffer}equals(e){return typeof e=="string"?this._stringBuffer==e:e instanceof $?this._stringBuffer==e.s:!1}}class ke extends we{isStatic(){return this._isStatic}setErrorNotForClientCall(e){return this._stringBuffer=e,this}constructor(e,t){typeof e=="string"?super(e):super(e),this._isStatic=t}isError(){return!0}}class Pe extends X{isNull(){return!0}getString(e,t){return this._stringBuffer}isStatic(){return!0}setErrorNotForClientCall(e){return this._stringBuffer=e,ke.nullValue}constructor(){super(),this._stringBuffer="NullValue"}}class wt extends X{constructor(){super(),this._array=new C}release(){for(let e=this._array.begin();e.notEqual(this._array.end());e.preIncrement()){let t=e.ptr();t&&!t.isStatic()&&(t=void 0,t=null)}}isArray(){return!0}getValueByIndex(e){if(e<0||this._array.getSize()<=e)return X.errorValue.setErrorNotForClientCall(Gs);const t=this._array.at(e);return t??X.nullValue}getValueByString(e){return X.errorValue.setErrorNotForClientCall(ot)}getString(e,t){const i=t+`[
`;for(let s=this._array.begin();s.notEqual(this._array.end());s.increment()){const r=s.ptr();this._stringBuffer+=t+""+r.getString(t+" ")+`
`}return this._stringBuffer=i+t+`]
`,this._stringBuffer}add(e){this._array.pushBack(e)}getVector(e=null){return this._array}getSize(){return this._array.getSize()}}class ve extends X{constructor(){super(),this._map=new N}release(){const e=this._map.begin();for(;e.notEqual(this._map.end());){let t=e.ptr().second;t&&!t.isStatic()&&(t=void 0,t=null),e.preIncrement()}}isMap(){return!0}getValueByString(e){if(e instanceof $){const t=this._map.getValue(e.s);return t??X.nullValue}for(let t=this._map.begin();t.notEqual(this._map.end());t.preIncrement())if(t.ptr().first==e)return t.ptr().second==null?X.nullValue:t.ptr().second;return X.nullValue}getValueByIndex(e){return X.errorValue.setErrorNotForClientCall(ot)}getString(e,t){this._stringBuffer=t+`{
`;const i=this._map.begin();for(;i.notEqual(this._map.end());){const s=i.ptr().first,r=i.ptr().second;this._stringBuffer+=t+" "+s+" : "+r.getString(t+"   ")+` 
`,i.preIncrement()}return this._stringBuffer+=t+`}
`,this._stringBuffer}getMap(e){return this._map}put(e,t){this._map.setValue(e,t)}getKeys(){if(!this._keys){this._keys=new C;const e=this._map.begin();for(;e.notEqual(this._map.end());){const t=e.ptr().first;this._keys.pushBack(t),e.preIncrement()}}return this._keys}getSize(){return this._keys.getSize()}}var Ht;(a=>{a.CubismJson=U,a.JsonArray=wt,a.JsonBoolean=K,a.JsonError=ke,a.JsonFloat=lt,a.JsonMap=ve,a.JsonNullvalue=Pe,a.JsonString=we,a.Value=X})(Ht||(Ht={}));function js(a,e){let t=0;for(let s=1;;s++){const r=a.slice(s-1,s);if(r=="e"||r=="-"||r=="E")continue;const n=a.substring(0,s),o=Number(n);if(isNaN(o))break;t=s}let i=parseFloat(a);return isNaN(i)&&(i=NaN),e[0]=a.slice(t),i}let q=!1,_e=!1,fe=null,Te=null;const Z=Object.freeze({vertexOffset:0,vertexStep:2});function Se(a){a&&(a=void 0)}class T{static startUp(e=null){if(q)return z("CubismFramework.startUp() is already done."),q;if(fe=e,fe!=null&&Live2DCubismCore.Logging.csmSetLogFunction(fe.logFunction),q=!0,q){const t=Live2DCubismCore.Version.csmGetVersion(),i=(t&4278190080)>>24,s=(t&16711680)>>16,r=t&65535,n=t;z("Live2D Cubism Core version: {0}.{1}.{2} ({3})",("00"+i).slice(-2),("00"+s).slice(-2),("0000"+r).slice(-4),n)}return z("CubismFramework.startUp() is complete."),q}static cleanUp(){q=!1,_e=!1,fe=null,Te=null}static initialize(e=0){if(G(q),!q){F("CubismFramework is not started.");return}if(_e){F("CubismFramework.initialize() skipped, already initialized.");return}X.staticInitializeNotForClientCall(),Te=new is,Live2DCubismCore.Memory.initializeAmountOfMemory(e),_e=!0,z("CubismFramework.initialize() is complete.")}static dispose(){if(G(q),!q){F("CubismFramework is not started.");return}if(!_e){F("CubismFramework.dispose() skipped, not initialized.");return}X.staticReleaseNotForClientCall(),Te.release(),Te=null,ut.staticRelease(),_e=!1,z("CubismFramework.dispose() is complete.")}static isStarted(){return q}static isInitialized(){return _e}static coreLogFunction(e){Live2DCubismCore.Logging.csmGetLogFunction()&&Live2DCubismCore.Logging.csmGetLogFunction()(e)}static getLoggingLevel(){return fe!=null?fe.loggingLevel:5}static getIdManager(){return Te}constructor(){}}class Ys{}var ue=(a=>(a[a.LogLevel_Verbose=0]="LogLevel_Verbose",a[a.LogLevel_Debug=1]="LogLevel_Debug",a[a.LogLevel_Info=2]="LogLevel_Info",a[a.LogLevel_Warning=3]="LogLevel_Warning",a[a.LogLevel_Error=4]="LogLevel_Error",a[a.LogLevel_Off=5]="LogLevel_Off",a))(ue||{}),Wt;(a=>{a.Constant=Z,a.csmDelete=Se,a.CubismFramework=T})(Wt||(Wt={}));const Re=1,$t=1,Hs=2,Ws=.8,$s=-1,qs=1,Js=-2,Ks=2,Zs=-2,Qs=2,rs="../../Resources/",er="back_class_normal.png",tr="icon_gear.png",xt=["Haru","Hiyori","Mark","Natori","Rice","Mao","Wanko","Ren"],ir=xt.length,sr="Idle",rr="TapBody",qt="Head",Jt="Body",ar=0,nr=1,or=2,lr=3,hr=ue.LogLevel_Verbose,xe=class xe{static loadFileAsBytes(e,t){fetch(e).then(i=>i.arrayBuffer()).then(i=>t(i,i.byteLength))}static getDeltaTime(){return this.deltaTime}static updateTime(){this.currentFrame=Date.now(),this.deltaTime=(this.currentFrame-this.lastFrame)/1e3,this.lastFrame=this.currentFrame}static printMessage(e){console.log(e)}};xe.lastUpdate=Date.now(),xe.currentFrame=0,xe.lastFrame=0,xe.deltaTime=0;let V=xe;class ur{constructor(){this._gl=null,this._gl=null}initialize(e){return this._gl=e.getContext("webgl2"),this._gl?!0:(alert("Cannot initialize WebGL. This browser does not support."),this._gl=null,!1)}release(){}getGl(){return this._gl}}const b=Object.freeze({HitAreaPrefix:"HitArea",HitAreaHead:"Head",HitAreaBody:"Body",PartsIdCore:"Parts01Core",PartsArmPrefix:"Parts01Arm_",PartsArmLPrefix:"Parts01ArmL_",PartsArmRPrefix:"Parts01ArmR_",ParamAngleX:"ParamAngleX",ParamAngleY:"ParamAngleY",ParamAngleZ:"ParamAngleZ",ParamEyeLOpen:"ParamEyeLOpen",ParamEyeLSmile:"ParamEyeLSmile",ParamEyeROpen:"ParamEyeROpen",ParamEyeRSmile:"ParamEyeRSmile",ParamEyeBallX:"ParamEyeBallX",ParamEyeBallY:"ParamEyeBallY",ParamEyeBallForm:"ParamEyeBallForm",ParamBrowLY:"ParamBrowLY",ParamBrowRY:"ParamBrowRY",ParamBrowLX:"ParamBrowLX",ParamBrowRX:"ParamBrowRX",ParamBrowLAngle:"ParamBrowLAngle",ParamBrowRAngle:"ParamBrowRAngle",ParamBrowLForm:"ParamBrowLForm",ParamBrowRForm:"ParamBrowRForm",ParamMouthForm:"ParamMouthForm",ParamMouthOpenY:"ParamMouthOpenY",ParamCheek:"ParamCheek",ParamBodyAngleX:"ParamBodyAngleX",ParamBodyAngleY:"ParamBodyAngleY",ParamBodyAngleZ:"ParamBodyAngleZ",ParamBreath:"ParamBreath",ParamArmLA:"ParamArmLA",ParamArmRA:"ParamArmRA",ParamArmLB:"ParamArmLB",ParamArmRB:"ParamArmRB",ParamHandL:"ParamHandL",ParamHandR:"ParamHandR",ParamHairFront:"ParamHairFront",ParamHairSide:"ParamHairSide",ParamHairBack:"ParamHairBack",ParamHairFluffy:"ParamHairFluffy",ParamShoulderY:"ParamShoulderY",ParamBustX:"ParamBustX",ParamBustY:"ParamBustY",ParamBaseX:"ParamBaseX",ParamBaseY:"ParamBaseY",ParamNONE:"NONE:"});var Kt;(a=>{a.HitAreaBody=b.HitAreaBody,a.HitAreaHead=b.HitAreaHead,a.HitAreaPrefix=b.HitAreaPrefix,a.ParamAngleX=b.ParamAngleX,a.ParamAngleY=b.ParamAngleY,a.ParamAngleZ=b.ParamAngleZ,a.ParamArmLA=b.ParamArmLA,a.ParamArmLB=b.ParamArmLB,a.ParamArmRA=b.ParamArmRA,a.ParamArmRB=b.ParamArmRB,a.ParamBaseX=b.ParamBaseX,a.ParamBaseY=b.ParamBaseY,a.ParamBodyAngleX=b.ParamBodyAngleX,a.ParamBodyAngleY=b.ParamBodyAngleY,a.ParamBodyAngleZ=b.ParamBodyAngleZ,a.ParamBreath=b.ParamBreath,a.ParamBrowLAngle=b.ParamBrowLAngle,a.ParamBrowLForm=b.ParamBrowLForm,a.ParamBrowLX=b.ParamBrowLX,a.ParamBrowLY=b.ParamBrowLY,a.ParamBrowRAngle=b.ParamBrowRAngle,a.ParamBrowRForm=b.ParamBrowRForm,a.ParamBrowRX=b.ParamBrowRX,a.ParamBrowRY=b.ParamBrowRY,a.ParamBustX=b.ParamBustX,a.ParamBustY=b.ParamBustY,a.ParamCheek=b.ParamCheek,a.ParamEyeBallForm=b.ParamEyeBallForm,a.ParamEyeBallX=b.ParamEyeBallX,a.ParamEyeBallY=b.ParamEyeBallY,a.ParamEyeLOpen=b.ParamEyeLOpen,a.ParamEyeLSmile=b.ParamEyeLSmile,a.ParamEyeROpen=b.ParamEyeROpen,a.ParamEyeRSmile=b.ParamEyeRSmile,a.ParamHairBack=b.ParamHairBack,a.ParamHairFluffy=b.ParamHairFluffy,a.ParamHairFront=b.ParamHairFront,a.ParamHairSide=b.ParamHairSide,a.ParamHandL=b.ParamHandL,a.ParamHandR=b.ParamHandR,a.ParamMouthForm=b.ParamMouthForm,a.ParamMouthOpenY=b.ParamMouthOpenY,a.ParamNONE=b.ParamNONE,a.ParamShoulderY=b.ParamShoulderY,a.PartsArmLPrefix=b.PartsArmLPrefix,a.PartsArmPrefix=b.PartsArmPrefix,a.PartsArmRPrefix=b.PartsArmRPrefix,a.PartsIdCore=b.PartsIdCore})(Kt||(Kt={}));class as{}var Zt;(a=>{a.ICubismModelSetting=as})(Zt||(Zt={}));var ns=(a=>(a[a.FrequestNode_Groups=0]="FrequestNode_Groups",a[a.FrequestNode_Moc=1]="FrequestNode_Moc",a[a.FrequestNode_Motions=2]="FrequestNode_Motions",a[a.FrequestNode_Expressions=3]="FrequestNode_Expressions",a[a.FrequestNode_Textures=4]="FrequestNode_Textures",a[a.FrequestNode_Physics=5]="FrequestNode_Physics",a[a.FrequestNode_Pose=6]="FrequestNode_Pose",a[a.FrequestNode_HitAreas=7]="FrequestNode_HitAreas",a))(ns||{});class os extends as{constructor(e,t){super(),this.version="Version",this.fileReferences="FileReferences",this.groups="Groups",this.layout="Layout",this.hitAreas="HitAreas",this.moc="Moc",this.textures="Textures",this.physics="Physics",this.pose="Pose",this.expressions="Expressions",this.motions="Motions",this.userData="UserData",this.name="Name",this.filePath="File",this.id="Id",this.ids="Ids",this.target="Target",this.idle="Idle",this.tapBody="TapBody",this.pinchIn="PinchIn",this.pinchOut="PinchOut",this.shake="Shake",this.flickHead="FlickHead",this.parameter="Parameter",this.soundPath="Sound",this.fadeInTime="FadeInTime",this.fadeOutTime="FadeOutTime",this.centerX="CenterX",this.centerY="CenterY",this.x="X",this.y="Y",this.width="Width",this.height="Height",this.lipSync="LipSync",this.eyeBlink="EyeBlink",this.initParameter="init_param",this.initPartsVisible="init_parts_visible",this.val="val",this._json=U.create(e,t),this.getJson()&&(this._jsonValue=new C,this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.groups)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.moc)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.motions)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.expressions)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.textures)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.physics)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.pose)),this._jsonValue.pushBack(this.getJson().getRoot().getValueByString(this.hitAreas)))}release(){U.delete(this._json),this._jsonValue=null}getJson(){return this._json}getModelFileName(){return this.isExistModelFile()?this._jsonValue.at(1).getRawString():""}getTextureCount(){return this.isExistTextureFiles()?this._jsonValue.at(4).getSize():0}getTextureDirectory(){const t=this._jsonValue.at(4).getValueByIndex(0).getRawString().split("/"),i=t.length-1;let s="";for(let r=0;r<i;r++)s+=t[r],r<i-1&&(s+="/");return s}getTextureFileName(e){return this._jsonValue.at(4).getValueByIndex(e).getRawString()}getHitAreasCount(){return this.isExistHitAreas()?this._jsonValue.at(7).getSize():0}getHitAreaId(e){return T.getIdManager().getId(this._jsonValue.at(7).getValueByIndex(e).getValueByString(this.id).getRawString())}getHitAreaName(e){return this._jsonValue.at(7).getValueByIndex(e).getValueByString(this.name).getRawString()}getPhysicsFileName(){return this.isExistPhysicsFile()?this._jsonValue.at(5).getRawString():""}getPoseFileName(){return this.isExistPoseFile()?this._jsonValue.at(6).getRawString():""}getExpressionCount(){return this.isExistExpressionFile()?this._jsonValue.at(3).getSize():0}getExpressionName(e){return this._jsonValue.at(3).getValueByIndex(e).getValueByString(this.name).getRawString()}getExpressionFileName(e){return this._jsonValue.at(3).getValueByIndex(e).getValueByString(this.filePath).getRawString()}getMotionGroupCount(){return this.isExistMotionGroups()?this._jsonValue.at(2).getKeys().getSize():0}getMotionGroupName(e){return this.isExistMotionGroups()?this._jsonValue.at(2).getKeys().at(e):null}getMotionCount(e){return this.isExistMotionGroupName(e)?this._jsonValue.at(2).getValueByString(e).getSize():0}getMotionFileName(e,t){return this.isExistMotionGroupName(e)?this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.filePath).getRawString():""}getMotionSoundFileName(e,t){return this.isExistMotionSoundFile(e,t)?this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.soundPath).getRawString():""}getMotionFadeInTimeValue(e,t){return this.isExistMotionFadeIn(e,t)?this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.fadeInTime).toFloat():-1}getMotionFadeOutTimeValue(e,t){return this.isExistMotionFadeOut(e,t)?this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.fadeOutTime).toFloat():-1}getUserDataFile(){return this.isExistUserDataFile()?this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.userData).getRawString():""}getLayoutMap(e){const t=this.getJson().getRoot().getValueByString(this.layout).getMap();if(t==null)return!1;let i=!1;for(const s=t.begin();s.notEqual(t.end());s.preIncrement())e.setValue(s.ptr().first,s.ptr().second.toFloat()),i=!0;return i}getEyeBlinkParameterCount(){if(!this.isExistEyeBlinkParameters())return 0;let e=0;for(let t=0;t<this._jsonValue.at(0).getSize();t++){const i=this._jsonValue.at(0).getValueByIndex(t);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.eyeBlink){e=i.getValueByString(this.ids).getVector().getSize();break}}return e}getEyeBlinkParameterId(e){if(!this.isExistEyeBlinkParameters())return null;for(let t=0;t<this._jsonValue.at(0).getSize();t++){const i=this._jsonValue.at(0).getValueByIndex(t);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.eyeBlink)return T.getIdManager().getId(i.getValueByString(this.ids).getValueByIndex(e).getRawString())}return null}getLipSyncParameterCount(){if(!this.isExistLipSyncParameters())return 0;let e=0;for(let t=0;t<this._jsonValue.at(0).getSize();t++){const i=this._jsonValue.at(0).getValueByIndex(t);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.lipSync){e=i.getValueByString(this.ids).getVector().getSize();break}}return e}getLipSyncParameterId(e){if(!this.isExistLipSyncParameters())return null;for(let t=0;t<this._jsonValue.at(0).getSize();t++){const i=this._jsonValue.at(0).getValueByIndex(t);if(!(i.isNull()||i.isError())&&i.getValueByString(this.name).getRawString()==this.lipSync)return T.getIdManager().getId(i.getValueByString(this.ids).getValueByIndex(e).getRawString())}return null}isExistModelFile(){const e=this._jsonValue.at(1);return!e.isNull()&&!e.isError()}isExistTextureFiles(){const e=this._jsonValue.at(4);return!e.isNull()&&!e.isError()}isExistHitAreas(){const e=this._jsonValue.at(7);return!e.isNull()&&!e.isError()}isExistPhysicsFile(){const e=this._jsonValue.at(5);return!e.isNull()&&!e.isError()}isExistPoseFile(){const e=this._jsonValue.at(6);return!e.isNull()&&!e.isError()}isExistExpressionFile(){const e=this._jsonValue.at(3);return!e.isNull()&&!e.isError()}isExistMotionGroups(){const e=this._jsonValue.at(2);return!e.isNull()&&!e.isError()}isExistMotionGroupName(e){const t=this._jsonValue.at(2).getValueByString(e);return!t.isNull()&&!t.isError()}isExistMotionSoundFile(e,t){const i=this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.soundPath);return!i.isNull()&&!i.isError()}isExistMotionFadeIn(e,t){const i=this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.fadeInTime);return!i.isNull()&&!i.isError()}isExistMotionFadeOut(e,t){const i=this._jsonValue.at(2).getValueByString(e).getValueByIndex(t).getValueByString(this.fadeOutTime);return!i.isNull()&&!i.isError()}isExistUserDataFile(){const e=this.getJson().getRoot().getValueByString(this.fileReferences).getValueByString(this.userData);return!e.isNull()&&!e.isError()}isExistEyeBlinkParameters(){if(this._jsonValue.at(0).isNull()||this._jsonValue.at(0).isError())return!1;for(let e=0;e<this._jsonValue.at(0).getSize();++e)if(this._jsonValue.at(0).getValueByIndex(e).getValueByString(this.name).getRawString()==this.eyeBlink)return!0;return!1}isExistLipSyncParameters(){if(this._jsonValue.at(0).isNull()||this._jsonValue.at(0).isError())return!1;for(let e=0;e<this._jsonValue.at(0).getSize();++e)if(this._jsonValue.at(0).getValueByIndex(e).getValueByString(this.name).getRawString()==this.lipSync)return!0;return!1}}var Qt;(a=>{a.CubismModelSettingJson=os,a.FrequestNode=ns})(Qt||(Qt={}));class He{static create(){return new He}static delete(e){}setParameters(e){this._breathParameters=e}getParameters(){return this._breathParameters}updateParameters(e,t){this._currentTime+=t;const i=this._currentTime*2*Math.PI;for(let s=0;s<this._breathParameters.getSize();++s){const r=this._breathParameters.at(s);e.addParameterValueById(r.parameterId,r.offset+r.peak*Math.sin(i/r.cycle),r.weight)}}constructor(){this._currentTime=0}}class ye{constructor(e,t,i,s,r){this.parameterId=e??null,this.offset=t??0,this.peak=i??0,this.cycle=s??0,this.weight=r??0}}var ei;(a=>{a.BreathParameterData=ye,a.CubismBreath=He})(ei||(ei={}));const Le=class Le{static create(e=null){return new Le(e)}static delete(e){}setBlinkingInterval(e){this._blinkingIntervalSeconds=e}setBlinkingSetting(e,t,i){this._closingSeconds=e,this._closedSeconds=t,this._openingSeconds=i}setParameterIds(e){this._parameterIds=e}getParameterIds(){return this._parameterIds}updateParameters(e,t){this._userTimeSeconds+=t;let i,s=0;switch(this._blinkingState){case 2:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closingSeconds,s>=1&&(s=1,this._blinkingState=3,this._stateStartTimeSeconds=this._userTimeSeconds),i=1-s;break;case 3:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closedSeconds,s>=1&&(this._blinkingState=4,this._stateStartTimeSeconds=this._userTimeSeconds),i=0;break;case 4:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._openingSeconds,s>=1&&(s=1,this._blinkingState=1,this._nextBlinkingTime=this.determinNextBlinkingTiming()),i=s;break;case 1:this._nextBlinkingTime<this._userTimeSeconds&&(this._blinkingState=2,this._stateStartTimeSeconds=this._userTimeSeconds),i=1;break;case 0:default:this._blinkingState=1,this._nextBlinkingTime=this.determinNextBlinkingTiming(),i=1;break}Le.CloseIfZero||(i=-i);for(let n=0;n<this._parameterIds.getSize();++n)e.setParameterValueById(this._parameterIds.at(n),i)}constructor(e){if(this._blinkingState=0,this._nextBlinkingTime=0,this._stateStartTimeSeconds=0,this._blinkingIntervalSeconds=4,this._closingSeconds=.1,this._closedSeconds=.05,this._openingSeconds=.15,this._userTimeSeconds=0,this._parameterIds=new C,e!=null)for(let t=0;t<e.getEyeBlinkParameterCount();++t)this._parameterIds.pushBack(e.getEyeBlinkParameterId(t))}determinNextBlinkingTiming(){const e=Math.random();return this._userTimeSeconds+e*(2*this._blinkingIntervalSeconds-1)}};Le.CloseIfZero=!0;let Ne=Le;var ls=(a=>(a[a.EyeState_First=0]="EyeState_First",a[a.EyeState_Interval=1]="EyeState_Interval",a[a.EyeState_Closing=2]="EyeState_Closing",a[a.EyeState_Closed=3]="EyeState_Closed",a[a.EyeState_Opening=4]="EyeState_Opening",a))(ls||{}),ti;(a=>{a.CubismEyeBlink=Ne,a.EyeState=ls})(ti||(ti={}));const gr=.001,dt=.5,ii="FadeInTime",si="Link",cr="Groups",dr="Id";class Ue{static create(e,t){const i=U.create(e,t);if(!i)return null;const s=new Ue,r=i.getRoot();r.getValueByString(ii).isNull()||(s._fadeTimeSeconds=r.getValueByString(ii).toFloat(dt),s._fadeTimeSeconds<0&&(s._fadeTimeSeconds=dt));const n=r.getValueByString(cr),o=n.getSize();for(let l=0;l<o;++l){const h=n.getValueByIndex(l),u=h.getSize();let d=0;for(let _=0;_<u;++_){const g=h.getValueByIndex(_),c=new ze,p=T.getIdManager().getId(g.getValueByString(dr).getRawString());if(c.partId=p,!g.getValueByString(si).isNull()){const f=g.getValueByString(si),x=f.getSize();for(let P=0;P<x;++P){const m=new ze,y=T.getIdManager().getId(f.getValueByIndex(P).getString());m.partId=y,c.link.pushBack(m)}}s._partGroups.pushBack(c.clone()),++d}s._partGroupCounts.pushBack(d)}return U.delete(i),s}static delete(e){}updateParameters(e,t){e!=this._lastModel&&this.reset(e),this._lastModel=e,t<0&&(t=0);let i=0;for(let s=0;s<this._partGroupCounts.getSize();s++){const r=this._partGroupCounts.at(s);this.doFade(e,t,i,r),i+=r}this.copyPartOpacities(e)}reset(e){let t=0;for(let i=0;i<this._partGroupCounts.getSize();++i){const s=this._partGroupCounts.at(i);for(let r=t;r<t+s;++r){this._partGroups.at(r).initialize(e);const n=this._partGroups.at(r).partIndex,o=this._partGroups.at(r).parameterIndex;if(!(n<0)){e.setPartOpacityByIndex(n,r==t?1:0),e.setParameterValueByIndex(o,r==t?1:0);for(let l=0;l<this._partGroups.at(r).link.getSize();++l)this._partGroups.at(r).link.at(l).initialize(e)}}t+=s}}copyPartOpacities(e){for(let t=0;t<this._partGroups.getSize();++t){const i=this._partGroups.at(t);if(i.link.getSize()==0)continue;const s=this._partGroups.at(t).partIndex,r=e.getPartOpacityByIndex(s);for(let n=0;n<i.link.getSize();++n){const l=i.link.at(n).partIndex;l<0||e.setPartOpacityByIndex(l,r)}}}doFade(e,t,i,s){let r=-1,n=1;const o=.5,l=.15;for(let h=i;h<i+s;++h){const u=this._partGroups.at(h).partIndex,d=this._partGroups.at(h).parameterIndex;if(e.getParameterValueByIndex(d)>gr){if(r>=0)break;if(r=h,this._fadeTimeSeconds==0){n=1;continue}n=e.getPartOpacityByIndex(u),n+=t/this._fadeTimeSeconds,n>1&&(n=1)}}r<0&&(r=0,n=1);for(let h=i;h<i+s;++h){const u=this._partGroups.at(h).partIndex;if(r==h)e.setPartOpacityByIndex(u,n);else{let d=e.getPartOpacityByIndex(u),_;n<o?_=n*(o-1)/o+1:_=(1-n)*o/(1-o),(1-_)*(1-n)>l&&(_=1-l/(1-n)),d>_&&(d=_),e.setPartOpacityByIndex(u,d)}}}constructor(){this._fadeTimeSeconds=dt,this._lastModel=null,this._partGroups=new C,this._partGroupCounts=new C}}class ze{constructor(e){if(this.parameterIndex=0,this.partIndex=0,this.link=new C,e!=null){this.partId=e.partId;for(const t=e.link.begin();t.notEqual(e.link.end());t.preIncrement())this.link.pushBack(t.ptr().clone())}}assignment(e){this.partId=e.partId;for(const t=e.link.begin();t.notEqual(e.link.end());t.preIncrement())this.link.pushBack(t.ptr().clone());return this}initialize(e){this.parameterIndex=e.getParameterIndex(this.partId),this.partIndex=e.getPartIndex(this.partId),e.setParameterValueByIndex(this.parameterIndex,1)}clone(){const e=new ze;e.partId=this.partId,e.parameterIndex=this.parameterIndex,e.partIndex=this.partIndex,e.link=new C;for(let t=this.link.begin();t.notEqual(this.link.end());t.increment())e.link.pushBack(t.ptr().clone());return e}}var ri;(a=>{a.CubismPose=Ue,a.PartData=ze})(ri||(ri={}));class hs extends E{constructor(e,t){super(),this._width=e!==void 0?e:0,this._height=t!==void 0?t:0,this.setHeight(2)}setWidth(e){const t=e/this._width,i=t;this.scale(t,i)}setHeight(e){const t=e/this._height,i=t;this.scale(t,i)}setPosition(e,t){this.translate(e,t)}setCenterPosition(e,t){this.centerX(e),this.centerY(t)}top(e){this.setY(e)}bottom(e){const t=this._height*this.getScaleY();this.translateY(e-t)}left(e){this.setX(e)}right(e){const t=this._width*this.getScaleX();this.translateX(e-t)}centerX(e){const t=this._width*this.getScaleX();this.translateX(e-t/2)}setX(e){this.translateX(e)}centerY(e){const t=this._height*this.getScaleY();this.translateY(e-t/2)}setY(e){this.translateY(e)}setupFromLayout(e){const t="width",i="height",s="x",r="y",n="center_x",o="center_y",l="top",h="bottom",u="left",d="right";for(const _=e.begin();_.notEqual(e.end());_.preIncrement()){const g=_.ptr().first,c=_.ptr().second;g==t?this.setWidth(c):g==i&&this.setHeight(c)}for(const _=e.begin();_.notEqual(e.end());_.preIncrement()){const g=_.ptr().first,c=_.ptr().second;g==s?this.setX(c):g==r?this.setY(c):g==n?this.centerX(c):g==o?this.centerY(c):g==l?this.top(c):g==h?this.bottom(c):g==u?this.left(c):g==d&&this.right(c)}}}var ai;(a=>{a.CubismModelMatrix=hs})(ai||(ai={}));const _t=30,ni=.01;class us{constructor(){this._faceTargetX=0,this._faceTargetY=0,this._faceX=0,this._faceY=0,this._faceVX=0,this._faceVY=0,this._lastTimeSeconds=0,this._userTimeSeconds=0}update(e){this._userTimeSeconds+=e;const i=40/10*1/_t;if(this._lastTimeSeconds==0){this._lastTimeSeconds=this._userTimeSeconds;return}const s=(this._userTimeSeconds-this._lastTimeSeconds)*_t;this._lastTimeSeconds=this._userTimeSeconds;const n=.15*_t,o=s*i/n,l=this._faceTargetX-this._faceX,h=this._faceTargetY-this._faceY;if(S.abs(l)<=ni&&S.abs(h)<=ni)return;const u=S.sqrt(l*l+h*h),d=i*l/u,_=i*h/u;let g=d-this._faceVX,c=_-this._faceVY;const p=S.sqrt(g*g+c*c);(p<-o||p>o)&&(g*=o/p,c*=o/p),this._faceVX+=g,this._faceVY+=c;{const f=.5*(S.sqrt(o*o+16*o*u-8*o*u)-o),x=S.sqrt(this._faceVX*this._faceVX+this._faceVY*this._faceVY);x>f&&(this._faceVX*=f/x,this._faceVY*=f/x)}this._faceX+=this._faceVX,this._faceY+=this._faceVY}getX(){return this._faceX}getY(){return this._faceY}set(e,t){this._faceTargetX=e,this._faceTargetY=t}}var oi;(a=>{a.CubismTargetPoint=us})(oi||(oi={}));class Fe{constructor(){this.setBeganMotionHandler=e=>this._onBeganMotion=e,this.getBeganMotionHandler=()=>this._onBeganMotion,this.setFinishedMotionHandler=e=>this._onFinishedMotion=e,this.getFinishedMotionHandler=()=>this._onFinishedMotion,this._fadeInSeconds=-1,this._fadeOutSeconds=-1,this._weight=1,this._offsetSeconds=0,this._isLoop=!1,this._isLoopFadeIn=!0,this._previousLoopState=this._isLoop,this._firedEventValues=new C}static delete(e){e.release(),e=null}release(){this._weight=0}updateParameters(e,t,i){if(!t.isAvailable()||t.isFinished())return;this.setupMotionQueueEntry(t,i);const s=this.updateFadeWeight(t,i);this.doUpdateParameters(e,i,s,t),t.getEndTime()>0&&t.getEndTime()<i&&t.setIsFinished(!0)}setupMotionQueueEntry(e,t){e==null||e.isStarted()||e.isAvailable()&&(e.setIsStarted(!0),e.setStartTime(t-this._offsetSeconds),e.setFadeInStartTime(t),e.getEndTime()<0&&this.adjustEndTime(e),e._motion._onBeganMotion&&e._motion._onBeganMotion(e._motion))}updateFadeWeight(e,t){e==null&&vt.print(ue.LogLevel_Error,"motionQueueEntry is null.");let i=this._weight;const s=this._fadeInSeconds==0?1:S.getEasingSine((t-e.getFadeInStartTime())/this._fadeInSeconds),r=this._fadeOutSeconds==0||e.getEndTime()<0?1:S.getEasingSine((e.getEndTime()-t)/this._fadeOutSeconds);return i=i*s*r,e.setState(t,i),G(0<=i&&i<=1),i}setFadeInTime(e){this._fadeInSeconds=e}setFadeOutTime(e){this._fadeOutSeconds=e}getFadeOutTime(){return this._fadeOutSeconds}getFadeInTime(){return this._fadeInSeconds}setWeight(e){this._weight=e}getWeight(){return this._weight}getDuration(){return-1}getLoopDuration(){return-1}setOffsetTime(e){this._offsetSeconds=e}setLoop(e){this._isLoop=e}getLoop(){return this._isLoop}setLoopFadeIn(e){this._isLoopFadeIn=e}getLoopFadeIn(){return this._isLoopFadeIn}getFiredEvent(e,t){return this._firedEventValues}isExistModelOpacity(){return!1}getModelOpacityIndex(){return-1}getModelOpacityId(e){return null}getModelOpacityValue(){return 1}adjustEndTime(e){const t=this.getDuration(),i=t<=0?-1:e.getStartTime()+t;e.setEndTime(i)}}var li;(a=>{a.ACubismMotion=Fe})(li||(li={}));const _r="FadeInTime",fr="FadeOutTime",hi="Parameters",pr="Id",mr="Value",qe="Blend",Cr="Add",yr="Multiply",Sr="Overwrite",ui=1,H=class H extends Fe{static create(e,t){const i=new H;return i.parse(e,t),i}doUpdateParameters(e,t,i,s){for(let r=0;r<this._parameters.getSize();++r){const n=this._parameters.at(r);switch(n.blendType){case 0:{e.addParameterValueById(n.parameterId,n.value,i);break}case 1:{e.multiplyParameterValueById(n.parameterId,n.value,i);break}case 2:{e.setParameterValueById(n.parameterId,n.value,i);break}}}}calculateExpressionParameters(e,t,i,s,r,n){if(!(i==null||s==null)&&i.isAvailable()){this._fadeWeight=this.updateFadeWeight(i,t);for(let o=0;o<s.getSize();++o){const l=s.at(o);if(l.parameterId==null)continue;const h=l.overwriteValue=e.getParameterValueById(l.parameterId),u=this.getExpressionParameters();let d=-1;for(let f=0;f<u.getSize();++f)if(l.parameterId==u.at(f).parameterId){d=f;break}if(d<0){r==0?(l.additiveValue=H.DefaultAdditiveValue,l.multiplyValue=H.DefaultMultiplyValue,l.overwriteValue=h):(l.additiveValue=this.calculateValue(l.additiveValue,H.DefaultAdditiveValue,n),l.multiplyValue=this.calculateValue(l.multiplyValue,H.DefaultMultiplyValue,n),l.overwriteValue=this.calculateValue(l.overwriteValue,h,n));continue}const _=u.at(d).value;let g,c,p;switch(u.at(d).blendType){case 0:g=_,c=H.DefaultMultiplyValue,p=h;break;case 1:g=H.DefaultAdditiveValue,c=_,p=h;break;case 2:g=H.DefaultAdditiveValue,c=H.DefaultMultiplyValue,p=_;break;default:return}r==0?(l.additiveValue=g,l.multiplyValue=c,l.overwriteValue=p):(l.additiveValue=l.additiveValue*(1-n)+g*n,l.multiplyValue=l.multiplyValue*(1-n)+c*n,l.overwriteValue=l.overwriteValue*(1-n)+p*n)}}}getExpressionParameters(){return this._parameters}getFadeWeight(){return this._fadeWeight}parse(e,t){const i=U.create(e,t);if(!i)return;const s=i.getRoot();this.setFadeInTime(s.getValueByString(_r).toFloat(ui)),this.setFadeOutTime(s.getValueByString(fr).toFloat(ui));const r=s.getValueByString(hi).getSize();this._parameters.prepareCapacity(r);for(let n=0;n<r;++n){const o=s.getValueByString(hi).getValueByIndex(n),l=T.getIdManager().getId(o.getValueByString(pr).getRawString()),h=o.getValueByString(mr).toFloat();let u;o.getValueByString(qe).isNull()||o.getValueByString(qe).getString()==Cr?u=0:o.getValueByString(qe).getString()==yr?u=1:o.getValueByString(qe).getString()==Sr?u=2:u=0;const d=new cs;d.parameterId=l,d.blendType=u,d.value=h,this._parameters.pushBack(d)}U.delete(i)}calculateValue(e,t,i){return e*(1-i)+t*i}constructor(){super(),this._parameters=new C,this._fadeWeight=0}};H.DefaultAdditiveValue=0,H.DefaultMultiplyValue=1;let re=H;var gs=(a=>(a[a.Additive=0]="Additive",a[a.Multiply=1]="Multiply",a[a.Overwrite=2]="Overwrite",a))(gs||{});class cs{}var gi;(a=>{a.CubismExpressionMotion=re,a.ExpressionBlendType=gs,a.ExpressionParameter=cs})(gi||(gi={}));class ds{constructor(){this._autoDelete=!1,this._motion=null,this._available=!0,this._finished=!1,this._started=!1,this._startTimeSeconds=-1,this._fadeInStartTimeSeconds=0,this._endTimeSeconds=-1,this._stateTimeSeconds=0,this._stateWeight=0,this._lastEventCheckSeconds=0,this._motionQueueEntryHandle=this,this._fadeOutSeconds=0,this._isTriggeredFadeOut=!1}release(){this._autoDelete&&this._motion&&Fe.delete(this._motion)}setFadeOut(e){this._fadeOutSeconds=e,this._isTriggeredFadeOut=!0}startFadeOut(e,t){const i=t+e;this._isTriggeredFadeOut=!0,(this._endTimeSeconds<0||i<this._endTimeSeconds)&&(this._endTimeSeconds=i)}isFinished(){return this._finished}isStarted(){return this._started}getStartTime(){return this._startTimeSeconds}getFadeInStartTime(){return this._fadeInStartTimeSeconds}getEndTime(){return this._endTimeSeconds}setStartTime(e){this._startTimeSeconds=e}setFadeInStartTime(e){this._fadeInStartTimeSeconds=e}setEndTime(e){this._endTimeSeconds=e}setIsFinished(e){this._finished=e}setIsStarted(e){this._started=e}isAvailable(){return this._available}setIsAvailable(e){this._available=e}setState(e,t){this._stateTimeSeconds=e,this._stateWeight=t}getStateTime(){return this._stateTimeSeconds}getStateWeight(){return this._stateWeight}getLastCheckEventSeconds(){return this._lastEventCheckSeconds}setLastCheckEventSeconds(e){this._lastEventCheckSeconds=e}isTriggeredFadeOut(){return this._isTriggeredFadeOut}getFadeOutSeconds(){return this._fadeOutSeconds}getCubismMotion(){return this._motion}}var ci;(a=>{a.CubismMotionQueueEntry=ds})(ci||(ci={}));class Ft{constructor(){this._userTimeSeconds=0,this._eventCallBack=null,this._eventCustomData=null,this._motions=new C}release(){for(let e=0;e<this._motions.getSize();++e)this._motions.at(e)&&(this._motions.at(e).release(),this._motions.set(e,null));this._motions=null}startMotion(e,t,i){if(e==null)return Oe;let s=null;for(let r=0;r<this._motions.getSize();++r)s=this._motions.at(r),s?.setFadeOut(s._motion.getFadeOutTime());return s=new ds,s._autoDelete=t,s._motion=e,this._motions.pushBack(s),s._motionQueueEntryHandle}isFinished(){for(let e=this._motions.begin();e.notEqual(this._motions.end());){let t=e.ptr();if(t==null){e=this._motions.erase(e);continue}if(t._motion==null){t.release(),t=null,e=this._motions.erase(e);continue}if(t.isFinished())e.preIncrement();else return!1}return!0}isFinishedByHandle(e){for(let t=this._motions.begin();t.notEqual(this._motions.end());t.increment()){const i=t.ptr();if(i!=null&&i._motionQueueEntryHandle==e&&!i.isFinished())return!1}return!0}stopAllMotions(){for(let e=this._motions.begin();e.notEqual(this._motions.end());){let t=e.ptr();if(t==null){e=this._motions.erase(e);continue}t.release(),t=null,e=this._motions.erase(e)}}getCubismMotionQueueEntries(){return this._motions}getCubismMotionQueueEntry(e){for(let t=this._motions.begin();t.notEqual(this._motions.end());t.preIncrement()){const i=t.ptr();if(i!=null&&i._motionQueueEntryHandle==e)return i}return null}setEventCallback(e,t=null){this._eventCallBack=e,this._eventCustomData=t}doUpdateMotion(e,t){let i=!1;for(let s=this._motions.begin();s.notEqual(this._motions.end());){let r=s.ptr();if(r==null){s=this._motions.erase(s);continue}const n=r._motion;if(n==null){r.release(),r=null,s=this._motions.erase(s);continue}n.updateParameters(e,r,t),i=!0;const o=n.getFiredEvent(r.getLastCheckEventSeconds()-r.getStartTime(),t-r.getStartTime());for(let l=0;l<o.getSize();++l)this._eventCallBack(this,o.at(l),this._eventCustomData);r.setLastCheckEventSeconds(t),r.isFinished()?(r.release(),r=null,s=this._motions.erase(s)):(r.isTriggeredFadeOut()&&r.startFadeOut(r.getFadeOutSeconds(),t),s.preIncrement())}return i}}const Oe=-1;var di;(a=>{a.CubismMotionQueueManager=Ft,a.InvalidMotionQueueEntryHandleValue=Oe})(di||(di={}));class br{}class _s extends Ft{constructor(){super(),this._currentPriority=0,this._reservePriority=0,this._expressionParameterValues=new C,this._fadeWeights=new C}release(){this._expressionParameterValues&&(Se(this._expressionParameterValues),this._expressionParameterValues=null),this._fadeWeights&&(Se(this._fadeWeights),this._fadeWeights=null)}getCurrentPriority(){return z("CubismExpressionMotionManager.getCurrentPriority() is deprecated because a priority value is not actually used during expression motion playback."),this._currentPriority}getReservePriority(){return z("CubismExpressionMotionManager.getReservePriority() is deprecated because a priority value is not actually used during expression motion playback."),this._reservePriority}getFadeWeight(e){return e<0||this._fadeWeights.getSize()<1||e>=this._fadeWeights.getSize()?(console.warn("Failed to get the fade weight value. The element at that index does not exist."),-1):this._fadeWeights.at(e)}setFadeWeight(e,t){if(e<0||this._fadeWeights.getSize()<1||this._fadeWeights.getSize()<=e){console.warn("Failed to set the fade weight value. The element at that index does not exist.");return}this._fadeWeights.set(e,t)}setReservePriority(e){z("CubismExpressionMotionManager.setReservePriority() is deprecated because a priority value is not actually used during expression motion playback."),this._reservePriority=e}startMotionPriority(e,t,i){return z("CubismExpressionMotionManager.startMotionPriority() is deprecated because a priority value is not actually used during expression motion playback."),i==this.getReservePriority()&&this.setReservePriority(0),this._currentPriority=i,this.startMotion(e,t)}updateMotion(e,t){this._userTimeSeconds+=t;let i=!1;const s=this.getCubismMotionQueueEntries();let r=0,n=0;if(this._fadeWeights.getSize()!==s.getSize()){const o=s.getSize()-this._fadeWeights.getSize();for(let l=0;l<o;l++)this._fadeWeights.pushBack(0)}for(let o=this._motions.begin();o.notEqual(this._motions.end());){const l=o.ptr();if(l==null){o=s.erase(o);continue}const h=l.getCubismMotion();if(h==null){Se(l),o=s.erase(o);continue}const u=h.getExpressionParameters();if(l.isAvailable())for(let d=0;d<u.getSize();++d){if(u.at(d).parameterId==null)continue;let _=-1;for(let c=0;c<this._expressionParameterValues.getSize();++c)if(this._expressionParameterValues.at(c).parameterId==u.at(d).parameterId){_=c;break}if(_>=0)continue;const g=new br;g.parameterId=u.at(d).parameterId,g.additiveValue=re.DefaultAdditiveValue,g.multiplyValue=re.DefaultMultiplyValue,g.overwriteValue=e.getParameterValueById(g.parameterId),this._expressionParameterValues.pushBack(g)}h.setupMotionQueueEntry(l,this._userTimeSeconds),this.setFadeWeight(n,h.updateFadeWeight(l,this._userTimeSeconds)),h.calculateExpressionParameters(e,this._userTimeSeconds,l,this._expressionParameterValues,n,this.getFadeWeight(n)),r+=h.getFadeInTime()==0?1:S.getEasingSine((this._userTimeSeconds-l.getFadeInStartTime())/h.getFadeInTime()),i=!0,l.isTriggeredFadeOut()&&l.startFadeOut(l.getFadeOutSeconds(),this._userTimeSeconds),o.preIncrement(),++n}if(s.getSize()>1&&this.getFadeWeight(this._fadeWeights.getSize()-1)>=1)for(let l=s.getSize()-2;l>=0;--l){const h=s.at(l);Se(h),s.remove(l),this._fadeWeights.remove(l)}r>1&&(r=1);for(let o=0;o<this._expressionParameterValues.getSize();++o){const l=this._expressionParameterValues.at(o);e.setParameterValueById(l.parameterId,(l.overwriteValue+l.additiveValue)*l.multiplyValue,r),l.additiveValue=re.DefaultAdditiveValue,l.multiplyValue=re.DefaultMultiplyValue}return i}}var _i;(a=>{a.CubismExpressionMotionManager=_s})(_i||(_i={}));var J=(a=>(a[a.CubismMotionCurveTarget_Model=0]="CubismMotionCurveTarget_Model",a[a.CubismMotionCurveTarget_Parameter=1]="CubismMotionCurveTarget_Parameter",a[a.CubismMotionCurveTarget_PartOpacity=2]="CubismMotionCurveTarget_PartOpacity",a))(J||{}),k=(a=>(a[a.CubismMotionSegmentType_Linear=0]="CubismMotionSegmentType_Linear",a[a.CubismMotionSegmentType_Bezier=1]="CubismMotionSegmentType_Bezier",a[a.CubismMotionSegmentType_Stepped=2]="CubismMotionSegmentType_Stepped",a[a.CubismMotionSegmentType_InverseStepped=3]="CubismMotionSegmentType_InverseStepped",a))(k||{});class Xe{constructor(){this.time=0,this.value=0}}class fs{constructor(){this.evaluate=null,this.basePointIndex=0,this.segmentType=0}}class ps{constructor(){this.type=0,this.segmentCount=0,this.baseSegmentIndex=0,this.fadeInTime=0,this.fadeOutTime=0}}class ms{constructor(){this.fireTime=0}}class Cs{constructor(){this.duration=0,this.loop=!1,this.curveCount=0,this.eventCount=0,this.fps=0,this.curves=new C,this.segments=new C,this.points=new C,this.events=new C}}var fi;(a=>{a.CubismMotionCurve=ps,a.CubismMotionCurveTarget=J,a.CubismMotionData=Cs,a.CubismMotionEvent=ms,a.CubismMotionPoint=Xe,a.CubismMotionSegment=fs,a.CubismMotionSegmentType=k})(fi||(fi={}));const Y="Meta",Mr="Duration",xr="Loop",Br="AreBeziersRestricted",Pr="CurveCount",vr="Fps",wr="TotalSegmentCount",Fr="TotalPointCount",te="Curves",Tr="Target",Rr="Id",Je="FadeInTime",Ke="FadeOutTime",pi="Segments",mi="UserData",Ir="UserDataCount",Vr="TotalUserDataSize",Or="Time",Er="Value";class ys{constructor(e,t){this._json=U.create(e,t)}release(){U.delete(this._json)}getMotionDuration(){return this._json.getRoot().getValueByString(Y).getValueByString(Mr).toFloat()}isMotionLoop(){return this._json.getRoot().getValueByString(Y).getValueByString(xr).toBoolean()}hasConsistency(){let e=!0;if(!this._json||!this._json.getRoot())return!1;const t=this._json.getRoot().getValueByString(te).getVector().getSize();let i=0,s=0;for(let r=0;r<t;++r)for(let n=0;n<this.getMotionCurveSegmentCount(r);){switch(n==0&&(s+=1,n+=2),this.getMotionCurveSegment(r,n)){case k.CubismMotionSegmentType_Linear:s+=1,n+=3;break;case k.CubismMotionSegmentType_Bezier:s+=3,n+=7;break;case k.CubismMotionSegmentType_Stepped:s+=1,n+=3;break;case k.CubismMotionSegmentType_InverseStepped:s+=1,n+=3;break;default:G(0);break}++i}return t!=this.getMotionCurveCount()&&(F("The number of curves does not match the metadata."),e=!1),i!=this.getMotionTotalSegmentCount()&&(F("The number of segment does not match the metadata."),e=!1),s!=this.getMotionTotalPointCount()&&(F("The number of point does not match the metadata."),e=!1),e}getEvaluationOptionFlag(e){return e==0?this._json.getRoot().getValueByString(Y).getValueByString(Br).toBoolean():!1}getMotionCurveCount(){return this._json.getRoot().getValueByString(Y).getValueByString(Pr).toInt()}getMotionFps(){return this._json.getRoot().getValueByString(Y).getValueByString(vr).toFloat()}getMotionTotalSegmentCount(){return this._json.getRoot().getValueByString(Y).getValueByString(wr).toInt()}getMotionTotalPointCount(){return this._json.getRoot().getValueByString(Y).getValueByString(Fr).toInt()}isExistMotionFadeInTime(){return!this._json.getRoot().getValueByString(Y).getValueByString(Je).isNull()}isExistMotionFadeOutTime(){return!this._json.getRoot().getValueByString(Y).getValueByString(Ke).isNull()}getMotionFadeInTime(){return this._json.getRoot().getValueByString(Y).getValueByString(Je).toFloat()}getMotionFadeOutTime(){return this._json.getRoot().getValueByString(Y).getValueByString(Ke).toFloat()}getMotionCurveTarget(e){return this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(Tr).getRawString()}getMotionCurveId(e){return T.getIdManager().getId(this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(Rr).getRawString())}isExistMotionCurveFadeInTime(e){return!this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(Je).isNull()}isExistMotionCurveFadeOutTime(e){return!this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(Ke).isNull()}getMotionCurveFadeInTime(e){return this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(Je).toFloat()}getMotionCurveFadeOutTime(e){return this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(Ke).toFloat()}getMotionCurveSegmentCount(e){return this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(pi).getVector().getSize()}getMotionCurveSegment(e,t){return this._json.getRoot().getValueByString(te).getValueByIndex(e).getValueByString(pi).getValueByIndex(t).toFloat()}getEventCount(){return this._json.getRoot().getValueByString(Y).getValueByString(Ir).toInt()}getTotalEventValueSize(){return this._json.getRoot().getValueByString(Y).getValueByString(Vr).toInt()}getEventTime(e){return this._json.getRoot().getValueByString(mi).getValueByIndex(e).getValueByString(Or).toFloat()}getEventValue(e){return new $(this._json.getRoot().getValueByString(mi).getValueByIndex(e).getValueByString(Er).getRawString())}}var Ss=(a=>(a[a.EvaluationOptionFlag_AreBeziersRistricted=0]="EvaluationOptionFlag_AreBeziersRistricted",a))(Ss||{}),Ci;(a=>{a.CubismMotionJson=ys})(Ci||(Ci={}));const Dr="EyeBlink",Lr="LipSync",Ar="Model",kr="Parameter",Nr="PartOpacity",Ze="Opacity",Ur=!1;function W(a,e,t){const i=new Xe;return i.time=a.time+(e.time-a.time)*t,i.value=a.value+(e.value-a.value)*t,i}function bs(a,e){let t=(e-a[0].time)/(a[1].time-a[0].time);return t<0&&(t=0),a[0].value+(a[1].value-a[0].value)*t}function zr(a,e){let t=(e-a[0].time)/(a[3].time-a[0].time);t<0&&(t=0);const i=W(a[0],a[1],t),s=W(a[1],a[2],t),r=W(a[2],a[3],t),n=W(i,s,t),o=W(s,r,t);return W(n,o,t).value}function Xr(a,e){const t=e,i=a[0].time,s=a[3].time,r=a[1].time,n=a[2].time,o=s-3*n+3*r-i,l=3*n-6*r+3*i,h=3*r-3*i,u=i-t,d=S.cardanoAlgorithmForBezier(o,l,h,u),_=W(a[0],a[1],d),g=W(a[1],a[2],d),c=W(a[2],a[3],d),p=W(_,g,d),f=W(g,c,d);return W(p,f,d).value}function Ms(a,e){return a[0].value}function xs(a,e){return a[1].value}function ft(a,e,t,i,s){const r=a.curves.at(e);let n=-1;const o=r.baseSegmentIndex+r.segmentCount;let l=0;for(let u=r.baseSegmentIndex;u<o;++u)if(l=a.segments.at(u).basePointIndex+(a.segments.at(u).segmentType==k.CubismMotionSegmentType_Bezier?3:1),a.points.at(l).time>t){n=u;break}if(n==-1)return i&&t<s?Gr(a,o-1,a.segments.at(r.baseSegmentIndex).basePointIndex,l,t,s):a.points.at(l).value;const h=a.segments.at(n);return h.evaluate(a.points.get(h.basePointIndex),t)}function Gr(a,e,t,i,s,r){const n=[new Xe,new Xe];{const o=a.points.at(i);n[0].time=o.time,n[0].value=o.value}{const o=a.points.at(t);n[1].time=r,n[1].value=o.value}switch(a.segments.at(e).segmentType){case k.CubismMotionSegmentType_Linear:case k.CubismMotionSegmentType_Bezier:default:return bs(n,s);case k.CubismMotionSegmentType_Stepped:return Ms(n);case k.CubismMotionSegmentType_InverseStepped:return xs(n)}}class gt extends Fe{constructor(){super(),this._motionBehavior=1,this._sourceFrameRate=30,this._loopDurationSeconds=-1,this._isLoop=!1,this._isLoopFadeIn=!0,this._lastWeight=0,this._motionData=null,this._modelCurveIdEyeBlink=null,this._modelCurveIdLipSync=null,this._modelCurveIdOpacity=null,this._eyeBlinkParameterIds=null,this._lipSyncParameterIds=null,this._modelOpacity=1,this._debugMode=!1}static create(e,t,i,s,r=!1){const n=new gt;if(n.parse(e,t,r),n._motionData)n._sourceFrameRate=n._motionData.fps,n._loopDurationSeconds=n._motionData.duration,n._onFinishedMotion=i,n._onBeganMotion=s;else return Se(n),null;return n}doUpdateParameters(e,t,i,s){this._modelCurveIdEyeBlink==null&&(this._modelCurveIdEyeBlink=T.getIdManager().getId(Dr)),this._modelCurveIdLipSync==null&&(this._modelCurveIdLipSync=T.getIdManager().getId(Lr)),this._modelCurveIdOpacity==null&&(this._modelCurveIdOpacity=T.getIdManager().getId(Ze)),this._motionBehavior===1&&this._previousLoopState!==this._isLoop&&(this.adjustEndTime(s),this._previousLoopState=this._isLoop);let r=t-s.getStartTime();r<0&&(r=0);let n=Number.MAX_VALUE,o=Number.MAX_VALUE;const l=64;let h=0,u=0;this._eyeBlinkParameterIds.getSize()>l&&Ae("too many eye blink targets : {0}",this._eyeBlinkParameterIds.getSize()),this._lipSyncParameterIds.getSize()>l&&Ae("too many lip sync targets : {0}",this._lipSyncParameterIds.getSize());const d=this._fadeInSeconds<=0?1:S.getEasingSine((t-s.getFadeInStartTime())/this._fadeInSeconds),_=this._fadeOutSeconds<=0||s.getEndTime()<0?1:S.getEasingSine((s.getEndTime()-t)/this._fadeOutSeconds);let g,c,p,f=r,x=this._motionData.duration;const P=this._motionBehavior===1&&this._isLoop;if(this._isLoop)for(this._motionBehavior===1&&(x+=1/this._motionData.fps);f>x;)f-=x;const m=this._motionData.curves;for(c=0;c<this._motionData.curveCount&&m.at(c).type==J.CubismMotionCurveTarget_Model;++c)g=ft(this._motionData,c,f,P,x),m.at(c).id==this._modelCurveIdEyeBlink?o=g:m.at(c).id==this._modelCurveIdLipSync?n=g:m.at(c).id==this._modelCurveIdOpacity&&(this._modelOpacity=g,e.setModelOapcity(this.getModelOpacityValue()));for(;c<this._motionData.curveCount&&m.at(c).type==J.CubismMotionCurveTarget_Parameter;++c){if(p=e.getParameterIndex(m.at(c).id),p==-1)continue;const y=e.getParameterValueByIndex(p);if(g=ft(this._motionData,c,f,P,x),o!=Number.MAX_VALUE){for(let B=0;B<this._eyeBlinkParameterIds.getSize()&&B<l;++B)if(this._eyeBlinkParameterIds.at(B)==m.at(c).id){g*=o,u|=1<<B;break}}if(n!=Number.MAX_VALUE){for(let B=0;B<this._lipSyncParameterIds.getSize()&&B<l;++B)if(this._lipSyncParameterIds.at(B)==m.at(c).id){g+=n,h|=1<<B;break}}e.isRepeat(p)&&(g=e.getParameterRepeatValue(p,g));let v;if(m.at(c).fadeInTime<0&&m.at(c).fadeOutTime<0)v=y+(g-y)*i;else{let B,I;m.at(c).fadeInTime<0?B=d:B=m.at(c).fadeInTime==0?1:S.getEasingSine((t-s.getFadeInStartTime())/m.at(c).fadeInTime),m.at(c).fadeOutTime<0?I=_:I=m.at(c).fadeOutTime==0||s.getEndTime()<0?1:S.getEasingSine((s.getEndTime()-t)/m.at(c).fadeOutTime);const O=this._weight*B*I;v=y+(g-y)*O}e.setParameterValueByIndex(p,v,1)}{if(o!=Number.MAX_VALUE)for(let y=0;y<this._eyeBlinkParameterIds.getSize()&&y<l;++y){const v=e.getParameterValueById(this._eyeBlinkParameterIds.at(y));if(u>>y&1)continue;const B=v+(o-v)*i;e.setParameterValueById(this._eyeBlinkParameterIds.at(y),B)}if(n!=Number.MAX_VALUE)for(let y=0;y<this._lipSyncParameterIds.getSize()&&y<l;++y){const v=e.getParameterValueById(this._lipSyncParameterIds.at(y));if(h>>y&1)continue;const B=v+(n-v)*i;e.setParameterValueById(this._lipSyncParameterIds.at(y),B)}}for(;c<this._motionData.curveCount&&m.at(c).type==J.CubismMotionCurveTarget_PartOpacity;++c)p=e.getParameterIndex(m.at(c).id),p!=-1&&(g=ft(this._motionData,c,f,P,x),e.setParameterValueByIndex(p,g));r>=x&&(this._isLoop?this.updateForNextLoop(s,t,f):(this._onFinishedMotion&&this._onFinishedMotion(this),s.setIsFinished(!0))),this._lastWeight=i}setIsLoop(e){F("setIsLoop() is a deprecated function. Please use setLoop()."),this._isLoop=e}isLoop(){return F("isLoop() is a deprecated function. Please use getLoop()."),this._isLoop}setIsLoopFadeIn(e){F("setIsLoopFadeIn() is a deprecated function. Please use setLoopFadeIn()."),this._isLoopFadeIn=e}isLoopFadeIn(){return F("isLoopFadeIn() is a deprecated function. Please use getLoopFadeIn()."),this._isLoopFadeIn}setMotionBehavior(e){this._motionBehavior=e}getMotionBehavior(){return this._motionBehavior}getDuration(){return this._isLoop?-1:this._loopDurationSeconds}getLoopDuration(){return this._loopDurationSeconds}setParameterFadeInTime(e,t){const i=this._motionData.curves;for(let s=0;s<this._motionData.curveCount;++s)if(e==i.at(s).id){i.at(s).fadeInTime=t;return}}setParameterFadeOutTime(e,t){const i=this._motionData.curves;for(let s=0;s<this._motionData.curveCount;++s)if(e==i.at(s).id){i.at(s).fadeOutTime=t;return}}getParameterFadeInTime(e){const t=this._motionData.curves;for(let i=0;i<this._motionData.curveCount;++i)if(e==t.at(i).id)return t.at(i).fadeInTime;return-1}getParameterFadeOutTime(e){const t=this._motionData.curves;for(let i=0;i<this._motionData.curveCount;++i)if(e==t.at(i).id)return t.at(i).fadeOutTime;return-1}setEffectIds(e,t){this._eyeBlinkParameterIds=e,this._lipSyncParameterIds=t}release(){this._motionData=void 0,this._motionData=null}updateForNextLoop(e,t,i){switch(this._motionBehavior){case 1:default:e.setStartTime(t-i),this._isLoopFadeIn&&e.setFadeInStartTime(t-i),this._onFinishedMotion!=null&&this._onFinishedMotion(this);break;case 0:e.setStartTime(t),this._isLoopFadeIn&&e.setFadeInStartTime(t);break}}parse(e,t,i=!1){let s=new ys(e,t);if(!s){s.release(),s=void 0;return}if(i&&!s.hasConsistency()){s.release(),w("Inconsistent motion3.json.");return}this._motionData=new Cs,this._motionData.duration=s.getMotionDuration(),this._motionData.loop=s.isMotionLoop(),this._motionData.curveCount=s.getMotionCurveCount(),this._motionData.fps=s.getMotionFps(),this._motionData.eventCount=s.getEventCount();const r=s.getEvaluationOptionFlag(Ss.EvaluationOptionFlag_AreBeziersRistricted);s.isExistMotionFadeInTime()?this._fadeInSeconds=s.getMotionFadeInTime()<0?1:s.getMotionFadeInTime():this._fadeInSeconds=1,s.isExistMotionFadeOutTime()?this._fadeOutSeconds=s.getMotionFadeOutTime()<0?1:s.getMotionFadeOutTime():this._fadeOutSeconds=1,this._motionData.curves.updateSize(this._motionData.curveCount,ps,!0),this._motionData.segments.updateSize(s.getMotionTotalSegmentCount(),fs,!0),this._motionData.points.updateSize(s.getMotionTotalPointCount(),Xe,!0),this._motionData.events.updateSize(this._motionData.eventCount,ms,!0);let n=0,o=0;for(let l=0;l<this._motionData.curveCount;++l){s.getMotionCurveTarget(l)==Ar?this._motionData.curves.at(l).type=J.CubismMotionCurveTarget_Model:s.getMotionCurveTarget(l)==kr?this._motionData.curves.at(l).type=J.CubismMotionCurveTarget_Parameter:s.getMotionCurveTarget(l)==Nr?this._motionData.curves.at(l).type=J.CubismMotionCurveTarget_PartOpacity:F('Warning : Unable to get segment type from Curve! The number of "CurveCount" may be incorrect!'),this._motionData.curves.at(l).id=s.getMotionCurveId(l),this._motionData.curves.at(l).baseSegmentIndex=o,this._motionData.curves.at(l).fadeInTime=s.isExistMotionCurveFadeInTime(l)?s.getMotionCurveFadeInTime(l):-1,this._motionData.curves.at(l).fadeOutTime=s.isExistMotionCurveFadeOutTime(l)?s.getMotionCurveFadeOutTime(l):-1;for(let h=0;h<s.getMotionCurveSegmentCount(l);){switch(h==0?(this._motionData.segments.at(o).basePointIndex=n,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,h),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,h+1),n+=1,h+=2):this._motionData.segments.at(o).basePointIndex=n-1,s.getMotionCurveSegment(l,h)){case k.CubismMotionSegmentType_Linear:{this._motionData.segments.at(o).segmentType=k.CubismMotionSegmentType_Linear,this._motionData.segments.at(o).evaluate=bs,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,h+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,h+2),n+=1,h+=3;break}case k.CubismMotionSegmentType_Bezier:{this._motionData.segments.at(o).segmentType=k.CubismMotionSegmentType_Bezier,r||Ur?this._motionData.segments.at(o).evaluate=zr:this._motionData.segments.at(o).evaluate=Xr,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,h+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,h+2),this._motionData.points.at(n+1).time=s.getMotionCurveSegment(l,h+3),this._motionData.points.at(n+1).value=s.getMotionCurveSegment(l,h+4),this._motionData.points.at(n+2).time=s.getMotionCurveSegment(l,h+5),this._motionData.points.at(n+2).value=s.getMotionCurveSegment(l,h+6),n+=3,h+=7;break}case k.CubismMotionSegmentType_Stepped:{this._motionData.segments.at(o).segmentType=k.CubismMotionSegmentType_Stepped,this._motionData.segments.at(o).evaluate=Ms,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,h+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,h+2),n+=1,h+=3;break}case k.CubismMotionSegmentType_InverseStepped:{this._motionData.segments.at(o).segmentType=k.CubismMotionSegmentType_InverseStepped,this._motionData.segments.at(o).evaluate=xs,this._motionData.points.at(n).time=s.getMotionCurveSegment(l,h+1),this._motionData.points.at(n).value=s.getMotionCurveSegment(l,h+2),n+=1,h+=3;break}default:{G(0);break}}++this._motionData.curves.at(l).segmentCount,++o}}for(let l=0;l<s.getEventCount();++l)this._motionData.events.at(l).fireTime=s.getEventTime(l),this._motionData.events.at(l).value=s.getEventValue(l);s.release(),s=void 0,s=null}getFiredEvent(e,t){this._firedEventValues.updateSize(0);for(let i=0;i<this._motionData.eventCount;++i)this._motionData.events.at(i).fireTime>e&&this._motionData.events.at(i).fireTime<=t&&this._firedEventValues.pushBack(new $(this._motionData.events.at(i).value.s));return this._firedEventValues}isExistModelOpacity(){for(let e=0;e<this._motionData.curveCount;e++){const t=this._motionData.curves.at(e);if(t.type==J.CubismMotionCurveTarget_Model&&t.id.getString().s.localeCompare(Ze)==0)return!0}return!1}getModelOpacityIndex(){if(this.isExistModelOpacity())for(let e=0;e<this._motionData.curveCount;e++){const t=this._motionData.curves.at(e);if(t.type==J.CubismMotionCurveTarget_Model&&t.id.getString().s.localeCompare(Ze)==0)return e}return-1}getModelOpacityId(e){if(e!=-1){const t=this._motionData.curves.at(e);if(t.type==J.CubismMotionCurveTarget_Model&&t.id.getString().s.localeCompare(Ze)==0)return T.getIdManager().getId(t.id.getString().s)}return null}getModelOpacityValue(){return this._modelOpacity}setDebugMode(e){this._debugMode=e}}var yi;(a=>{a.CubismMotion=gt})(yi||(yi={}));class Bs extends Ft{constructor(){super(),this._currentPriority=0,this._reservePriority=0}getCurrentPriority(){return this._currentPriority}getReservePriority(){return this._reservePriority}setReservePriority(e){this._reservePriority=e}startMotionPriority(e,t,i){return i==this._reservePriority&&(this._reservePriority=0),this._currentPriority=i,super.startMotion(e,t)}updateMotion(e,t){this._userTimeSeconds+=t;const i=super.doUpdateMotion(e,this._userTimeSeconds);return this.isFinished()&&(this._currentPriority=0),i}reserveMotion(e){return e<=this._reservePriority||e<=this._currentPriority?!1:(this._reservePriority=e,!0)}}var Si;(a=>{a.CubismMotionManager=Bs})(Si||(Si={}));var ht=(a=>(a[a.CubismPhysicsTargetType_Parameter=0]="CubismPhysicsTargetType_Parameter",a))(ht||{}),se=(a=>(a[a.CubismPhysicsSource_X=0]="CubismPhysicsSource_X",a[a.CubismPhysicsSource_Y=1]="CubismPhysicsSource_Y",a[a.CubismPhysicsSource_Angle=2]="CubismPhysicsSource_Angle",a))(se||{});class jr{constructor(){this.gravity=new M(0,0),this.wind=new M(0,0)}}class Tt{}class Bt{}class Ps{constructor(){this.initialPosition=new M(0,0),this.position=new M(0,0),this.lastPosition=new M(0,0),this.lastGravity=new M(0,0),this.force=new M(0,0),this.velocity=new M(0,0)}}class vs{constructor(){this.normalizationPosition=new Bt,this.normalizationAngle=new Bt}}class ws{constructor(){this.source=new Tt}}class Fs{constructor(){this.destination=new Tt,this.translationScale=new M(0,0)}}class Ts{constructor(){this.settings=new C,this.inputs=new C,this.outputs=new C,this.particles=new C,this.gravity=new M(0,0),this.wind=new M(0,0),this.fps=0}}var bi;(a=>{a.CubismPhysicsInput=ws,a.CubismPhysicsNormalization=Bt,a.CubismPhysicsOutput=Fs,a.CubismPhysicsParameter=Tt,a.CubismPhysicsParticle=Ps,a.CubismPhysicsRig=Ts,a.CubismPhysicsSource=se,a.CubismPhysicsSubRig=vs,a.CubismPhysicsTargetType=ht,a.PhysicsJsonEffectiveForces=jr})(bi||(bi={}));const Ie="Position",pt="X",mt="Y",Ct="Angle",Mi="Type",xi="Id",ie="Meta",Qe="EffectiveForces",Yr="TotalInputCount",Hr="TotalOutputCount",Wr="PhysicsSettingCount",Bi="Gravity",Pi="Wind",$r="VertexCount",qr="Fps",R="PhysicsSettings",pe="Normalization",vi="Minimum",wi="Maximum",Fi="Default",Ti="Reflect",Ri="Weight",Ve="Input",Jr="Source",oe="Output",Kr="Scale",Zr="VertexIndex",Qr="Destination",le="Vertices",ea="Mobility",ta="Delay",ia="Radius",sa="Acceleration";class Rs{constructor(e,t){this._json=U.create(e,t)}release(){U.delete(this._json)}getGravity(){const e=new M(0,0);return e.x=this._json.getRoot().getValueByString(ie).getValueByString(Qe).getValueByString(Bi).getValueByString(pt).toFloat(),e.y=this._json.getRoot().getValueByString(ie).getValueByString(Qe).getValueByString(Bi).getValueByString(mt).toFloat(),e}getWind(){const e=new M(0,0);return e.x=this._json.getRoot().getValueByString(ie).getValueByString(Qe).getValueByString(Pi).getValueByString(pt).toFloat(),e.y=this._json.getRoot().getValueByString(ie).getValueByString(Qe).getValueByString(Pi).getValueByString(mt).toFloat(),e}getFps(){return this._json.getRoot().getValueByString(ie).getValueByString(qr).toFloat(0)}getSubRigCount(){return this._json.getRoot().getValueByString(ie).getValueByString(Wr).toInt()}getTotalInputCount(){return this._json.getRoot().getValueByString(ie).getValueByString(Yr).toInt()}getTotalOutputCount(){return this._json.getRoot().getValueByString(ie).getValueByString(Hr).toInt()}getVertexCount(){return this._json.getRoot().getValueByString(ie).getValueByString($r).toInt()}getNormalizationPositionMinimumValue(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(pe).getValueByString(Ie).getValueByString(vi).toFloat()}getNormalizationPositionMaximumValue(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(pe).getValueByString(Ie).getValueByString(wi).toFloat()}getNormalizationPositionDefaultValue(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(pe).getValueByString(Ie).getValueByString(Fi).toFloat()}getNormalizationAngleMinimumValue(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(pe).getValueByString(Ct).getValueByString(vi).toFloat()}getNormalizationAngleMaximumValue(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(pe).getValueByString(Ct).getValueByString(wi).toFloat()}getNormalizationAngleDefaultValue(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(pe).getValueByString(Ct).getValueByString(Fi).toFloat()}getInputCount(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(Ve).getVector().getSize()}getInputWeight(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(Ve).getValueByIndex(t).getValueByString(Ri).toFloat()}getInputReflect(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(Ve).getValueByIndex(t).getValueByString(Ti).toBoolean()}getInputType(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(Ve).getValueByIndex(t).getValueByString(Mi).getRawString()}getInputSourceId(e,t){return T.getIdManager().getId(this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(Ve).getValueByIndex(t).getValueByString(Jr).getValueByString(xi).getRawString())}getOutputCount(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getVector().getSize()}getOutputVertexIndex(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getValueByIndex(t).getValueByString(Zr).toInt()}getOutputAngleScale(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getValueByIndex(t).getValueByString(Kr).toFloat()}getOutputWeight(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getValueByIndex(t).getValueByString(Ri).toFloat()}getOutputDestinationId(e,t){return T.getIdManager().getId(this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getValueByIndex(t).getValueByString(Qr).getValueByString(xi).getRawString())}getOutputType(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getValueByIndex(t).getValueByString(Mi).getRawString()}getOutputReflect(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(oe).getValueByIndex(t).getValueByString(Ti).toBoolean()}getParticleCount(e){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getVector().getSize()}getParticleMobility(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getValueByIndex(t).getValueByString(ea).toFloat()}getParticleDelay(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getValueByIndex(t).getValueByString(ta).toFloat()}getParticleAcceleration(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getValueByIndex(t).getValueByString(sa).toFloat()}getParticleRadius(e,t){return this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getValueByIndex(t).getValueByString(ia).toFloat()}getParticlePosition(e,t){const i=new M(0,0);return i.x=this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getValueByIndex(t).getValueByString(Ie).getValueByString(pt).toFloat(),i.y=this._json.getRoot().getValueByString(R).getValueByIndex(e).getValueByString(le).getValueByIndex(t).getValueByString(Ie).getValueByString(mt).toFloat(),i}}var Ii;(a=>{a.CubismPhysicsJson=Rs})(Ii||(Ii={}));const Vi="X",Oi="Y",Ei="Angle",ra=5,Pt=100,Di=.001,aa=5;class Ge{static create(e,t){const i=new Ge;return i.parse(e,t),i._physicsRig.gravity.y=0,i}static delete(e){e!=null&&(e.release(),e=null)}parse(e,t){this._physicsRig=new Ts;let i=new Rs(e,t);this._physicsRig.gravity=i.getGravity(),this._physicsRig.wind=i.getWind(),this._physicsRig.subRigCount=i.getSubRigCount(),this._physicsRig.fps=i.getFps(),this._physicsRig.settings.updateSize(this._physicsRig.subRigCount,vs,!0),this._physicsRig.inputs.updateSize(i.getTotalInputCount(),ws,!0),this._physicsRig.outputs.updateSize(i.getTotalOutputCount(),Fs,!0),this._physicsRig.particles.updateSize(i.getVertexCount(),Ps,!0),this._currentRigOutputs.clear(),this._previousRigOutputs.clear();let s=0,r=0,n=0;for(let o=0;o<this._physicsRig.settings.getSize();++o){this._physicsRig.settings.at(o).normalizationPosition.minimum=i.getNormalizationPositionMinimumValue(o),this._physicsRig.settings.at(o).normalizationPosition.maximum=i.getNormalizationPositionMaximumValue(o),this._physicsRig.settings.at(o).normalizationPosition.defalut=i.getNormalizationPositionDefaultValue(o),this._physicsRig.settings.at(o).normalizationAngle.minimum=i.getNormalizationAngleMinimumValue(o),this._physicsRig.settings.at(o).normalizationAngle.maximum=i.getNormalizationAngleMaximumValue(o),this._physicsRig.settings.at(o).normalizationAngle.defalut=i.getNormalizationAngleDefaultValue(o),this._physicsRig.settings.at(o).inputCount=i.getInputCount(o),this._physicsRig.settings.at(o).baseInputIndex=s;for(let u=0;u<this._physicsRig.settings.at(o).inputCount;++u)this._physicsRig.inputs.at(s+u).sourceParameterIndex=-1,this._physicsRig.inputs.at(s+u).weight=i.getInputWeight(o,u),this._physicsRig.inputs.at(s+u).reflect=i.getInputReflect(o,u),i.getInputType(o,u)==Vi?(this._physicsRig.inputs.at(s+u).type=se.CubismPhysicsSource_X,this._physicsRig.inputs.at(s+u).getNormalizedParameterValue=oa):i.getInputType(o,u)==Oi?(this._physicsRig.inputs.at(s+u).type=se.CubismPhysicsSource_Y,this._physicsRig.inputs.at(s+u).getNormalizedParameterValue=la):i.getInputType(o,u)==Ei&&(this._physicsRig.inputs.at(s+u).type=se.CubismPhysicsSource_Angle,this._physicsRig.inputs.at(s+u).getNormalizedParameterValue=ha),this._physicsRig.inputs.at(s+u).source.targetType=ht.CubismPhysicsTargetType_Parameter,this._physicsRig.inputs.at(s+u).source.id=i.getInputSourceId(o,u);s+=this._physicsRig.settings.at(o).inputCount,this._physicsRig.settings.at(o).outputCount=i.getOutputCount(o),this._physicsRig.settings.at(o).baseOutputIndex=r;const l=new Li;l.outputs.resize(this._physicsRig.settings.at(o).outputCount);const h=new Li;h.outputs.resize(this._physicsRig.settings.at(o).outputCount);for(let u=0;u<this._physicsRig.settings.at(o).outputCount;++u)l.outputs.set(u,0),h.outputs.set(u,0),this._physicsRig.outputs.at(r+u).destinationParameterIndex=-1,this._physicsRig.outputs.at(r+u).vertexIndex=i.getOutputVertexIndex(o,u),this._physicsRig.outputs.at(r+u).angleScale=i.getOutputAngleScale(o,u),this._physicsRig.outputs.at(r+u).weight=i.getOutputWeight(o,u),this._physicsRig.outputs.at(r+u).destination.targetType=ht.CubismPhysicsTargetType_Parameter,this._physicsRig.outputs.at(r+u).destination.id=i.getOutputDestinationId(o,u),i.getOutputType(o,u)==Vi?(this._physicsRig.outputs.at(r+u).type=se.CubismPhysicsSource_X,this._physicsRig.outputs.at(r+u).getValue=ua,this._physicsRig.outputs.at(r+u).getScale=fa):i.getOutputType(o,u)==Oi?(this._physicsRig.outputs.at(r+u).type=se.CubismPhysicsSource_Y,this._physicsRig.outputs.at(r+u).getValue=ga,this._physicsRig.outputs.at(r+u).getScale=pa):i.getOutputType(o,u)==Ei&&(this._physicsRig.outputs.at(r+u).type=se.CubismPhysicsSource_Angle,this._physicsRig.outputs.at(r+u).getValue=ca,this._physicsRig.outputs.at(r+u).getScale=ma),this._physicsRig.outputs.at(r+u).reflect=i.getOutputReflect(o,u);this._currentRigOutputs.pushBack(l),this._previousRigOutputs.pushBack(h),r+=this._physicsRig.settings.at(o).outputCount,this._physicsRig.settings.at(o).particleCount=i.getParticleCount(o),this._physicsRig.settings.at(o).baseParticleIndex=n;for(let u=0;u<this._physicsRig.settings.at(o).particleCount;++u)this._physicsRig.particles.at(n+u).mobility=i.getParticleMobility(o,u),this._physicsRig.particles.at(n+u).delay=i.getParticleDelay(o,u),this._physicsRig.particles.at(n+u).acceleration=i.getParticleAcceleration(o,u),this._physicsRig.particles.at(n+u).radius=i.getParticleRadius(o,u),this._physicsRig.particles.at(n+u).position=i.getParticlePosition(o,u);n+=this._physicsRig.settings.at(o).particleCount}this.initialize(),i.release(),i=void 0,i=null}stabilization(e){let t,i,s,r;const n=new M;let o,l,h,u;const d=e.getModel().parameters.values,_=e.getModel().parameters.maximumValues,g=e.getModel().parameters.minimumValues,c=e.getModel().parameters.defaultValues;(this._parameterCaches?.length??0)<e.getParameterCount()&&(this._parameterCaches=new Float32Array(e.getParameterCount())),(this._parameterInputCaches?.length??0)<e.getParameterCount()&&(this._parameterInputCaches=new Float32Array(e.getParameterCount()));for(let p=0;p<e.getParameterCount();++p)this._parameterCaches[p]=d[p],this._parameterInputCaches[p]=d[p];for(let p=0;p<this._physicsRig.subRigCount;++p){t={angle:0},n.x=0,n.y=0,o=this._physicsRig.settings.at(p),l=this._physicsRig.inputs.get(o.baseInputIndex),h=this._physicsRig.outputs.get(o.baseOutputIndex),u=this._physicsRig.particles.get(o.baseParticleIndex);for(let f=0;f<o.inputCount;++f)i=l[f].weight/Pt,l[f].sourceParameterIndex==-1&&(l[f].sourceParameterIndex=e.getParameterIndex(l[f].source.id)),l[f].getNormalizedParameterValue(n,t,d[l[f].sourceParameterIndex],g[l[f].sourceParameterIndex],_[l[f].sourceParameterIndex],c[l[f].sourceParameterIndex],o.normalizationPosition,o.normalizationAngle,l[f].reflect,i),this._parameterCaches[l[f].sourceParameterIndex]=d[l[f].sourceParameterIndex];s=S.degreesToRadian(-t.angle),n.x=n.x*S.cos(s)-n.y*S.sin(s),n.y=n.x*S.sin(s)+n.y*S.cos(s),ya(u,o.particleCount,n,t.angle,this._options.wind,Di*o.normalizationPosition.maximum);for(let f=0;f<o.outputCount;++f){const x=h[f].vertexIndex;if(h[f].destinationParameterIndex==-1&&(h[f].destinationParameterIndex=e.getParameterIndex(h[f].destination.id)),x<1||x>=o.particleCount)continue;let P=new M;P=u[x].position.substract(u[x-1].position),r=h[f].getValue(P,u,x,h[f].reflect,this._options.gravity),this._currentRigOutputs.at(p).outputs.set(f,r),this._previousRigOutputs.at(p).outputs.set(f,r);const m=h[f].destinationParameterIndex,y=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(d.subarray(m))):d.slice(m);yt(y,g[m],_[m],r,h[f]);for(let v=m,B=0;v<this._parameterCaches.length;v++,B++)d[v]=this._parameterCaches[v]=y[B]}}}evaluate(e,t){let i,s,r,n;const o=new M;let l,h,u,d;if(0>=t)return;const _=e.getModel().parameters.values,g=e.getModel().parameters.maximumValues,c=e.getModel().parameters.minimumValues,p=e.getModel().parameters.defaultValues;let f;if(this._currentRemainTime+=t,this._currentRemainTime>aa&&(this._currentRemainTime=0),(this._parameterCaches?.length??0)<e.getParameterCount()&&(this._parameterCaches=new Float32Array(e.getParameterCount())),(this._parameterInputCaches?.length??0)<e.getParameterCount()){this._parameterInputCaches=new Float32Array(e.getParameterCount());for(let P=0;P<e.getParameterCount();++P)this._parameterInputCaches[P]=_[P]}for(this._physicsRig.fps>0?f=1/this._physicsRig.fps:f=t;this._currentRemainTime>=f;){for(let m=0;m<this._physicsRig.subRigCount;++m){l=this._physicsRig.settings.at(m),u=this._physicsRig.outputs.get(l.baseOutputIndex);for(let y=0;y<l.outputCount;++y)this._previousRigOutputs.at(m).outputs.set(y,this._currentRigOutputs.at(m).outputs.at(y))}const P=f/this._currentRemainTime;for(let m=0;m<e.getParameterCount();++m)this._parameterCaches[m]=this._parameterInputCaches[m]*(1-P)+_[m]*P,this._parameterInputCaches[m]=this._parameterCaches[m];for(let m=0;m<this._physicsRig.subRigCount;++m){i={angle:0},o.x=0,o.y=0,l=this._physicsRig.settings.at(m),h=this._physicsRig.inputs.get(l.baseInputIndex),u=this._physicsRig.outputs.get(l.baseOutputIndex),d=this._physicsRig.particles.get(l.baseParticleIndex);for(let y=0;y<l.inputCount;++y)s=h[y].weight/Pt,h[y].sourceParameterIndex==-1&&(h[y].sourceParameterIndex=e.getParameterIndex(h[y].source.id)),h[y].getNormalizedParameterValue(o,i,this._parameterCaches[h[y].sourceParameterIndex],c[h[y].sourceParameterIndex],g[h[y].sourceParameterIndex],p[h[y].sourceParameterIndex],l.normalizationPosition,l.normalizationAngle,h[y].reflect,s);r=S.degreesToRadian(-i.angle),o.x=o.x*S.cos(r)-o.y*S.sin(r),o.y=o.x*S.sin(r)+o.y*S.cos(r),Ca(d,l.particleCount,o,i.angle,this._options.wind,Di*l.normalizationPosition.maximum,f,ra);for(let y=0;y<l.outputCount;++y){const v=u[y].vertexIndex;if(u[y].destinationParameterIndex==-1&&(u[y].destinationParameterIndex=e.getParameterIndex(u[y].destination.id)),v<1||v>=l.particleCount)continue;const B=new M;B.x=d[v].position.x-d[v-1].position.x,B.y=d[v].position.y-d[v-1].position.y,n=u[y].getValue(B,d,v,u[y].reflect,this._options.gravity),this._currentRigOutputs.at(m).outputs.set(y,n);const I=u[y].destinationParameterIndex,O=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(this._parameterCaches.subarray(I))):this._parameterCaches.slice(I);yt(O,c[I],g[I],n,u[y]);for(let ce=I,de=0;ce<this._parameterCaches.length;ce++,de++)this._parameterCaches[ce]=O[de]}}this._currentRemainTime-=f}const x=this._currentRemainTime/f;this.interpolate(e,x)}interpolate(e,t){let i,s;const r=e.getModel().parameters.values,n=e.getModel().parameters.maximumValues,o=e.getModel().parameters.minimumValues;for(let l=0;l<this._physicsRig.subRigCount;++l){s=this._physicsRig.settings.at(l),i=this._physicsRig.outputs.get(s.baseOutputIndex);for(let h=0;h<s.outputCount;++h){if(i[h].destinationParameterIndex==-1)continue;const u=i[h].destinationParameterIndex,d=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(r.subarray(u))):r.slice(u);yt(d,o[u],n[u],this._previousRigOutputs.at(l).outputs.at(h)*(1-t)+this._currentRigOutputs.at(l).outputs.at(h)*t,i[h]);for(let _=u,g=0;_<r.length;_++,g++)r[_]=d[g]}}}setOptions(e){this._options=e}getOption(){return this._options}constructor(){this._physicsRig=null,this._options=new Is,this._options.gravity.y=-1,this._options.gravity.x=0,this._options.wind.x=0,this._options.wind.y=0,this._currentRigOutputs=new C,this._previousRigOutputs=new C,this._currentRemainTime=0,this._parameterCaches=null,this._parameterInputCaches=null}release(){this._physicsRig=void 0,this._physicsRig=null}initialize(){let e,t,i;for(let s=0;s<this._physicsRig.subRigCount;++s){t=this._physicsRig.settings.at(s),e=this._physicsRig.particles.get(t.baseParticleIndex),e[0].initialPosition=new M(0,0),e[0].lastPosition=new M(e[0].initialPosition.x,e[0].initialPosition.y),e[0].lastGravity=new M(0,-1),e[0].lastGravity.y*=-1,e[0].velocity=new M(0,0),e[0].force=new M(0,0);for(let r=1;r<t.particleCount;++r)i=new M(0,0),i.y=e[r].radius,e[r].initialPosition=new M(e[r-1].initialPosition.x+i.x,e[r-1].initialPosition.y+i.y),e[r].position=new M(e[r].initialPosition.x,e[r].initialPosition.y),e[r].lastPosition=new M(e[r].initialPosition.x,e[r].initialPosition.y),e[r].lastGravity=new M(0,-1),e[r].lastGravity.y*=-1,e[r].velocity=new M(0,0),e[r].force=new M(0,0)}}}class Is{constructor(){this.gravity=new M(0,0),this.wind=new M(0,0)}}class Li{constructor(){this.outputs=new C(0)}}function na(a){let e=0;return a>0?e=1:a<0&&(e=-1),e}function oa(a,e,t,i,s,r,n,o,l,h){a.x+=Rt(t,i,s,r,n.minimum,n.maximum,n.defalut,l)*h}function la(a,e,t,i,s,r,n,o,l,h){a.y+=Rt(t,i,s,r,n.minimum,n.maximum,n.defalut,l)*h}function ha(a,e,t,i,s,r,n,o,l,h){e.angle+=Rt(t,i,s,r,o.minimum,o.maximum,o.defalut,l)*h}function ua(a,e,t,i,s){let r=a.x;return i&&(r*=-1),r}function ga(a,e,t,i,s){let r=a.y;return i&&(r*=-1),r}function ca(a,e,t,i,s){let r;return t>=2?s=e[t-1].position.substract(e[t-2].position):s=s.multiplyByScaler(-1),r=S.directionToRadian(s,a),i&&(r*=-1),r}function da(a,e){const t=S.max(a,e),i=S.min(a,e);return S.abs(t-i)}function _a(a,e){return S.min(a,e)+da(a,e)/2}function fa(a,e){return JSON.parse(JSON.stringify(a.x))}function pa(a,e){return JSON.parse(JSON.stringify(a.y))}function ma(a,e){return JSON.parse(JSON.stringify(e))}function Ca(a,e,t,i,s,r,n,o){let l,h,u=new M(0,0),d=new M(0,0),_=new M(0,0),g=new M(0,0);a[0].position=new M(t.x,t.y);const c=S.degreesToRadian(i),p=S.radianToDirection(c);p.normalize();for(let f=1;f<e;++f)a[f].force=p.multiplyByScaler(a[f].acceleration).add(s),a[f].lastPosition=new M(a[f].position.x,a[f].position.y),l=a[f].delay*n*30,u=a[f].position.substract(a[f-1].position),h=S.directionToRadian(a[f].lastGravity,p)/o,u.x=S.cos(h)*u.x-u.y*S.sin(h),u.y=S.sin(h)*u.x+u.y*S.cos(h),a[f].position=a[f-1].position.add(u),d=a[f].velocity.multiplyByScaler(l),_=a[f].force.multiplyByScaler(l).multiplyByScaler(l),a[f].position=a[f].position.add(d).add(_),g=a[f].position.substract(a[f-1].position),g.normalize(),a[f].position=a[f-1].position.add(g.multiplyByScaler(a[f].radius)),S.abs(a[f].position.x)<r&&(a[f].position.x=0),l!=0&&(a[f].velocity=a[f].position.substract(a[f].lastPosition),a[f].velocity=a[f].velocity.divisionByScalar(l),a[f].velocity=a[f].velocity.multiplyByScaler(a[f].mobility)),a[f].force=new M(0,0),a[f].lastGravity=new M(p.x,p.y)}function ya(a,e,t,i,s,r){let n=new M(0,0);a[0].position=new M(t.x,t.y);const o=S.degreesToRadian(i),l=S.radianToDirection(o);l.normalize();for(let h=1;h<e;++h)a[h].force=l.multiplyByScaler(a[h].acceleration).add(s),a[h].lastPosition=new M(a[h].position.x,a[h].position.y),a[h].velocity=new M(0,0),n=a[h].force,n.normalize(),n=n.multiplyByScaler(a[h].radius),a[h].position=a[h-1].position.add(n),S.abs(a[h].position.x)<r&&(a[h].position.x=0),a[h].force=new M(0,0),a[h].lastGravity=new M(l.x,l.y)}function yt(a,e,t,i,s){let r;const n=s.getScale(s.translationScale,s.angleScale);r=i*n,r<e?(r<s.valueBelowMinimum&&(s.valueBelowMinimum=r),r=e):r>t&&(r>s.valueExceededMaximum&&(s.valueExceededMaximum=r),r=t);const o=s.weight/Pt;o>=1||(r=a[0]*(1-o)+r*o),a[0]=r}function Rt(a,e,t,i,s,r,n,o){let l=0;const h=S.max(t,e);h<a&&(a=h);const u=S.min(t,e);u>a&&(a=u);const d=S.min(s,r),_=S.max(s,r),g=n,c=_a(u,h),p=a-c;switch(na(p)){case 1:{const f=_-g,x=h-c;x!=0&&(l=p*(f/x),l+=g);break}case-1:{const f=d-g,x=u-c;x!=0&&(l=p*(f/x),l+=g);break}case 0:{l=g;break}}return o?l:l*-1}var Ai;(a=>{a.CubismPhysics=Ge,a.Options=Is})(Ai||(Ai={}));const be=-1,ki=-1;var L=(a=>(a[a.ColorBlend_None=-1]="ColorBlend_None",a[a.ColorBlend_Normal=Live2DCubismCore.ColorBlendType_Normal]="ColorBlend_Normal",a[a.ColorBlend_AddGlow=Live2DCubismCore.ColorBlendType_AddGlow]="ColorBlend_AddGlow",a[a.ColorBlend_Add=Live2DCubismCore.ColorBlendType_Add]="ColorBlend_Add",a[a.ColorBlend_Darken=Live2DCubismCore.ColorBlendType_Darken]="ColorBlend_Darken",a[a.ColorBlend_Multiply=Live2DCubismCore.ColorBlendType_Multiply]="ColorBlend_Multiply",a[a.ColorBlend_ColorBurn=Live2DCubismCore.ColorBlendType_ColorBurn]="ColorBlend_ColorBurn",a[a.ColorBlend_LinearBurn=Live2DCubismCore.ColorBlendType_LinearBurn]="ColorBlend_LinearBurn",a[a.ColorBlend_Lighten=Live2DCubismCore.ColorBlendType_Lighten]="ColorBlend_Lighten",a[a.ColorBlend_Screen=Live2DCubismCore.ColorBlendType_Screen]="ColorBlend_Screen",a[a.ColorBlend_ColorDodge=Live2DCubismCore.ColorBlendType_ColorDodge]="ColorBlend_ColorDodge",a[a.ColorBlend_Overlay=Live2DCubismCore.ColorBlendType_Overlay]="ColorBlend_Overlay",a[a.ColorBlend_SoftLight=Live2DCubismCore.ColorBlendType_SoftLight]="ColorBlend_SoftLight",a[a.ColorBlend_HardLight=Live2DCubismCore.ColorBlendType_HardLight]="ColorBlend_HardLight",a[a.ColorBlend_LinearLight=Live2DCubismCore.ColorBlendType_LinearLight]="ColorBlend_LinearLight",a[a.ColorBlend_Hue=Live2DCubismCore.ColorBlendType_Hue]="ColorBlend_Hue",a[a.ColorBlend_Color=Live2DCubismCore.ColorBlendType_Color]="ColorBlend_Color",a[a.ColorBlend_AddCompatible=Live2DCubismCore.ColorBlendType_AddCompatible]="ColorBlend_AddCompatible",a[a.ColorBlend_MultiplyCompatible=Live2DCubismCore.ColorBlendType_MultiplyCompatible]="ColorBlend_MultiplyCompatible",a))(L||{}),ee=(a=>(a[a.AlphaBlend_None=-1]="AlphaBlend_None",a[a.AlphaBlend_Over=0]="AlphaBlend_Over",a[a.AlphaBlend_Atop=1]="AlphaBlend_Atop",a[a.AlphaBlend_Out=2]="AlphaBlend_Out",a[a.AlphaBlend_ConjointOver=3]="AlphaBlend_ConjointOver",a[a.AlphaBlend_DisjointOver=4]="AlphaBlend_DisjointOver",a))(ee||{});class Sa{constructor(e=!1,t=!1){this.isOverridden=e,this.isParameterRepeated=t}}class Ni{constructor(e=!1,t=new D){this.isOverridden=e,this.color=t}get isOverwritten(){return this.isOverridden}}class et{constructor(e=!1,t=new D){this.isOverridden=e,this.color=t}}class ba{constructor(e=!1,t=!1){this.isOverridden=e,this.isCulling=t}}class Ma{constructor(e=new C,t=new C){this.drawableIndices=e,this.offscreenIndices=t}}class Ui{constructor(e,t){this.objectIndex=e,this.objectType=t}}class xa{constructor(e=new C,t=new Ma){this.objects=e,this.childDrawObjects=t}getChildObjectCount(){return this.objects.getSize()}}class Vs{update(){this._model.update(),this._model.drawables.resetDynamicFlags()}getPixelsPerUnit(){return this._model==null?0:this._model.canvasinfo.PixelsPerUnit}getCanvasWidth(){return this._model==null?0:this._model.canvasinfo.CanvasWidth/this._model.canvasinfo.PixelsPerUnit}getCanvasHeight(){return this._model==null?0:this._model.canvasinfo.CanvasHeight/this._model.canvasinfo.PixelsPerUnit}saveParameters(){const e=this._model.parameters.count,t=this._savedParameters.getSize();for(let i=0;i<e;++i)i<t?this._savedParameters.set(i,this._parameterValues[i]):this._savedParameters.pushBack(this._parameterValues[i])}getMultiplyColor(e){return this.getOverrideFlagForModelMultiplyColors()||this.getOverrideFlagForDrawableMultiplyColors(e)?this._userDrawableMultiplyColors.at(e).color:this.getDrawableMultiplyColor(e)}getScreenColor(e){return this.getOverrideFlagForModelScreenColors()||this.getOverrideFlagForDrawableScreenColors(e)?this._userDrawableScreenColors.at(e).color:this.getDrawableScreenColor(e)}setMultiplyColorByTextureColor(e,t){this.setMultiplyColorByRGBA(e,t.r,t.g,t.b,t.a)}setMultiplyColorByRGBA(e,t,i,s,r=1){this._userDrawableMultiplyColors.at(e).color.r=t,this._userDrawableMultiplyColors.at(e).color.g=i,this._userDrawableMultiplyColors.at(e).color.b=s,this._userDrawableMultiplyColors.at(e).color.a=r}setScreenColorByTextureColor(e,t){this.setScreenColorByRGBA(e,t.r,t.g,t.b,t.a)}setScreenColorByRGBA(e,t,i,s,r=1){this._userDrawableScreenColors.at(e).color.r=t,this._userDrawableScreenColors.at(e).color.g=i,this._userDrawableScreenColors.at(e).color.b=s,this._userDrawableScreenColors.at(e).color.a=r}getPartMultiplyColor(e){return this._userPartMultiplyColors.at(e).color}getPartScreenColor(e){return this._userPartScreenColors.at(e).color}setPartColor(e,t,i,s,r,n,o){if(n.at(e).color.r=t,n.at(e).color.g=i,n.at(e).color.b=s,n.at(e).color.a=r,n.at(e).isOverridden)for(let l=0;l<this._partChildDrawables.at(e).getSize();++l){const h=this._partChildDrawables.at(e).at(l);o.at(h).color.r=t,o.at(h).color.g=i,o.at(h).color.b=s,o.at(h).color.a=r}}setPartMultiplyColorByTextureColor(e,t){this.setPartMultiplyColorByRGBA(e,t.r,t.g,t.b,t.a)}setPartMultiplyColorByRGBA(e,t,i,s,r){this.setPartColor(e,t,i,s,r,this._userPartMultiplyColors,this._userDrawableMultiplyColors)}setPartScreenColorByTextureColor(e,t){this.setPartScreenColorByRGBA(e,t.r,t.g,t.b,t.a)}setPartScreenColorByRGBA(e,t,i,s,r){this.setPartColor(e,t,i,s,r,this._userPartScreenColors,this._userDrawableScreenColors)}getMultiplyColorOffscreen(e){return this.getOverrideFlagForModelMultiplyColors()||this.getOverrideFlagForOffscreenMultiplyColors(e)?this._userOffscreenMultiplyColors.at(e).color:this.getOffscreenMultiplyColor(e)}getScreenColorOffscreen(e){return this.getOverrideFlagForModelScreenColors()||this.getOverrideFlagForOffscreenScreenColors(e)?this._userOffscreenScreenColors.at(e).color:this.getOffscreenScreenColor(e)}setMultiplyColorByTextureColorOffscreen(e,t){this.setMultiplyColorByRGBAOffscreen(e,t.r,t.g,t.b,t.a)}setMultiplyColorByRGBAOffscreen(e,t,i,s,r=1){this._userOffscreenMultiplyColors.at(e).color.r=t,this._userOffscreenMultiplyColors.at(e).color.g=i,this._userOffscreenMultiplyColors.at(e).color.b=s,this._userOffscreenMultiplyColors.at(e).color.a=r}setScreenColorByTextureColorOffscreen(e,t){this.setScreenColorByRGBAOffscreen(e,t.r,t.g,t.b,t.a)}setScreenColorByRGBAOffscreen(e,t,i,s,r=1){this._userOffscreenScreenColors.at(e).color.r=t,this._userOffscreenScreenColors.at(e).color.g=i,this._userOffscreenScreenColors.at(e).color.b=s,this._userOffscreenScreenColors.at(e).color.a=r}getOverrideFlagForModelParameterRepeat(){return this._isOverriddenParameterRepeat}setOverrideFlagForModelParameterRepeat(e){this._isOverriddenParameterRepeat=e}getOverrideFlagForParameterRepeat(e){return this._userParameterRepeatDataList.at(e).isOverridden}setOverrideFlagForParameterRepeat(e,t){this._userParameterRepeatDataList.at(e).isOverridden=t}getRepeatFlagForParameterRepeat(e){return this._userParameterRepeatDataList.at(e).isParameterRepeated}setRepeatFlagForParameterRepeat(e,t){this._userParameterRepeatDataList.at(e).isParameterRepeated=t}getOverwriteFlagForModelMultiplyColors(){return F("getOverwriteFlagForModelMultiplyColors() is a deprecated function. Please use getOverrideFlagForModelMultiplyColors()."),this.getOverrideFlagForModelMultiplyColors()}getOverrideFlagForModelMultiplyColors(){return this._isOverriddenModelMultiplyColors}getOverwriteFlagForModelScreenColors(){return F("getOverwriteFlagForModelScreenColors() is a deprecated function. Please use getOverrideFlagForModelScreenColors()."),this.getOverrideFlagForModelScreenColors()}getOverrideFlagForModelScreenColors(){return this._isOverriddenModelScreenColors}setOverwriteFlagForModelMultiplyColors(e){F("setOverwriteFlagForModelMultiplyColors(value: boolean) is a deprecated function. Please use setOverrideFlagForModelMultiplyColors(value: boolean)."),this.setOverrideFlagForModelMultiplyColors(e)}setOverrideFlagForModelMultiplyColors(e){this._isOverriddenModelMultiplyColors=e}setOverwriteFlagForModelScreenColors(e){F("setOverwriteFlagForModelScreenColors(value: boolean) is a deprecated function. Please use setOverrideFlagForModelScreenColors(value: boolean)."),this.setOverrideFlagForModelScreenColors(e)}setOverrideFlagForModelScreenColors(e){this._isOverriddenModelScreenColors=e}getOverwriteFlagForDrawableMultiplyColors(e){return F("getOverwriteFlagForDrawableMultiplyColors(drawableIndex: number) is a deprecated function. Please use getOverrideFlagForDrawableMultiplyColors(drawableIndex: number)."),this.getOverrideFlagForDrawableMultiplyColors(e)}getOverrideFlagForDrawableMultiplyColors(e){return this._userDrawableMultiplyColors.at(e).isOverridden}getOverwriteFlagForDrawableScreenColors(e){return F("getOverwriteFlagForDrawableScreenColors(drawableIndex: number) is a deprecated function. Please use getOverrideFlagForDrawableScreenColors(drawableIndex: number)."),this.getOverrideFlagForDrawableScreenColors(e)}getOverrideFlagForDrawableScreenColors(e){return this._userDrawableScreenColors.at(e).isOverridden}setOverwriteFlagForDrawableMultiplyColors(e,t){F("setOverwriteFlagForDrawableMultiplyColors(drawableIndex: number, value: boolean) is a deprecated function. Please use setOverrideFlagForDrawableMultiplyColors(drawableIndex: number, value: boolean)."),this.setOverrideFlagForDrawableMultiplyColors(e,t)}setOverrideFlagForDrawableMultiplyColors(e,t){this._userDrawableMultiplyColors.at(e).isOverridden=t}setOverwriteFlagForDrawableScreenColors(e,t){F("setOverwriteFlagForDrawableScreenColors(drawableIndex: number, value: boolean) is a deprecated function. Please use setOverrideFlagForDrawableScreenColors(drawableIndex: number, value: boolean)."),this.setOverrideFlagForDrawableScreenColors(e,t)}setOverrideFlagForDrawableScreenColors(e,t){this._userDrawableScreenColors.at(e).isOverridden=t}getOverwriteColorForPartMultiplyColors(e){return F("getOverwriteColorForPartMultiplyColors(partIndex: number) is a deprecated function. Please use getOverrideColorForPartMultiplyColors(partIndex: number)."),this.getOverrideColorForPartMultiplyColors(e)}getOverrideColorForPartMultiplyColors(e){return this._userPartMultiplyColors.at(e).isOverridden}getOverwriteColorForPartScreenColors(e){return F("getOverwriteColorForPartScreenColors(partIndex: number) is a deprecated function. Please use getOverrideColorForPartScreenColors(partIndex: number)."),this.getOverrideColorForPartScreenColors(e)}getOverrideColorForPartScreenColors(e){return this._userPartScreenColors.at(e).isOverridden}setOverwriteColorForPartColors(e,t,i,s){F("setOverwriteColorForPartColors(partIndex: number, value: boolean, partColors: csmVector<PartColorData>, drawableColors: csmVector<DrawableColorData>) is a deprecated function. Please use setOverrideColorForPartColors(partIndex: number, value: boolean, partColors: csmVector<PartColorData>, drawableColors: csmVector<DrawableColorData>)."),this.setOverrideColorForPartColors(e,t,i,s)}setOverrideColorForPartColors(e,t,i,s){i.at(e).isOverridden=t;for(let r=0;r<this._partChildDrawables.at(e).getSize();++r){const n=this._partChildDrawables.at(e).at(r);s.at(n).isOverridden=t,t&&(s.at(n).color.r=i.at(e).color.r,s.at(n).color.g=i.at(e).color.g,s.at(n).color.b=i.at(e).color.b,s.at(n).color.a=i.at(e).color.a)}}setOverwriteColorForPartMultiplyColors(e,t){F("setOverwriteColorForPartMultiplyColors(partIndex: number, value: boolean) is a deprecated function. Please use setOverrideColorForPartMultiplyColors(partIndex: number, value: boolean)."),this.setOverrideColorForPartMultiplyColors(e,t)}setOverrideColorForPartMultiplyColors(e,t){this._userPartMultiplyColors.at(e).isOverridden=t,this.setOverrideColorForPartColors(e,t,this._userPartMultiplyColors,this._userDrawableMultiplyColors)}setOverwriteColorForPartScreenColors(e,t){F("setOverwriteColorForPartScreenColors(partIndex: number, value: boolean) is a deprecated function. Please use setOverrideColorForPartScreenColors(partIndex: number, value: boolean)."),this.setOverrideColorForPartScreenColors(e,t)}setOverrideColorForPartScreenColors(e,t){this._userPartScreenColors.at(e).isOverridden=t,this.setOverrideColorForPartColors(e,t,this._userPartScreenColors,this._userDrawableScreenColors)}getOverrideFlagForOffscreenMultiplyColors(e){return this._userOffscreenMultiplyColors.at(e).isOverridden}getOverrideFlagForOffscreenScreenColors(e){return this._userOffscreenScreenColors.at(e).isOverridden}setOverrideFlagForOffscreenMultiplyColors(e,t){this._userOffscreenMultiplyColors.at(e).isOverridden=t}setOverrideFlagForOffscreenScreenColors(e,t){this._userOffscreenScreenColors.at(e).isOverridden=t}getDrawableCulling(e){if(this.getOverrideFlagForModelCullings()||this.getOverrideFlagForDrawableCullings(e))return this._userDrawableCullings.at(e).isCulling;const t=this._model.drawables.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(t[e])}setDrawableCulling(e,t){this._userDrawableCullings.at(e).isCulling=t}getOffscreenCulling(e){if(this.getOverrideFlagForModelCullings()||this.getOverrideFlagForOffscreenCullings(e))return this._userOffscreenCullings.at(e).isCulling;const t=this._model.offscreens.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(t[e])}setOffscreenCulling(e,t){this._userOffscreenCullings.at(e).isCulling=t}getOverwriteFlagForModelCullings(){return F("getOverwriteFlagForModelCullings() is a deprecated function. Please use getOverrideFlagForModelCullings()."),this.getOverrideFlagForModelCullings()}getOverrideFlagForModelCullings(){return this._isOverriddenCullings}setOverwriteFlagForModelCullings(e){F("setOverwriteFlagForModelCullings(isOverriddenCullings: boolean) is a deprecated function. Please use setOverrideFlagForModelCullings(isOverriddenCullings: boolean)."),this.setOverrideFlagForModelCullings(e)}setOverrideFlagForModelCullings(e){this._isOverriddenCullings=e}getOverwriteFlagForDrawableCullings(e){return F("getOverwriteFlagForDrawableCullings(drawableIndex: number) is a deprecated function. Please use getOverrideFlagForDrawableCullings(drawableIndex: number)."),this.getOverrideFlagForDrawableCullings(e)}getOverrideFlagForDrawableCullings(e){return this._userDrawableCullings.at(e).isOverridden}getOverrideFlagForOffscreenCullings(e){return this._userOffscreenCullings.at(e).isOverridden}setOverwriteFlagForDrawableCullings(e,t){F("setOverwriteFlagForDrawableCullings(drawableIndex: number, isOverriddenCullings: boolean) is a deprecated function. Please use setOverrideFlagForDrawableCullings(drawableIndex: number, isOverriddenCullings: boolean)."),this.setOverrideFlagForDrawableCullings(e,t)}setOverrideFlagForDrawableCullings(e,t){this._userDrawableCullings.at(e).isOverridden=t}getModelOapcity(){return this._modelOpacity}setModelOapcity(e){this._modelOpacity=e}getModel(){return this._model}getPartIndex(e){let t;const i=this._model.parts.count;for(t=0;t<i;++t)if(e==this._partIds.at(t))return t;return this._notExistPartId.isExist(e)?this._notExistPartId.getValue(e):(t=i+this._notExistPartId.getSize(),this._notExistPartId.setValue(e,t),this._notExistPartOpacities.appendKey(t),t)}getPartId(e){const t=this._model.parts.ids[e];return T.getIdManager().getId(t)}getPartCount(){return this._model.parts.count}getPartParentPartIndices(){return this._model.parts.parentIndices}setPartOpacityByIndex(e,t){if(this._notExistPartOpacities.isExist(e)){this._notExistPartOpacities.setValue(e,t);return}G(0<=e&&e<this.getPartCount()),this._partOpacities[e]=t}setPartOpacityById(e,t){const i=this.getPartIndex(e);i<0||this.setPartOpacityByIndex(i,t)}getPartOpacityByIndex(e){return this._notExistPartOpacities.isExist(e)?this._notExistPartOpacities.getValue(e):(G(0<=e&&e<this.getPartCount()),this._partOpacities[e])}getPartOpacityById(e){const t=this.getPartIndex(e);return t<0?0:this.getPartOpacityByIndex(t)}getParameterIndex(e){let t;const i=this._model.parameters.count;for(t=0;t<i;++t)if(e==this._parameterIds.at(t))return t;return this._notExistParameterId.isExist(e)?this._notExistParameterId.getValue(e):(t=this._model.parameters.count+this._notExistParameterId.getSize(),this._notExistParameterId.setValue(e,t),this._notExistParameterValues.appendKey(t),t)}getParameterCount(){return this._model.parameters.count}getParameterType(e){return this._model.parameters.types[e]}getParameterMaximumValue(e){return this._model.parameters.maximumValues[e]}getParameterMinimumValue(e){return this._model.parameters.minimumValues[e]}getParameterDefaultValue(e){return this._model.parameters.defaultValues[e]}getParameterId(e){return T.getIdManager().getId(this._model.parameters.ids[e])}getParameterValueByIndex(e){return this._notExistParameterValues.isExist(e)?this._notExistParameterValues.getValue(e):(G(0<=e&&e<this.getParameterCount()),this._parameterValues[e])}getParameterValueById(e){const t=this.getParameterIndex(e);return this.getParameterValueByIndex(t)}setParameterValueByIndex(e,t,i=1){if(this._notExistParameterValues.isExist(e)){this._notExistParameterValues.setValue(e,i==1?t:this._notExistParameterValues.getValue(e)*(1-i)+t*i);return}G(0<=e&&e<this.getParameterCount()),this.isRepeat(e)?t=this.getParameterRepeatValue(e,t):t=this.getParameterClampValue(e,t),this._parameterValues[e]=i==1?t:this._parameterValues[e]=this._parameterValues[e]*(1-i)+t*i}setParameterValueById(e,t,i=1){const s=this.getParameterIndex(e);this.setParameterValueByIndex(s,t,i)}addParameterValueByIndex(e,t,i=1){this.setParameterValueByIndex(e,this.getParameterValueByIndex(e)+t*i)}addParameterValueById(e,t,i=1){const s=this.getParameterIndex(e);this.addParameterValueByIndex(s,t,i)}isRepeat(e){if(this._notExistParameterValues.isExist(e))return!1;G(0<=e&&e<this.getParameterCount());let t;return this._isOverriddenParameterRepeat||this._userParameterRepeatDataList.at(e).isOverridden?t=this._userParameterRepeatDataList.at(e).isParameterRepeated:t=this._model.parameters.repeats[e]!=0,t}getParameterRepeatValue(e,t){if(this._notExistParameterValues.isExist(e))return t;G(0<=e&&e<this.getParameterCount());const i=this._model.parameters.maximumValues[e],s=this._model.parameters.minimumValues[e],r=i-s;if(i<t){const n=S.mod(t-i,r);Number.isNaN(n)?t=i:t=s+n}if(t<s){const n=S.mod(s-t,r);Number.isNaN(n)?t=s:t=i-n}return t}getParameterClampValue(e,t){if(this._notExistParameterValues.isExist(e))return t;G(0<=e&&e<this.getParameterCount());const i=this._model.parameters.maximumValues[e],s=this._model.parameters.minimumValues[e];return S.clamp(t,s,i)}getParameterRepeats(e){return this._model.parameters.repeats[e]!=0}multiplyParameterValueById(e,t,i=1){const s=this.getParameterIndex(e);this.multiplyParameterValueByIndex(s,t,i)}multiplyParameterValueByIndex(e,t,i=1){this.setParameterValueByIndex(e,this.getParameterValueByIndex(e)*(1+(t-1)*i))}getDrawableIndex(e){const t=this._model.drawables.count;for(let i=0;i<t;++i)if(this._drawableIds.at(i)==e)return i;return-1}getDrawableCount(){return this._model.drawables.count}getDrawableId(e){const t=this._model.drawables.ids;return T.getIdManager().getId(t[e])}getRenderOrders(){return this._model.getRenderOrders()}getDrawableTextureIndices(e){return this.getDrawableTextureIndex(e)}getDrawableTextureIndex(e){return this._model.drawables.textureIndices[e]}getDrawableDynamicFlagVertexPositionsDidChange(e){const t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVertexPositionsDidChangeBit(t[e])}getDrawableVertexIndexCount(e){return this._model.drawables.indexCounts[e]}getDrawableVertexCount(e){return this._model.drawables.vertexCounts[e]}getDrawableVertices(e){return this.getDrawableVertexPositions(e)}getDrawableVertexIndices(e){return this._model.drawables.indices[e]}getDrawableVertexPositions(e){return this._model.drawables.vertexPositions[e]}getDrawableVertexUvs(e){return this._model.drawables.vertexUvs[e]}getDrawableOpacity(e){return this._model.drawables.opacities[e]}getDrawableMultiplyColor(e){this._drawableMultiplyColors==null&&(this._drawableMultiplyColors=new Array(this._model.drawables.count),this._drawableMultiplyColors.fill(new D));const t=this._model.drawables.multiplyColors,i=e*4;return this._drawableMultiplyColors[e].r=t[i],this._drawableMultiplyColors[e].g=t[i+1],this._drawableMultiplyColors[e].b=t[i+2],this._drawableMultiplyColors[e].a=t[i+3],this._drawableMultiplyColors[e]}getDrawableScreenColor(e){this._drawableScreenColors==null&&(this._drawableScreenColors=new Array(this._model.drawables.count),this._drawableScreenColors.fill(new D));const t=this._model.drawables.screenColors,i=e*4;return this._drawableScreenColors[e].r=t[i],this._drawableScreenColors[e].g=t[i+1],this._drawableScreenColors[e].b=t[i+2],this._drawableScreenColors[e].a=t[i+3],this._drawableScreenColors[e]}getOffscreenMultiplyColor(e){this._offscreenMultiplyColors==null&&(this._offscreenMultiplyColors=new Array(this._model.offscreens.count),this._offscreenMultiplyColors.fill(new D));const t=this._model.offscreens.multiplyColors,i=e*4;return this._offscreenMultiplyColors[e].r=t[i],this._offscreenMultiplyColors[e].g=t[i+1],this._offscreenMultiplyColors[e].b=t[i+2],this._offscreenMultiplyColors[e].a=t[i+3],this._offscreenMultiplyColors[e]}getOffscreenScreenColor(e){this._offscreenScreenColors==null&&(this._offscreenScreenColors=new Array(this._model.offscreens.count),this._offscreenScreenColors.fill(new D));const t=this._model.offscreens.screenColors,i=e*4;return this._offscreenScreenColors[e].r=t[i],this._offscreenScreenColors[e].g=t[i+1],this._offscreenScreenColors[e].b=t[i+2],this._offscreenScreenColors[e].a=t[i+3],this._offscreenScreenColors[e]}getDrawableParentPartIndex(e){return this._model.drawables.parentPartIndices[e]}getDrawableBlendMode(e){const t=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasBlendAdditiveBit(t[e])?ne.CubismBlendMode_Additive:Live2DCubismCore.Utils.hasBlendMultiplicativeBit(t[e])?ne.CubismBlendMode_Multiplicative:ne.CubismBlendMode_Normal}getDrawableColorBlend(e){return this._drawableColorBlends[e]==-1&&(this._drawableColorBlends[e]=this._model.drawables.blendModes[e]&255),this._drawableColorBlends[e]}getDrawableAlphaBlend(e){return this._drawableAlphaBlends[e]==-1&&(this._drawableAlphaBlends[e]=this._model.drawables.blendModes[e]>>8&255),this._drawableAlphaBlends[e]}getDrawableInvertedMaskBit(e){const t=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(t[e])}getDrawableMasks(){return this._model.drawables.masks}getDrawableMaskCounts(){return this._model.drawables.maskCounts}isUsingMasking(){for(let e=0;e<this._model.drawables.count;++e)if(!(this._model.drawables.maskCounts[e]<=0))return!0;return!1}isUsingMaskingForOffscreen(){for(let e=0;e<this.getOffscreenCount();++e)if(!(this._model.offscreens.maskCounts[e]<=0))return!0;return!1}getDrawableDynamicFlagIsVisible(e){const t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasIsVisibleBit(t[e])}getDrawableDynamicFlagVisibilityDidChange(e){const t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVisibilityDidChangeBit(t[e])}getDrawableDynamicFlagOpacityDidChange(e){const t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasOpacityDidChangeBit(t[e])}getDrawableDynamicFlagRenderOrderDidChange(e){const t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasRenderOrderDidChangeBit(t[e])}getDrawableDynamicFlagBlendColorDidChange(e){const t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasBlendColorDidChangeBit(t[e])}getOffscreenCount(){return this._model.offscreens.count}getOffscreenColorBlend(e){return this._offscreenColorBlends[e]==-1&&(this._offscreenColorBlends[e]=this._model.offscreens.blendModes[e]&255),this._offscreenColorBlends[e]}getOffscreenAlphaBlend(e){return this._offscreenAlphaBlends[e]==-1&&(this._offscreenAlphaBlends[e]=this._model.offscreens.blendModes[e]>>8&255),this._offscreenAlphaBlends[e]}getOffscreenOwnerIndices(){return this._model.offscreens.ownerIndices}getOffscreenOpacity(e){return e<0||e>=this._model.offscreens.count?1:this._model.offscreens.opacities[e]}getOffscreenMasks(){return this._model.offscreens.masks}getOffscreenMaskCounts(){return this._model.offscreens.maskCounts}getOffscreenInvertedMask(e){const t=this._model.offscreens.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(t[e])}isBlendModeEnabled(){return this._isBlendModeEnabled}loadParameters(){let e=this._model.parameters.count;const t=this._savedParameters.getSize();e>t&&(e=t);for(let i=0;i<e;++i)this._parameterValues[i]=this._savedParameters.at(i)}initialize(){G(this._model),this._parameterValues=this._model.parameters.values,this._partOpacities=this._model.parts.opacities,this._offscreenOpacities=this._model.offscreens.opacities,this._parameterMaximumValues=this._model.parameters.maximumValues,this._parameterMinimumValues=this._model.parameters.minimumValues;{const t=this._model.parameters.ids,i=this._model.parameters.count;this._parameterIds.prepareCapacity(i),this._userParameterRepeatDataList.prepareCapacity(i);for(let s=0;s<i;++s)this._parameterIds.pushBack(T.getIdManager().getId(t[s])),this._userParameterRepeatDataList.pushBack(new Sa(!1,!1))}const e=this._model.parts.count;{const t=this._model.parts.ids;this._partIds.prepareCapacity(e);for(let i=0;i<e;++i)this._partIds.pushBack(T.getIdManager().getId(t[i]));this._userPartMultiplyColors.prepareCapacity(e),this._userPartScreenColors.prepareCapacity(e),this._partChildDrawables.prepareCapacity(e)}{const t=this._model.drawables.ids,i=this._model.drawables.count;this._userDrawableMultiplyColors.prepareCapacity(i),this._userDrawableScreenColors.prepareCapacity(i),this._userDrawableCullings.prepareCapacity(i);const s=new ba(!1,!1);for(let r=0;r<e;++r){const n=new D(1,1,1,1),o=new D(0,0,0,1),l=new Ni(!1,n),h=new Ni(!1,o);this._userPartMultiplyColors.pushBack(l),this._userPartScreenColors.pushBack(h),this._partChildDrawables.pushBack(new C),this._partChildDrawables.at(r).prepareCapacity(i)}for(let r=0;r<i;++r){const n=new D(1,1,1,1),o=new D(0,0,0,1),l=new et(!1,n),h=new et(!1,o);this._drawableIds.pushBack(T.getIdManager().getId(t[r])),this._userDrawableMultiplyColors.pushBack(l),this._userDrawableScreenColors.pushBack(h),this._userDrawableCullings.pushBack(s);const u=this.getDrawableParentPartIndex(r);u>=0&&this._partChildDrawables.at(u).pushBack(r)}if(this.getOffscreenCount()>0)this._isBlendModeEnabled=!0;else{this._model.drawables.blendModes;for(let r=0;r<i;++r){const n=this.getDrawableColorBlend(r),o=this.getDrawableAlphaBlend(r);if(!(n==L.ColorBlend_Normal&&o==0)&&n!=L.ColorBlend_AddCompatible&&n!=L.ColorBlend_MultiplyCompatible){this._isBlendModeEnabled=!0;break}}}{const r=this._model.offscreens.count;this._userOffscreenMultiplyColors=new C,this._userOffscreenScreenColors=new C,this._userOffscreenCullings=new C,this._userOffscreenMultiplyColors.prepareCapacity(r),this._userOffscreenScreenColors.prepareCapacity(r),this._userOffscreenCullings.prepareCapacity(r);for(let n=0;n<r;++n){const o=new D(1,1,1,1),l=new D(0,0,0,1),h=new et(!1,o),u=new et(!1,l);this._userOffscreenMultiplyColors.pushBack(h),this._userOffscreenScreenColors.pushBack(u),this._userOffscreenCullings.pushBack(s)}}this.setupPartsHierarchy()}}getPartsHierarchy(){return this._partsHierarchy}setupPartsHierarchy(){this._partsHierarchy.clear();const e=this.getPartCount();for(let i=0;i<e;++i){const s=new xa;this._partsHierarchy.pushBack(s)}for(let i=0;i<e;++i){const s=this.getPartParentPartIndices()[i];if(s!==be){for(let r=0;r<this._partsHierarchy.getSize();++r)if(r===s){const n=new Ui(i,1);this._partsHierarchy.at(r).objects.pushBack(n);break}}}const t=this.getDrawableCount();for(let i=0;i<t;++i){const s=this.getDrawableParentPartIndex(i);if(s!==be){for(let r=0;r<this._partsHierarchy.getSize();++r)if(r===s){const n=new Ui(i,0);this._partsHierarchy.at(r).objects.pushBack(n);break}}}for(let i=0;i<this._partsHierarchy.getSize();++i)this.getPartChildDrawObjects(i)}getPartChildDrawObjects(e){if(this._partsHierarchy.at(e).getChildObjectCount()<1)return this._partsHierarchy.at(e).childDrawObjects;const t=this._partsHierarchy.at(e).childDrawObjects;if(t.drawableIndices.getSize()!==0||t.offscreenIndices.getSize()!==0)return t;const i=this._partsHierarchy.at(e).objects;for(let s=0;s<i.getSize();++s){const r=i.at(s);if(r.objectType===1){this.getPartChildDrawObjects(r.objectIndex);const n=this._partsHierarchy.at(r.objectIndex).childDrawObjects;for(let h=0;h<n.drawableIndices.getSize();++h)t.drawableIndices.pushBack(n.drawableIndices.at(h));for(let h=0;h<n.offscreenIndices.getSize();++h)t.offscreenIndices.pushBack(n.offscreenIndices.at(h));const o=this.getOffscreenIndices(),l=o?o[r.objectIndex]:ki;l!==ki&&t.offscreenIndices.pushBack(l)}else r.objectType===0&&t.drawableIndices.pushBack(r.objectIndex)}return t}getOffscreenIndices(){return this._model.parts.offscreenIndices}constructor(e){this._model=e,this._parameterValues=null,this._parameterMaximumValues=null,this._parameterMinimumValues=null,this._partOpacities=null,this._offscreenOpacities=null,this._savedParameters=new C,this._parameterIds=new C,this._drawableIds=new C,this._partIds=new C,this._isOverriddenParameterRepeat=!0,this._isOverriddenModelMultiplyColors=!1,this._isOverriddenModelScreenColors=!1,this._isOverriddenCullings=!1,this._modelOpacity=1,this._isBlendModeEnabled=!1,this._drawableColorBlends=null,this._drawableAlphaBlends=null,this._offscreenColorBlends=null,this._offscreenAlphaBlends=null,this._drawableMultiplyColors=null,this._drawableScreenColors=null,this._offscreenMultiplyColors=null,this._offscreenScreenColors=null,this._userParameterRepeatDataList=new C,this._userDrawableMultiplyColors=new C,this._userDrawableScreenColors=new C,this._userDrawableCullings=new C,this._userPartMultiplyColors=new C,this._userPartScreenColors=new C,this._partChildDrawables=new C,this._partsHierarchy=new C,this._notExistPartId=new N,this._notExistParameterId=new N,this._notExistParameterValues=new N,this._notExistPartOpacities=new N,this._drawableColorBlends=new Array(e.drawables.count).fill(-1),this._drawableAlphaBlends=new Array(e.drawables.count).fill(-1),this._offscreenColorBlends=new Array(e.offscreens.count).fill(-1),this._offscreenAlphaBlends=new Array(e.offscreens.count).fill(-1)}release(){this._model.release(),this._model=null,this._drawableColorBlends=null,this._drawableAlphaBlends=null,this._offscreenColorBlends=null,this._offscreenAlphaBlends=null,this._drawableMultiplyColors=null,this._drawableScreenColors=null,this._offscreenMultiplyColors=null,this._offscreenScreenColors=null}}var zi;(a=>{a.CubismModel=Vs})(zi||(zi={}));const St=4,Ba=36,Pa=32;class va{constructor(e){this._renderTextureCount=0,this._clippingMaskBufferSize=256,this._clippingContextListForMask=new C,this._clippingContextListForDraw=new C,this._clippingContextListForOffscreen=new C,this._channelColors=new C,this._tmpBoundsOnModel=new at,this._tmpMatrix=new E,this._tmpMatrixForMask=new E,this._tmpMatrixForDraw=new E,this._clearedMaskBufferFlags=new C,this._clippingContexttConstructor=e;let t=new D;t.r=1,t.g=0,t.b=0,t.a=0,this._channelColors.pushBack(t),t=new D,t.r=0,t.g=1,t.b=0,t.a=0,this._channelColors.pushBack(t),t=new D,t.r=0,t.g=0,t.b=1,t.a=0,this._channelColors.pushBack(t),t=new D,t.r=0,t.g=0,t.b=0,t.a=1,this._channelColors.pushBack(t)}release(){for(let e=0;e<this._clippingContextListForMask.getSize();e++)this._clippingContextListForMask.at(e)&&(this._clippingContextListForMask.at(e).release(),this._clippingContextListForMask.set(e,void 0)),this._clippingContextListForMask.set(e,null);this._clippingContextListForMask=null;for(let e=0;e<this._clippingContextListForDraw.getSize();e++)this._clippingContextListForDraw.set(e,null);this._clippingContextListForDraw=null;for(let e=0;e<this._channelColors.getSize();e++)this._channelColors.set(e,null);this._channelColors=null,this._clearedMaskBufferFlags!=null&&this._clearedMaskBufferFlags.clear(),this._clearedMaskBufferFlags=null}initializeForDrawable(e,t){t%1!=0&&(F("The number of render textures must be specified as an integer. The decimal point is rounded down and corrected to an integer."),t=~~t),t<1&&F("The number of render textures must be an integer greater than or equal to 1. Set the number of render textures to 1."),this._renderTextureCount=t<1?1:t,this._clearedMaskBufferFlags=new C(this._renderTextureCount);for(let i=0;i<e.getDrawableCount();i++){if(e.getDrawableMaskCounts()[i]<=0){this._clippingContextListForDraw.pushBack(null);continue}let s=this.findSameClip(e.getDrawableMasks()[i],e.getDrawableMaskCounts()[i]);s==null&&(s=new this._clippingContexttConstructor(this,e.getDrawableMasks()[i],e.getDrawableMaskCounts()[i]),this._clippingContextListForMask.pushBack(s)),s.addClippedDrawable(i),this._clippingContextListForDraw.pushBack(s)}}initializeForOffscreen(e,t){this._renderTextureCount=t;for(let i=0;i<this._renderTextureCount;++i)this._clearedMaskBufferFlags.pushBack(!1);for(let i=0;i<e.getOffscreenCount();++i){if(e.getOffscreenMaskCounts()[i]<=0){this._clippingContextListForOffscreen.pushBack(null);continue}let s=this.findSameClip(e.getOffscreenMasks()[i],e.getOffscreenMaskCounts()[i]);s==null&&(s=new this._clippingContexttConstructor(this,e.getOffscreenMasks()[i],e.getOffscreenMaskCounts()[i]),this._clippingContextListForMask.pushBack(s)),s.addClippedOffscreen(i),this._clippingContextListForOffscreen.pushBack(s)}}findSameClip(e,t){for(let i=0;i<this._clippingContextListForMask.getSize();i++){const s=this._clippingContextListForMask.at(i),r=s._clippingIdCount;if(r!=t)continue;let n=0;for(let o=0;o<r;o++){const l=s._clippingIdList[o];for(let h=0;h<r;h++)if(e[h]==l){n++;break}}if(n==r)return s}return null}setupMatrixForHighPrecision(e,t){let i=0;for(let s=0;s<this._clippingContextListForMask.getSize();s++){const r=this._clippingContextListForMask.at(s);this.calcClippedDrawableTotalBounds(e,r),r._isUsing&&i++}if(i>0){if(this.setupLayoutBounds(0),this._clearedMaskBufferFlags.getSize()!=this._renderTextureCount){this._clearedMaskBufferFlags.clear();for(let s=0;s<this._renderTextureCount;s++)this._clearedMaskBufferFlags.pushBack(!1)}else for(let s=0;s<this._renderTextureCount;s++)this._clearedMaskBufferFlags.set(s,!1);for(let s=0;s<this._clippingContextListForMask.getSize();s++){const r=this._clippingContextListForMask.at(s),n=r._allClippedDrawRect,o=r._layoutBounds,l=.05;let h=0,u=0;const d=e.getPixelsPerUnit(),_=r.getClippingManager().getClippingMaskBufferSize(),g=o.width*_,c=o.height*_;this._tmpBoundsOnModel.setRect(n),this._tmpBoundsOnModel.width*d>g?(this._tmpBoundsOnModel.expand(n.width*l,0),h=o.width/this._tmpBoundsOnModel.width):h=d/g,this._tmpBoundsOnModel.height*d>c?(this._tmpBoundsOnModel.expand(0,n.height*l),u=o.height/this._tmpBoundsOnModel.height):u=d/c,this.createMatrixForMask(t,o,h,u),r._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),r._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray())}}}setupMatrixForOffscreenHighPrecision(e,t,i){let s=0;for(let r=0;r<this._clippingContextListForMask.getSize();r++){const n=this._clippingContextListForMask.at(r);this.calcClippedOffscreenTotalBounds(e,n),n._isUsing&&s++}if(!(s<=0)){if(this.setupLayoutBounds(0),this._clearedMaskBufferFlags.getSize()!=this._renderTextureCount){this._clearedMaskBufferFlags.clear();for(let r=0;r<this._renderTextureCount;++r)this._clearedMaskBufferFlags.pushBack(!1)}else for(let r=0;r<this._renderTextureCount;++r)this._clearedMaskBufferFlags.set(r,!1);for(let r=0;r<this._clippingContextListForMask.getSize();r++){const n=this._clippingContextListForMask.at(r),o=n._allClippedDrawRect,l=n._layoutBounds,h=.05;let u=0,d=0;const _=e.getPixelsPerUnit(),g=n.getClippingManager().getClippingMaskBufferSize(),c=l.width*g,p=l.height*g;this._tmpBoundsOnModel.setRect(o),this._tmpBoundsOnModel.width*_>c?(this._tmpBoundsOnModel.expand(o.width*h,0),u=l.width/this._tmpBoundsOnModel.width):u=_/c,this._tmpBoundsOnModel.height*_>p?(this._tmpBoundsOnModel.expand(0,o.height*h),d=l.height/this._tmpBoundsOnModel.height):d=_/p,this.createMatrixForMask(t,l,u,d),n._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),n._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray());const f=i.getInvert();n._matrixForDraw.multiplyByMatrix(f)}}}calcClippedOffscreenTotalBounds(e,t){let i=Number.MAX_VALUE,s=Number.MAX_VALUE,r=-Number.MAX_VALUE,n=-Number.MAX_VALUE;const o=t._clippedOffscreenIndexList.length,l=new C;for(let u=0;u<o;u++){const d=t._clippedOffscreenIndexList[u];this.getOffscreenChildDrawableIndexList(e,d,l)}const h=l.getSize();for(let u=0;u<h;u++){const d=e.getDrawableVertexCount(l.at(u)),_=e.getDrawableVertices(l.at(u));let g=Number.MAX_VALUE,c=Number.MAX_VALUE,p=-Number.MAX_VALUE,f=-Number.MAX_VALUE;const x=d*Z.vertexStep;for(let P=Z.vertexOffset;P<x;P+=Z.vertexStep){const m=_[P],y=_[P+1];m<g&&(g=m),m>p&&(p=m),y<c&&(c=y),y>f&&(f=y)}g!=Number.MAX_VALUE&&(g<i&&(i=g),c<s&&(s=c),p>r&&(r=p),f>n&&(n=f))}if(i==Number.MAX_VALUE)t._allClippedDrawRect.x=0,t._allClippedDrawRect.y=0,t._allClippedDrawRect.width=0,t._allClippedDrawRect.height=0,t._isUsing=!1;else{t._isUsing=!0;const u=r-i,d=n-s;t._allClippedDrawRect.x=i,t._allClippedDrawRect.y=s,t._allClippedDrawRect.width=u,t._allClippedDrawRect.height=d}}getOffscreenChildDrawableIndexList(e,t,i){const s=e.getOffscreenOwnerIndices()[t];this.getPartChildDrawableIndexList(e,s,i)}getPartChildDrawableIndexList(e,t,i){const s=e.getPartsHierarchy().at(t).childDrawObjects;for(let r=0;r<s.drawableIndices.getSize();++r)i.pushBack(s.drawableIndices.at(r));for(let r=0;r<s.offscreenIndices.getSize();++r)this.getOffscreenChildDrawableIndexList(e,s.offscreenIndices.at(r),i)}createMatrixForMask(e,t,i,s){this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(t.x,t.y),this._tmpMatrix.scaleRelative(i,s),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(t.x,t.y*(e?-1:1)),this._tmpMatrix.scaleRelative(i,s*(e?-1:1)),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray())}setupLayoutBounds(e){const t=this._renderTextureCount<=1?Ba:Pa*this._renderTextureCount;if(e<=0||e>t){e>t&&w(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,e-t,this._renderTextureCount,e);for(let h=0;h<this._clippingContextListForMask.getSize();h++){const u=this._clippingContextListForMask.at(h);u._layoutChannelIndex=0,u._layoutBounds.x=0,u._layoutBounds.y=0,u._layoutBounds.width=1,u._layoutBounds.height=1,u._bufferIndex=0}return}const i=this._renderTextureCount<=1?9:8;let s=e/this._renderTextureCount;const r=e%this._renderTextureCount;s=Math.ceil(s);let n=s/St;const o=s%St;n=~~n;let l=0;for(let h=0;h<this._renderTextureCount;h++)for(let u=0;u<St;u++){let d=n+(u<o?1:0);const _=o+(n<1?-1:0);if(u==_&&r>0&&(d-=h<r?0:1),d!=0)if(d==1){const g=this._clippingContextListForMask.at(l++);g._layoutChannelIndex=u,g._layoutBounds.x=0,g._layoutBounds.y=0,g._layoutBounds.width=1,g._layoutBounds.height=1,g._bufferIndex=h}else if(d==2)for(let g=0;g<d;g++){let c=g%2;c=~~c;const p=this._clippingContextListForMask.at(l++);p._layoutChannelIndex=u,p._layoutBounds.x=c*.5,p._layoutBounds.y=0,p._layoutBounds.width=.5,p._layoutBounds.height=1,p._bufferIndex=h}else if(d<=4)for(let g=0;g<d;g++){let c=g%2,p=g/2;c=~~c,p=~~p;const f=this._clippingContextListForMask.at(l++);f._layoutChannelIndex=u,f._layoutBounds.x=c*.5,f._layoutBounds.y=p*.5,f._layoutBounds.width=.5,f._layoutBounds.height=.5,f._bufferIndex=h}else if(d<=i)for(let g=0;g<d;g++){let c=g%3,p=g/3;c=~~c,p=~~p;const f=this._clippingContextListForMask.at(l++);f._layoutChannelIndex=u,f._layoutBounds.x=c/3,f._layoutBounds.y=p/3,f._layoutBounds.width=1/3,f._layoutBounds.height=1/3,f._bufferIndex=h}else{w(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,e-t,this._renderTextureCount,e);for(let g=0;g<d;g++){const c=this._clippingContextListForMask.at(l++);c._layoutChannelIndex=0,c._layoutBounds.x=0,c._layoutBounds.y=0,c._layoutBounds.width=1,c._layoutBounds.height=1,c._bufferIndex=0}}}}calcClippedDrawableTotalBounds(e,t){let i=Number.MAX_VALUE,s=Number.MAX_VALUE,r=Number.MIN_VALUE,n=Number.MIN_VALUE;const o=t._clippedDrawableIndexList.length;for(let l=0;l<o;l++){const h=t._clippedDrawableIndexList[l],u=e.getDrawableVertexCount(h),d=e.getDrawableVertices(h);let _=Number.MAX_VALUE,g=Number.MAX_VALUE,c=-Number.MAX_VALUE,p=-Number.MAX_VALUE;const f=u*Z.vertexStep;for(let x=Z.vertexOffset;x<f;x+=Z.vertexStep){const P=d[x],m=d[x+1];P<_&&(_=P),P>c&&(c=P),m<g&&(g=m),m>p&&(p=m)}if(_!=Number.MAX_VALUE)if(_<i&&(i=_),g<s&&(s=g),c>r&&(r=c),p>n&&(n=p),i==Number.MAX_VALUE)t._allClippedDrawRect.x=0,t._allClippedDrawRect.y=0,t._allClippedDrawRect.width=0,t._allClippedDrawRect.height=0,t._isUsing=!1;else{t._isUsing=!0;const x=r-i,P=n-s;t._allClippedDrawRect.x=i,t._allClippedDrawRect.y=s,t._allClippedDrawRect.width=x,t._allClippedDrawRect.height=P}}}getClippingContextListForDraw(){return this._clippingContextListForDraw}getClippingContextListForOffscreen(){return this._clippingContextListForOffscreen}getClippingMaskBufferSize(){return this._clippingMaskBufferSize}getRenderTextureCount(){return this._renderTextureCount}getChannelFlagAsColor(e){return this._channelColors.at(e)}setClippingMaskBufferSize(e){this._clippingMaskBufferSize=e}}class ae{static copyBuffer(e,t,i){if(t==null||i==null)return;if(!(e instanceof WebGL2RenderingContext))throw new Error("WebGL2RenderingContext is required for buffer copy.");const s=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.READ_FRAMEBUFFER,t.getRenderTexture()),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i.getRenderTexture()),e.blitFramebuffer(0,0,t.getBufferWidth(),t.getBufferHeight(),0,0,i.getBufferWidth(),i.getBufferHeight(),e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,s)}beginDraw(e=null){this._renderTexture!=null&&(e==null?this._oldFbo=this._gl.getParameter(this._gl.FRAMEBUFFER_BINDING):this._oldFbo=e,this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._renderTexture))}endDraw(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._oldFbo)}clear(e,t,i,s){this._gl.clearColor(e,t,i,s),this._gl.clear(this._gl.COLOR_BUFFER_BIT)}createOffscreenRenderTarget(e,t,i,s){this.destroyRenderTarget(),this._colorBuffer=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._colorBuffer),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,null);const r=e.createFramebuffer();return r==null?(console.error("Failed to create framebuffer"),!1):(e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._colorBuffer,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE?(console.error("Framebuffer is not complete"),e.bindFramebuffer(e.FRAMEBUFFER,s),e.deleteFramebuffer(r),this.destroyRenderTarget(),!1):(this._renderTexture=r,this._bufferWidth=t,this._bufferHeight=i,this._gl=e,!0))}destroyRenderTarget(){this._colorBuffer&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.deleteTexture(this._colorBuffer),this._colorBuffer=null),this._renderTexture&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null),this._gl.deleteFramebuffer(this._renderTexture),this._renderTexture=null)}getGL(){return this._gl}getRenderTexture(){return this._renderTexture}getColorBuffer(){return this._colorBuffer}getBufferWidth(){return this._bufferWidth}getBufferHeight(){return this._bufferHeight}isValid(){return this._renderTexture!=null}setOffscreenIndex(e){this._offscreenIndex=e}getOffscreenIndex(){return this._offscreenIndex}getOldFBO(){return this._oldFbo}setOldOffscreen(e){this._oldOffscreen=e}getOldOffscreen(){return this._oldOffscreen}setParentPartOffscreen(e){this._parentOffscreenRenderTarget=e}getParentPartOffscreen(){return this._parentOffscreenRenderTarget}constructor(){this._gl=null,this._colorBuffer=null,this._renderTexture=null,this._bufferWidth=0,this._bufferHeight=0,this._oldFbo=null,this._offscreenIndex=-1,this._parentOffscreenRenderTarget=null,this._oldOffscreen=null}}var Xi;(a=>{a.CubismOffscreenSurface_WebGL=ae})(Xi||(Xi={}));const wa="vertshadersrccopy.vert",Fa="fragshadersrccopy.frag",Ta="fragshadersrccolorblend.frag",Ra="fragshadersrcalphablend.frag",Ia="vertshadersrcblend.vert",Va="fragshadersrcpremultipliedalphablend.frag",Gi="ColorBlend_",ji="AlphaBlend_";let me;const Yi=new Float32Array([-1,-1,1,-1,-1,1,1,1]),Oa=new Float32Array([0,0,1,0,0,1,1,1]),Ea=new Float32Array([0,1,1,1,0,0,1,0]);class Os{async loadShader(e){return await(await fetch(e)).text()}async loadBlendModeShaders(){const e="../../Framework/Shaders/WebGL/",t=[{path:e+wa,prop:"_vertShaderSrcCopy"},{path:e+Fa,prop:"_fragShaderSrcCopy"},{path:e+Ta,prop:"_fragShaderSrcColorBlend"},{path:e+Ra,prop:"_fragShaderSrcAlphaBlend"},{path:e+Ia,prop:"_vertShaderSrcBlend"},{path:e+Va,prop:"_fragShaderSrcBlend"}];(await Promise.all(t.map(s=>this.loadShader(s.path).then(r=>({prop:s.prop,data:r})).catch(r=>(console.error(`Error loading ${s.path} shader:`,r),{prop:s.prop,data:""}))))).forEach(s=>{this[s.prop]=s.data})}constructor(){this._shaderSets=new C,this._isShaderLoaded=!1,this._colorBlendMap=new N,this._colorBlendValues=new C;const e=Object.keys(L),t=Object.keys(L).map(r=>L[r]);for(let r=0;r<e.length;r++){const n=e[r];if(n.includes(Gi)){const o=n.slice(Gi.length),l=parseInt(t[r].toString());this._colorBlendMap.setValue(l,o),this._colorBlendValues.pushBack(l)}}this._alphaBlendMap=new N,this._alphaBlendValues=new C;const i=Object.keys(ee),s=Object.keys(ee).map(r=>ee[r]);for(let r=0;r<i.length;r++){const n=i[r];if(n.includes(ji)){const o=n.slice(ji.length),l=parseInt(s[r].toString());this._alphaBlendMap.setValue(l,o),this._alphaBlendValues.pushBack(l)}}this._blendShaderSetMap=new N,this._shaderCount=11+(this._colorBlendValues.getSize()-3)*(this._alphaBlendValues.getSize()-1)*3}release(){this.releaseShaderProgram()}setupShaderProgramForDrawable(e,t,i){e.isPremultipliedAlpha()||w("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()==0&&this.generateShaders();let s,r,n,o;const l=e.getClippingContextBufferForDrawable()!=null,h=t.getDrawableInvertedMaskBit(i),u=l?h?2:1:0;let d,_=!0;if(t.isBlendModeEnabled()){const B=t.getDrawableColorBlend(i),I=t.getDrawableAlphaBlend(i);if(B==L.ColorBlend_None||I==ee.AlphaBlend_None||B==L.ColorBlend_Normal&&I==ee.AlphaBlend_Over)d=this._shaderSets.at(1+u),s=this.gl.ONE,r=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ONE,o=this.gl.ONE_MINUS_SRC_ALPHA;else switch(B){case L.ColorBlend_AddCompatible:d=this._shaderSets.at(4+u),s=this.gl.ONE,r=this.gl.ONE,n=this.gl.ZERO,o=this.gl.ONE;break;case L.ColorBlend_MultiplyCompatible:d=this._shaderSets.at(7+u),s=this.gl.DST_COLOR,r=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ZERO,o=this.gl.ONE;break;default:{const O=e._currentOffscreen!=null?e._currentOffscreen:e.getModelRenderTarget(0);ae.copyBuffer(this.gl,O,e.getModelRenderTarget(1));const ce=this._blendShaderSetMap.getValue(this._colorBlendMap.getValue(B)+this._alphaBlendMap.getValue(I));d=this._shaderSets.at(ce+u),s=this.gl.ONE,r=this.gl.ZERO,n=this.gl.ONE,o=this.gl.ZERO,_=!1}break}}else switch(t.getDrawableBlendMode(i)){case ne.CubismBlendMode_Normal:default:d=this._shaderSets.at(1+u),s=this.gl.ONE,r=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ONE,o=this.gl.ONE_MINUS_SRC_ALPHA;break;case ne.CubismBlendMode_Additive:d=this._shaderSets.at(4+u),s=this.gl.ONE,r=this.gl.ONE,n=this.gl.ZERO,o=this.gl.ONE;break;case ne.CubismBlendMode_Multiplicative:d=this._shaderSets.at(7+u),s=this.gl.DST_COLOR,r=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ZERO,o=this.gl.ONE;break}this.gl.useProgram(d.shaderProgram),e._bufferData.vertex==null&&(e._bufferData.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.vertex);const g=t.getDrawableVertices(i);this.gl.bufferData(this.gl.ARRAY_BUFFER,g,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(d.attributePositionLocation),this.gl.vertexAttribPointer(d.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),e._bufferData.uv==null&&(e._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.uv);const c=t.getDrawableVertexUvs(i);if(this.gl.bufferData(this.gl.ARRAY_BUFFER,c,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(d.attributeTexCoordLocation),this.gl.vertexAttribPointer(d.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),l){this.gl.activeTexture(this.gl.TEXTURE1);const B=e.getDrawableMaskBuffer(e.getClippingContextBufferForDrawable()._bufferIndex).getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,B),this.gl.uniform1i(d.samplerTexture1Location,1),this.gl.uniformMatrix4fv(d.uniformClipMatrixLocation,!1,e.getClippingContextBufferForDrawable()._matrixForDraw.getArray());const I=e.getClippingContextBufferForDrawable()._layoutChannelIndex,O=e.getClippingContextBufferForDrawable().getClippingManager().getChannelFlagAsColor(I);this.gl.uniform4f(d.uniformChannelFlagLocation,O.r,O.g,O.b,O.a),t.isBlendModeEnabled()&&this.gl.uniform1f(d.uniformInvertMaskFlagLocation,h?1:0)}const p=t.getDrawableTextureIndex(i),f=e.getBindedTextures().getValue(p);this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,f),this.gl.uniform1i(d.samplerTexture0Location,0);const x=e.getMvpMatrix();this.gl.uniformMatrix4fv(d.uniformMatrixLocation,!1,x.getArray());let P=null;if(t.isBlendModeEnabled()){const B=t.getDrawableOpacity(i);P=new D(B,B,B,B)}else P=e.getModelColorWithOpacity(t.getDrawableOpacity(i));const m=t.getMultiplyColor(i),y=t.getScreenColor(i);if(this.gl.uniform4f(d.uniformBaseColorLocation,P.r,P.g,P.b,P.a),this.gl.uniform4f(d.uniformMultiplyColorLocation,m.r,m.g,m.b,m.a),this.gl.uniform4f(d.uniformScreenColorLocation,y.r,y.g,y.b,y.a),t.isBlendModeEnabled()&&(this.gl.activeTexture(this.gl.TEXTURE2),!_)){const B=e.getModelRenderTarget(1).getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,B),this.gl.uniform1i(d.samplerFrameBufferTextureLocation,2)}e._bufferData.index==null&&(e._bufferData.index=this.gl.createBuffer());const v=t.getDrawableVertexIndices(i);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e._bufferData.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,v,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(s,r,n,o)}setupShaderProgramForOffscreen(e,t,i){if(e.isPremultipliedAlpha()||w("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()===0&&this.generateShaders(),this._isShaderLoaded==!1){F("Shader program is not initialized.");return}let s,r,n,o;const l=i.getOffscreenIndex(),h=e.getClippingContextBufferForOffscreen()!=null,u=t.getOffscreenInvertedMask(l),d=h?u?2:1:0;let _,g=!0;const c=t.getOffscreenColorBlend(l),p=t.getOffscreenAlphaBlend(l);if(c==L.ColorBlend_None||p==ee.AlphaBlend_None||c==L.ColorBlend_Normal&&p==ee.AlphaBlend_Over)_=this._shaderSets.at(1+d),s=this.gl.ONE,r=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ONE,o=this.gl.ONE_MINUS_SRC_ALPHA;else switch(c){case L.ColorBlend_AddCompatible:_=this._shaderSets.at(4+d),s=this.gl.ONE,r=this.gl.ONE,n=this.gl.ZERO,o=this.gl.ONE;break;case L.ColorBlend_MultiplyCompatible:_=this._shaderSets.at(7+d),s=this.gl.DST_COLOR,r=this.gl.ONE_MINUS_SRC_ALPHA,n=this.gl.ZERO,o=this.gl.ONE;break;default:{const B=i.getOldOffscreen()!=null?i.getOldOffscreen():e.getModelRenderTarget(0);ae.copyBuffer(this.gl,B,e.getModelRenderTarget(1));const I=this._blendShaderSetMap.getValue(this._colorBlendMap.getValue(c)+this._alphaBlendMap.getValue(p));_=this._shaderSets.at(I+d),s=this.gl.ONE,r=this.gl.ZERO,n=this.gl.ONE,o=this.gl.ZERO,g=!1}break}this.gl.useProgram(_.shaderProgram),ae.copyBuffer(this.gl,i,e.getModelRenderTarget(2)),this.gl.activeTexture(this.gl.TEXTURE0);const f=e.getModelRenderTarget(2).getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,f),this.gl.uniform1i(_.samplerTexture0Location,0);const x=new E;x.loadIdentity(),this.gl.uniformMatrix4fv(_.uniformMatrixLocation,!1,x.getArray());const P=t.getOffscreenOpacity(l),m=new D(P,P,P,P),y=t.getMultiplyColorOffscreen(l),v=t.getScreenColorOffscreen(l);if(this.gl.uniform4f(_.uniformBaseColorLocation,m.r,m.g,m.b,m.a),this.gl.uniform4f(_.uniformMultiplyColorLocation,y.r,y.g,y.b,y.a),this.gl.uniform4f(_.uniformScreenColorLocation,v.r,v.g,v.b,v.a),this.gl.activeTexture(this.gl.TEXTURE2),!g){const B=e.getModelRenderTarget(1).getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,B),this.gl.uniform1i(_.samplerFrameBufferTextureLocation,2)}if(h){this.gl.activeTexture(this.gl.TEXTURE1);const B=e.getOffscreenMaskBuffer(e.getClippingContextBufferForOffscreen()._bufferIndex).getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,B),this.gl.uniform1i(_.samplerTexture1Location,1),this.gl.uniformMatrix4fv(_.uniformClipMatrixLocation,!1,e.getClippingContextBufferForOffscreen()._matrixForDraw.getArray());const I=e.getClippingContextBufferForOffscreen()._layoutChannelIndex,O=e.getClippingContextBufferForOffscreen().getClippingManager().getChannelFlagAsColor(I);this.gl.uniform4f(_.uniformChannelFlagLocation,O.r,O.g,O.b,O.a),t.isBlendModeEnabled()&&this.gl.uniform1f(_.uniformInvertMaskFlagLocation,u?1:0)}e._bufferData.vertex||(e._bufferData.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,Yi,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(_.attributePositionLocation),this.gl.vertexAttribPointer(_.attributePositionLocation,2,this.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),e._bufferData.uv||(e._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,Ea,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(_.attributeTexCoordLocation),this.gl.vertexAttribPointer(_.attributeTexCoordLocation,2,this.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),this.gl.blendFuncSeparate(s,r,n,o)}setupShaderProgramForMask(e,t,i){e.isPremultipliedAlpha()||w("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()==0&&this.generateShaders();const s=this._shaderSets.at(0);this.gl.useProgram(s.shaderProgram),e._bufferData.vertex==null&&(e._bufferData.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.vertex);const r=t.getDrawableVertices(i);this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(s.attributePositionLocation),this.gl.vertexAttribPointer(s.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),e._bufferData.uv==null&&(e._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.uv);const n=t.getDrawableTextureIndex(i),o=e.getBindedTextures().getValue(n);this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,o),this.gl.uniform1i(s.samplerTexture0Location,0),e._bufferData.uv==null&&(e._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.uv);const l=t.getDrawableVertexUvs(i);this.gl.bufferData(this.gl.ARRAY_BUFFER,l,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(s.attributeTexCoordLocation),this.gl.vertexAttribPointer(s.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0);const h=e.getClippingContextBufferForMask()._layoutChannelIndex,u=e.getClippingContextBufferForMask().getClippingManager().getChannelFlagAsColor(h);this.gl.uniform4f(s.uniformChannelFlagLocation,u.r,u.g,u.b,u.a),this.gl.uniformMatrix4fv(s.uniformClipMatrixLocation,!1,e.getClippingContextBufferForMask()._matrixForMask.getArray());const d=e.getClippingContextBufferForMask()._layoutBounds;this.gl.uniform4f(s.uniformBaseColorLocation,d.x*2-1,d.y*2-1,d.getRight()*2-1,d.getBottom()*2-1);const _=t.getMultiplyColor(i),g=t.getScreenColor(i);this.gl.uniform4f(s.uniformMultiplyColorLocation,_.r,_.g,_.b,_.a),this.gl.uniform4f(s.uniformScreenColorLocation,g.r,g.g,g.b,g.a);const c=this.gl.ZERO,p=this.gl.ONE_MINUS_SRC_COLOR,f=this.gl.ZERO,x=this.gl.ONE_MINUS_SRC_ALPHA;e._bufferData.index==null&&(e._bufferData.index=this.gl.createBuffer());const P=t.getDrawableVertexIndices(i);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e._bufferData.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,P,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(c,p,f,x)}setupShaderProgramForOffscreenRenderTarget(e){if(this._shaderSets.getSize()===0&&this.generateShaders(),this._isShaderLoaded==!1){F("Shader program is not initialized.");return}const t=e.getModelColor();t.r*=t.a,t.g*=t.a,t.b*=t.a,this.copyTexture(e,t)}copyTexture(e,t){const i=this.gl.ONE,s=this.gl.ONE_MINUS_SRC_ALPHA,r=this.gl.ONE,n=this.gl.ONE_MINUS_SRC_ALPHA,o=this._shaderSets.at(10);this.gl.useProgram(o.shaderProgram),this.gl.uniform4f(o.uniformBaseColorLocation,t.r,t.g,t.b,t.a),this.gl.activeTexture(this.gl.TEXTURE0);const l=e.getModelRenderTarget(0).getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,l),this.gl.uniform1i(o.samplerTexture0Location,0),e._bufferData.vertex||(e._bufferData.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,Yi,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(o.attributePositionLocation),this.gl.vertexAttribPointer(o.attributePositionLocation,2,this.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),e._bufferData.uv||(e._bufferData.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e._bufferData.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,Oa,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(o.attributeTexCoordLocation),this.gl.vertexAttribPointer(o.attributeTexCoordLocation,2,this.gl.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),this.gl.blendFuncSeparate(i,s,r,n)}releaseShaderProgram(){for(let e=0;e<this._shaderSets.getSize();e++)this.gl.deleteProgram(this._shaderSets.at(e).shaderProgram),this._shaderSets.at(e).shaderProgram=0,this._shaderSets.set(e,void 0),this._shaderSets.set(e,null)}generateShaders(){this._isShaderLoaded=!1;for(let e=0;e<this._shaderCount;e++)this._shaderSets.pushBack(new Es);this._shaderSets.at(0).shaderProgram=this.loadShaderProgram(Da,La),this._shaderSets.at(1).shaderProgram=this.loadShaderProgram(Aa,ka),this._shaderSets.at(2).shaderProgram=this.loadShaderProgram(Hi,Na),this._shaderSets.at(3).shaderProgram=this.loadShaderProgram(Hi,Ua),this._shaderSets.at(4).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(5).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(6).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(7).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(8).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(9).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(0).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_position"),this._shaderSets.at(0).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_texCoord"),this._shaderSets.at(0).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"s_texture0"),this._shaderSets.at(0).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_clipMatrix"),this._shaderSets.at(0).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_channelFlag"),this._shaderSets.at(0).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_baseColor"),this._shaderSets.at(0).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_multiplyColor"),this._shaderSets.at(0).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_screenColor"),this._shaderSets.at(1).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_position"),this._shaderSets.at(1).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_texCoord"),this._shaderSets.at(1).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"s_texture0"),this._shaderSets.at(1).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_matrix"),this._shaderSets.at(1).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_baseColor"),this._shaderSets.at(1).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_multiplyColor"),this._shaderSets.at(1).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_screenColor"),this._shaderSets.at(2).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_position"),this._shaderSets.at(2).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_texCoord"),this._shaderSets.at(2).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture0"),this._shaderSets.at(2).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture1"),this._shaderSets.at(2).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_matrix"),this._shaderSets.at(2).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_clipMatrix"),this._shaderSets.at(2).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_channelFlag"),this._shaderSets.at(2).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_baseColor"),this._shaderSets.at(2).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_multiplyColor"),this._shaderSets.at(2).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_screenColor"),this._shaderSets.at(3).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_position"),this._shaderSets.at(3).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_texCoord"),this._shaderSets.at(3).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture0"),this._shaderSets.at(3).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture1"),this._shaderSets.at(3).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_matrix"),this._shaderSets.at(3).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_clipMatrix"),this._shaderSets.at(3).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_channelFlag"),this._shaderSets.at(3).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_baseColor"),this._shaderSets.at(3).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_multiplyColor"),this._shaderSets.at(3).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_screenColor"),this._shaderSets.at(4).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_position"),this._shaderSets.at(4).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_texCoord"),this._shaderSets.at(4).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"s_texture0"),this._shaderSets.at(4).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_matrix"),this._shaderSets.at(4).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_baseColor"),this._shaderSets.at(4).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_multiplyColor"),this._shaderSets.at(4).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_screenColor"),this._shaderSets.at(5).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_position"),this._shaderSets.at(5).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_texCoord"),this._shaderSets.at(5).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture0"),this._shaderSets.at(5).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture1"),this._shaderSets.at(5).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_matrix"),this._shaderSets.at(5).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_clipMatrix"),this._shaderSets.at(5).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_channelFlag"),this._shaderSets.at(5).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_baseColor"),this._shaderSets.at(5).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_multiplyColor"),this._shaderSets.at(5).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_screenColor"),this._shaderSets.at(6).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_position"),this._shaderSets.at(6).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_texCoord"),this._shaderSets.at(6).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture0"),this._shaderSets.at(6).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture1"),this._shaderSets.at(6).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_matrix"),this._shaderSets.at(6).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_clipMatrix"),this._shaderSets.at(6).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_channelFlag"),this._shaderSets.at(6).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_baseColor"),this._shaderSets.at(6).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_multiplyColor"),this._shaderSets.at(6).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_screenColor"),this._shaderSets.at(7).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_position"),this._shaderSets.at(7).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_texCoord"),this._shaderSets.at(7).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"s_texture0"),this._shaderSets.at(7).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_matrix"),this._shaderSets.at(7).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_baseColor"),this._shaderSets.at(7).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_multiplyColor"),this._shaderSets.at(7).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_screenColor"),this._shaderSets.at(8).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_position"),this._shaderSets.at(8).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_texCoord"),this._shaderSets.at(8).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture0"),this._shaderSets.at(8).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture1"),this._shaderSets.at(8).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_matrix"),this._shaderSets.at(8).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_clipMatrix"),this._shaderSets.at(8).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_channelFlag"),this._shaderSets.at(8).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_baseColor"),this._shaderSets.at(8).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_multiplyColor"),this._shaderSets.at(8).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_screenColor"),this._shaderSets.at(9).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_position"),this._shaderSets.at(9).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_texCoord"),this._shaderSets.at(9).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture0"),this._shaderSets.at(9).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture1"),this._shaderSets.at(9).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_matrix"),this._shaderSets.at(9).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_clipMatrix"),this._shaderSets.at(9).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_channelFlag"),this._shaderSets.at(9).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_baseColor"),this._shaderSets.at(9).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_multiplyColor"),this._shaderSets.at(9).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_screenColor"),this.loadBlendModeShaders().then(()=>{this.registerBlendShader(),this._isShaderLoaded=!0}).catch(e=>{console.error("Failed to load blend mode shaders:",e)})}registerBlendShader(){const e=this._vertShaderSrcCopy,t=this._fragShaderSrcCopy,i=this._shaderSets.at(10);i.shaderProgram=this.loadShaderProgram(e,t),i.attributeTexCoordLocation=this.gl.getAttribLocation(i.shaderProgram,"a_texCoord"),i.attributePositionLocation=this.gl.getAttribLocation(i.shaderProgram,"a_position"),i.uniformBaseColorLocation=this.gl.getUniformLocation(i.shaderProgram,"u_baseColor");let s=11;for(let r=0;r<this._colorBlendValues.getSize();r++){if(this._colorBlendValues.at(r)==L.ColorBlend_None||this._colorBlendValues.at(r)==L.ColorBlend_AddCompatible||this._colorBlendValues.at(r)==L.ColorBlend_MultiplyCompatible)continue;const n=this._colorBlendValues.at(r),l=`#define COLOR_BLEND_${this._colorBlendMap.getValue(n).toUpperCase()}
`;for(let h=0;h<this._alphaBlendValues.getSize();h++){if(this._alphaBlendValues.at(h)==ee.AlphaBlend_None||this._colorBlendValues.at(r)==L.ColorBlend_Normal&&this._alphaBlendValues.at(h)==ee.AlphaBlend_Over)continue;const u=this._alphaBlendValues.at(h),_=`#define ALPHA_BLEND_${this._alphaBlendMap.getValue(u).toUpperCase()}
`;this.generateBlendShader(l,_,s),this._blendShaderSetMap.setValue(this._colorBlendMap.getValue(this._colorBlendValues.at(r))+this._alphaBlendMap.getValue(this._alphaBlendValues.at(h)),s),s+=3}}}generateBlendShader(e,t,i){for(let s=0;s<3;s++){let r="",n=`precision mediump float;
`;const o=i+s;if(n+=e,n+=t,n+=this._fragShaderSrcColorBlend,n+=this._fragShaderSrcAlphaBlend,s==1||s==2){const l=`#define CLIPPING_MASK
`;r+=l,n+=l}r+=this._vertShaderSrcBlend,n+=this._fragShaderSrcBlend,this._shaderSets.at(o).shaderProgram=this.loadShaderProgram(r,n),this._shaderSets.at(o).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(o).shaderProgram,"a_position"),this._shaderSets.at(o).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(o).shaderProgram,"a_texCoord"),this._shaderSets.at(o).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"s_texture0"),this._shaderSets.at(o).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_matrix"),this._shaderSets.at(o).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_baseColor"),this._shaderSets.at(o).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_multiplyColor"),this._shaderSets.at(o).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_screenColor"),this._shaderSets.at(o).samplerFrameBufferTextureLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"s_blendTexture"),(s==1||s==2)&&(this._shaderSets.at(o).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"s_texture1"),this._shaderSets.at(o).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_clipMatrix"),this._shaderSets.at(o).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_channelFlag"),this._shaderSets.at(o).uniformInvertMaskFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(o).shaderProgram,"u_invertClippingMask"))}}loadShaderProgram(e,t){let i=this.gl.createProgram(),s=this.compileShaderSource(this.gl.VERTEX_SHADER,e);if(!s)return w("Vertex shader compile error!"),0;let r=this.compileShaderSource(this.gl.FRAGMENT_SHADER,t);return r?(this.gl.attachShader(i,s),this.gl.attachShader(i,r),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?(this.gl.deleteShader(s),this.gl.deleteShader(r),i):(w("Failed to link program: {0}",i),this.gl.deleteShader(s),s=0,this.gl.deleteShader(r),r=0,i&&(this.gl.deleteProgram(i),i=0),0)):(w("Fragment shader compile error!"),0)}compileShaderSource(e,t){const i=t,s=this.gl.createShader(e);if(this.gl.shaderSource(s,i),this.gl.compileShader(s),!s){const n=this.gl.getShaderInfoLog(s);w("Shader compile log: {0} ",n)}if(!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const n=this.gl.getShaderInfoLog(s);return w("Shader compile log: {0} ",n),this.gl.deleteShader(s),null}return s}setGl(e){this.gl=e}}class j{static getInstance(){return me==null&&(me=new j),me}static deleteInstance(){me&&(me.release(),me=null)}constructor(){this._shaderMap=new N}release(){for(const e=this._shaderMap.begin();e.notEqual(this._shaderMap.end());e.preIncrement())e.ptr().second.release();this._shaderMap.clear()}getShader(e){return this._shaderMap.getValue(e)}setGlContext(e){if(!this._shaderMap.isExist(e)){const t=new Os;t.setGl(e),this._shaderMap.setValue(e,t)}}}class Es{}var Ds=(a=>(a[a.ShaderNames_SetupMask=0]="ShaderNames_SetupMask",a[a.ShaderNames_NormalPremultipliedAlpha=1]="ShaderNames_NormalPremultipliedAlpha",a[a.ShaderNames_NormalMaskedPremultipliedAlpha=2]="ShaderNames_NormalMaskedPremultipliedAlpha",a[a.ShaderNames_NomralMaskedInvertedPremultipliedAlpha=3]="ShaderNames_NomralMaskedInvertedPremultipliedAlpha",a[a.ShaderNames_AddPremultipliedAlpha=4]="ShaderNames_AddPremultipliedAlpha",a[a.ShaderNames_AddMaskedPremultipliedAlpha=5]="ShaderNames_AddMaskedPremultipliedAlpha",a[a.ShaderNames_AddMaskedPremultipliedAlphaInverted=6]="ShaderNames_AddMaskedPremultipliedAlphaInverted",a[a.ShaderNames_MultPremultipliedAlpha=7]="ShaderNames_MultPremultipliedAlpha",a[a.ShaderNames_MultMaskedPremultipliedAlpha=8]="ShaderNames_MultMaskedPremultipliedAlpha",a[a.ShaderNames_MultMaskedPremultipliedAlphaInverted=9]="ShaderNames_MultMaskedPremultipliedAlphaInverted",a[a.ShaderNames_ShaderCount=10]="ShaderNames_ShaderCount",a))(Ds||{});const Da="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_myPos;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_clipMatrix * a_position;   v_myPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",La="precision mediump float;varying vec2       v_texCoord;varying vec4       v_myPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;void main(){   float isInside =        step(u_baseColor.x, v_myPos.x/v_myPos.w)       * step(u_baseColor.y, v_myPos.y/v_myPos.w)       * step(v_myPos.x/v_myPos.w, u_baseColor.z)       * step(v_myPos.y/v_myPos.w, u_baseColor.w);   gl_FragColor = u_channelFlag * texture2D(s_texture0, v_texCoord).a * isInside;}",Aa="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;uniform mat4       u_matrix;void main(){   gl_Position = u_matrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Hi="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform mat4       u_matrix;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_matrix * a_position;   v_clipPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",ka="precision mediump float;varying vec2       v_texCoord;uniform vec4       u_baseColor;uniform sampler2D  s_texture0;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 color = texColor * u_baseColor;   gl_FragColor = vec4(color.rgb, color.a);}",Na="precision mediump float;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;uniform sampler2D  s_texture1;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * maskVal;   gl_FragColor = col_formask;}",Ua="precision mediump float;varying vec2      v_texCoord;varying vec4      v_clipPos;uniform sampler2D s_texture0;uniform sampler2D s_texture1;uniform vec4      u_channelFlag;uniform vec4      u_baseColor;uniform vec4      u_multiplyColor;uniform vec4      u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * (1.0 - maskVal);   gl_FragColor = col_formask;}";var Wi;(a=>{a.CubismShaderSet=Es,a.CubismShader_WebGL=Os,a.CubismShaderManager_WebGL=j,a.ShaderNames=Ds})(Wi||(Wi={}));const tt=-1,it=new Uint16Array([0,1,2,2,1,3]);class rt extends va{setGL(e){this.gl=e}constructor(){super(Ls)}setupClippingContext(e,t,i,s,r){let n=0;for(let o=0;o<this._clippingContextListForMask.getSize();o++){const l=this._clippingContextListForMask.at(o);switch(r){case A.DrawableObjectType_Drawable:default:this.calcClippedDrawableTotalBounds(e,l);break;case A.DrawableObjectType_Offscreen:this.calcClippedOffscreenTotalBounds(e,l);break}l._isUsing&&n++}if(!(n<=0)){switch(this.gl.viewport(0,0,this._clippingMaskBufferSize,this._clippingMaskBufferSize),r){case A.DrawableObjectType_Drawable:default:this._currentMaskBuffer=t.getDrawableMaskBuffer(0);break;case A.DrawableObjectType_Offscreen:this._currentMaskBuffer=t.getOffscreenMaskBuffer(0);break}this._currentMaskBuffer.beginDraw(i),t.preDraw(),this.setupLayoutBounds(n),this._clearedMaskBufferFlags.getSize()!=this._renderTextureCount&&(this._clearedMaskBufferFlags.clear(),this._clearedMaskBufferFlags=new C(this._renderTextureCount));for(let o=0;o<this._clearedMaskBufferFlags.getSize();o++)this._clearedMaskBufferFlags.set(o,!1);for(let o=0;o<this._clippingContextListForMask.getSize();o++){const l=this._clippingContextListForMask.at(o),h=l._allClippedDrawRect,u=l._layoutBounds,d=.05;let _=0,g=0,c;switch(r){case A.DrawableObjectType_Drawable:default:c=t.getDrawableMaskBuffer(l._bufferIndex);break;case A.DrawableObjectType_Offscreen:c=t.getOffscreenMaskBuffer(l._bufferIndex);break}if(this._currentMaskBuffer!=c&&(this._currentMaskBuffer.endDraw(),this._currentMaskBuffer=c,this._currentMaskBuffer.beginDraw(i),t.preDraw()),this._tmpBoundsOnModel.setRect(h),this._tmpBoundsOnModel.expand(h.width*d,h.height*d),_=u.width/this._tmpBoundsOnModel.width,g=u.height/this._tmpBoundsOnModel.height,this.createMatrixForMask(!1,u,_,g),l._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),l._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray()),r==A.DrawableObjectType_Offscreen){const f=t.getMvpMatrix().getInvert();l._matrixForDraw.multiplyByMatrix(f)}const p=l._clippingIdCount;for(let f=0;f<p;f++){const x=l._clippingIdList[f];e.getDrawableDynamicFlagVertexPositionsDidChange(x)&&(t.setIsCulling(e.getDrawableCulling(x)!=!1),this._clearedMaskBufferFlags.at(l._bufferIndex)||(this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this._clearedMaskBufferFlags.set(l._bufferIndex,!0)),t.setClippingContextBufferForMask(l),t.drawMeshWebGL(e,x))}}this._currentMaskBuffer.endDraw(),t.setClippingContextBufferForMask(null),this.gl.viewport(s[0],s[1],s[2],s[3])}}getClippingMaskCount(){return this._clippingContextListForMask.getSize()}}class Ls extends Xs{constructor(e,t,i){super(t,i),this._owner=e}getClippingManager(){return this._owner}setGl(e){this._owner.setGL(e)}}class za{setGlEnable(e,t){t?this.gl.enable(e):this.gl.disable(e)}setGlEnableVertexAttribArray(e,t){t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e)}save(){if(this.gl==null){w(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._lastArrayBufferBinding=this.gl.getParameter(this.gl.ARRAY_BUFFER_BINDING),this._lastElementArrayBufferBinding=this.gl.getParameter(this.gl.ELEMENT_ARRAY_BUFFER_BINDING),this._lastProgram=this.gl.getParameter(this.gl.CURRENT_PROGRAM),this._lastActiveTexture=this.gl.getParameter(this.gl.ACTIVE_TEXTURE),this.gl.activeTexture(this.gl.TEXTURE1),this._lastTexture1Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this.gl.activeTexture(this.gl.TEXTURE0),this._lastTexture0Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this._lastVertexAttribArrayEnabled[0]=this.gl.getVertexAttrib(0,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[1]=this.gl.getVertexAttrib(1,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[2]=this.gl.getVertexAttrib(2,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[3]=this.gl.getVertexAttrib(3,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastScissorTest=this.gl.isEnabled(this.gl.SCISSOR_TEST),this._lastStencilTest=this.gl.isEnabled(this.gl.STENCIL_TEST),this._lastDepthTest=this.gl.isEnabled(this.gl.DEPTH_TEST),this._lastCullFace=this.gl.isEnabled(this.gl.CULL_FACE),this._lastBlend=this.gl.isEnabled(this.gl.BLEND),this._lastFrontFace=this.gl.getParameter(this.gl.FRONT_FACE),this._lastColorMask=this.gl.getParameter(this.gl.COLOR_WRITEMASK),this._lastBlending[0]=this.gl.getParameter(this.gl.BLEND_SRC_RGB),this._lastBlending[1]=this.gl.getParameter(this.gl.BLEND_DST_RGB),this._lastBlending[2]=this.gl.getParameter(this.gl.BLEND_SRC_ALPHA),this._lastBlending[3]=this.gl.getParameter(this.gl.BLEND_DST_ALPHA)}restore(){if(this.gl==null){w(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this.gl.useProgram(this._lastProgram),this.setGlEnableVertexAttribArray(0,this._lastVertexAttribArrayEnabled[0]),this.setGlEnableVertexAttribArray(1,this._lastVertexAttribArrayEnabled[1]),this.setGlEnableVertexAttribArray(2,this._lastVertexAttribArrayEnabled[2]),this.setGlEnableVertexAttribArray(3,this._lastVertexAttribArrayEnabled[3]),this.setGlEnable(this.gl.SCISSOR_TEST,this._lastScissorTest),this.setGlEnable(this.gl.STENCIL_TEST,this._lastStencilTest),this.setGlEnable(this.gl.DEPTH_TEST,this._lastDepthTest),this.setGlEnable(this.gl.CULL_FACE,this._lastCullFace),this.setGlEnable(this.gl.BLEND,this._lastBlend),this.gl.frontFace(this._lastFrontFace),this.gl.colorMask(this._lastColorMask[0],this._lastColorMask[1],this._lastColorMask[2],this._lastColorMask[3]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._lastArrayBufferBinding),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._lastElementArrayBufferBinding),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture1Binding2D),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture0Binding2D),this.gl.activeTexture(this._lastActiveTexture),this.gl.blendFuncSeparate(this._lastBlending[0],this._lastBlending[1],this._lastBlending[2],this._lastBlending[3])}setGl(e){this.gl=e}constructor(){this._lastVertexAttribArrayEnabled=new Array(4),this._lastColorMask=new Array(4),this._lastBlending=new Array(4)}}class It extends ut{initialize(e,t=1){e.isUsingMasking()&&(this._drawableClippingManager=new rt,this._drawableClippingManager.initializeForDrawable(e,t)),e.isUsingMaskingForOffscreen()&&(this._offscreenClippingManager=new rt,this._offscreenClippingManager.initializeForOffscreen(e,t)),this._sortedObjectsIndexList.resize(e.getDrawableCount()+(e.getOffscreenCount?e.getOffscreenCount():0),0),this._sortedObjectsTypeList.resize(e.getDrawableCount()+(e.getOffscreenCount?e.getOffscreenCount():0),0),super.initialize(e)}setupParentOffscreens(e,t){let i;for(let s=0;s<t;++s){i=null;const r=e.getOffscreenOwnerIndices()[s];let n=e.getPartParentPartIndices()[r];for(;n!=be;){for(let o=0;o<t;++o)if(e.getOffscreenOwnerIndices()[this._offscreenList.at(o).getOffscreenIndex()]==n){i=this._offscreenList.at(o);break}if(i!=null)break;n=e.getPartParentPartIndices()[n]}this._offscreenList.at(s).setParentPartOffscreen(i)}}bindTexture(e,t){this._textures.setValue(e,t)}getBindedTextures(){return this._textures}setClippingMaskBufferSize(e){if(!this._model.isUsingMasking())return;const t=this._drawableClippingManager.getRenderTextureCount();this._drawableClippingManager.release(),this._drawableClippingManager=void 0,this._drawableClippingManager=null,this._drawableClippingManager=new rt,this._drawableClippingManager.setClippingMaskBufferSize(e),this._drawableClippingManager.initializeForDrawable(this.getModel(),t)}getClippingMaskBufferSize(){return this._model.isUsingMasking()?this._drawableClippingManager.getClippingMaskBufferSize():tt}getModelRenderTarget(e){return this._modelRenderTargets.at(e)}getRenderTextureCount(){return this._model.isUsingMasking()?this._drawableClippingManager.getRenderTextureCount():tt}constructor(e,t){super(e,t),this._clippingContextBufferForMask=null,this._clippingContextBufferForDraw=null,this._rendererProfile=new za,this._firstDraw=!0,this._textures=new N,this._sortedObjectsIndexList=new C,this._sortedObjectsTypeList=new C,this._bufferData={vertex:WebGLBuffer=null,uv:WebGLBuffer=null,index:WebGLBuffer=null},this._modelRenderTargets=new C,this._drawableMasks=new C,this._currentFbo=null,this._drawableClippingManager=null,this._offscreenClippingManager=null,this._offscreenMasks=new C,this._offscreenList=new C,this._textures.prepareCapacity(32,!0)}release(){if(this._drawableClippingManager&&(this._drawableClippingManager.release(),this._drawableClippingManager=void 0,this._drawableClippingManager=null),this.gl!=null){this.gl.deleteBuffer(this._bufferData.vertex),this._bufferData.vertex=null,this.gl.deleteBuffer(this._bufferData.uv),this._bufferData.uv=null,this.gl.deleteBuffer(this._bufferData.index),this._bufferData.index=null,this._bufferData=null,this._textures=null;for(let e=0;e<this._modelRenderTargets.getSize();e++)this._modelRenderTargets.at(e)!=null&&this._modelRenderTargets.at(e).isValid()&&this._modelRenderTargets.at(e).destroyRenderTarget();this._modelRenderTargets.clear(),this._modelRenderTargets=null;for(let e=0;e<this._drawableMasks.getSize();e++)this._drawableMasks.at(e)!=null&&this._drawableMasks.at(e).isValid()&&this._drawableMasks.at(e).destroyRenderTarget();this._drawableMasks.clear(),this._drawableMasks=null;for(let e=0;e<this._offscreenMasks.getSize();e++)this._offscreenMasks.at(e)!=null&&this._offscreenMasks.at(e).isValid()&&this._offscreenMasks.at(e).destroyRenderTarget();this._offscreenMasks.clear(),this._offscreenMasks=null;for(let e=0;e<this._offscreenList.getSize();e++)this._offscreenList.at(e)!=null&&this._offscreenList.at(e).isValid()&&this._offscreenList.at(e).destroyRenderTarget();this._offscreenList.clear(),this._offscreenList=null,this._offscreenClippingManager=null,this._drawableClippingManager=null,this._clippingContextBufferForMask=null,this._clippingContextBufferForDraw=null,this._rendererProfile=null,this._sortedObjectsIndexList=null,this._sortedObjectsTypeList=null,this._currentFbo=null,this._model=null,this.gl=null,this._firstDraw=!0}}doDrawModel(){if(this.gl==null){w(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}if(j.getInstance().getShader(this.gl)._shaderSets.getSize()==0||this._model.isBlendModeEnabled()&&!j.getInstance().getShader(this.gl)._isShaderLoaded){j.getInstance().getShader(this.gl).generateShaders();return}const e=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING),t=this.gl.getParameter(this.gl.VIEWPORT);if(this.beforeDrawModelRenderTarget(),this._drawableClippingManager!=null){this.preDraw();for(let i=0;i<this._drawableClippingManager.getRenderTextureCount();++i)(this._drawableMasks.at(i).getBufferWidth()!=this._drawableClippingManager.getClippingMaskBufferSize()||this._drawableMasks.at(i).getBufferHeight()!=this._drawableClippingManager.getClippingMaskBufferSize())&&this._drawableMasks.at(i).createOffscreenRenderTarget(this.gl,this._drawableClippingManager.getClippingMaskBufferSize(),this._drawableClippingManager.getClippingMaskBufferSize(),e);this.isUsingHighPrecisionMask()?this._drawableClippingManager.setupMatrixForHighPrecision(this.getModel(),!1):this._drawableClippingManager.setupClippingContext(this.getModel(),this,e,t,A.DrawableObjectType_Drawable)}if(this._offscreenClippingManager!=null){this.preDraw();for(let i=0;i<this._offscreenClippingManager.getRenderTextureCount();++i)(this._offscreenMasks.at(i).getBufferWidth()!=this._offscreenClippingManager.getClippingMaskBufferSize()||this._offscreenMasks.at(i).getBufferHeight()!=this._offscreenClippingManager.getClippingMaskBufferSize())&&this._offscreenMasks.at(i).createOffscreenRenderTarget(this.gl,this._offscreenClippingManager.getClippingMaskBufferSize(),this._offscreenClippingManager.getClippingMaskBufferSize(),e);this.isUsingHighPrecisionMask()?this._offscreenClippingManager.setupMatrixForOffscreenHighPrecision(this.getModel(),!1,this.getMvpMatrix()):this._offscreenClippingManager.setupClippingContext(this.getModel(),this,e,t,A.DrawableObjectType_Offscreen)}this.preDraw(),this.drawObjectLoop(e),this.afterDrawModelRenderTarget()}drawObjectLoop(e){const t=this.getModel(),i=t.getDrawableCount(),s=t.getOffscreenCount(),r=i+s,n=t.getRenderOrders();this._currentOffscreen=null,this._currentFbo=e,this._modelRootFbo=e;for(let o=0;o<r;++o){const l=n[o];o<i?(this._sortedObjectsIndexList.set(l,o),this._sortedObjectsTypeList.set(l,A.DrawableObjectType_Drawable)):o<r&&(this._sortedObjectsIndexList.set(l,o-i),this._sortedObjectsTypeList.set(l,A.DrawableObjectType_Offscreen))}for(let o=0;o<r;++o){const l=this._sortedObjectsIndexList.at(o),h=this._sortedObjectsTypeList.at(o);this.renderObject(l,h)}for(;this._currentOffscreen!=null;)this.submitDrawToParentOffscreen(this._currentOffscreen.getOffscreenIndex(),A.DrawableObjectType_Offscreen)}renderObject(e,t){switch(t){case A.DrawableObjectType_Drawable:this.drawDrawable(e,this._modelRootFbo);break;case A.DrawableObjectType_Offscreen:this.addOffscreen(e);break;default:w("Unknown object type: "+t);break}}drawDrawable(e,t){if(!this.getModel().getDrawableDynamicFlagIsVisible(e))return;this.submitDrawToParentOffscreen(e,A.DrawableObjectType_Drawable);const i=this._drawableClippingManager!=null?this._drawableClippingManager.getClippingContextListForDraw().at(e):null;if(i!=null&&this.isUsingHighPrecisionMask()){i._isUsing&&(this.gl.viewport(0,0,this._drawableClippingManager.getClippingMaskBufferSize(),this._drawableClippingManager.getClippingMaskBufferSize()),this.preDraw(),this.getDrawableMaskBuffer(i._bufferIndex).beginDraw(this._currentFbo),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT));{const s=i._clippingIdCount;for(let r=0;r<s;r++){const n=i._clippingIdList[r];this._model.getDrawableDynamicFlagVertexPositionsDidChange(n)&&(this.setIsCulling(this._model.getDrawableCulling(n)!=!1),this.setClippingContextBufferForMask(i),this.drawMeshWebGL(this._model,n))}this.getDrawableMaskBuffer(i._bufferIndex).endDraw(),this.setClippingContextBufferForMask(null),this.gl.viewport(0,0,this._modelRenderTargetWidth,this._modelRenderTargetHeight),this.preDraw()}}this.setClippingContextBufferForDrawable(i),this.setIsCulling(this.getModel().getDrawableCulling(e)),this.drawMeshWebGL(this._model,e)}drawMeshWebGL(e,t){if(this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW),this.isGeneratingMask()?j.getInstance().getShader(this.gl).setupShaderProgramForMask(this,e,t):j.getInstance().getShader(this.gl).setupShaderProgramForDrawable(this,e,t),!(!this._model.isBlendModeEnabled()&&!j.getInstance().getShader(this.gl)._isShaderLoaded)){{const i=e.getDrawableVertexIndexCount(t);this.gl.drawElements(this.gl.TRIANGLES,i,this.gl.UNSIGNED_SHORT,0)}this.gl.useProgram(null),this.setClippingContextBufferForDrawable(null),this.setClippingContextBufferForMask(null)}}submitDrawToParentOffscreen(e,t){if(this._currentOffscreen==null||e==tt)return;const i=this.getModel().getOffscreenOwnerIndices()[this._currentOffscreen.getOffscreenIndex()];if(i==tt)return;let s=be;switch(t){case A.DrawableObjectType_Drawable:s=this.getModel().getDrawableParentPartIndex(e);break;case A.DrawableObjectType_Offscreen:s=this.getModel().getPartParentPartIndices()[this.getModel().getOffscreenOwnerIndices()[e]];break;default:return}for(;s!=be;){if(s==i)return;s=this.getModel().getPartParentPartIndices()[s]}this.drawOffscreen(this._currentOffscreen),this.submitDrawToParentOffscreen(e,t)}addOffscreen(e){if(this._currentOffscreen!=null&&this._currentOffscreen.getOffscreenIndex()!=e){let r=!1;const n=this.getModel().getOffscreenOwnerIndices()[e];let o=this.getModel().getPartParentPartIndices()[n];const l=this._currentOffscreen.getOffscreenIndex(),h=this.getModel().getOffscreenOwnerIndices()[l];for(;o!=be;){if(o==h){r=!0;break}o=this.getModel().getPartParentPartIndices()[o]}r||this.submitDrawToParentOffscreen(e,A.DrawableObjectType_Offscreen)}const t=this._offscreenList.at(e);(t.getBufferWidth()!=this._modelRenderTargetWidth||t.getBufferHeight()!=this._modelRenderTargetHeight)&&t.createOffscreenRenderTarget(this.gl,this._modelRenderTargetWidth,this._modelRenderTargetHeight,this._currentFbo);const i=t.getParentPartOffscreen();t.setOldOffscreen(i);let s=null;i!=null&&(s=i.getRenderTexture()),s==null&&(s=this._modelRootFbo),t.beginDraw(s),this.gl.viewport(0,0,this._modelRenderTargetWidth,this._modelRenderTargetHeight),t.clear(0,0,0,0),this._currentOffscreen=t,this._currentFbo=t.getRenderTexture()}drawOffscreen(e){const t=e.getOffscreenIndex(),i=this._offscreenClippingManager!=null?this._offscreenClippingManager.getClippingContextListForOffscreen().at(t):null;if(i!=null&&this.isUsingHighPrecisionMask()){i._isUsing&&(this.gl.viewport(0,0,this._offscreenClippingManager.getClippingMaskBufferSize(),this._offscreenClippingManager.getClippingMaskBufferSize()),this.preDraw(),this.getOffscreenMaskBuffer(i._bufferIndex).beginDraw(this._currentFbo),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT));{const s=i._clippingIdCount;for(let r=0;r<s;r++){const n=i._clippingIdList[r];this.getModel().getDrawableDynamicFlagVertexPositionsDidChange(n)&&(this.setIsCulling(this.getModel().getDrawableCulling(n)!=!1),this.setClippingContextBufferForMask(i),this.drawMeshWebGL(this.getModel(),n))}}this.getOffscreenMaskBuffer(i._bufferIndex).endDraw(),this.setClippingContextBufferForMask(null),this.gl.viewport(0,0,this._modelRenderTargetWidth,this._modelRenderTargetHeight),this.preDraw()}this.setClippingContextBufferForOffscreen(i),this.setIsCulling(this._model.getOffscreenCulling(t)!=!1),this.drawOffscreenWebGL(this.getModel(),e)}drawOffscreenWebGL(e,t){this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW),j.getInstance().getShader(this.gl).setupShaderProgramForOffscreen(this,e,t),t.endDraw(),this._currentOffscreen=this._currentOffscreen.getOldOffscreen(),this._currentFbo=t.getOldFBO(),this._currentFbo==null&&(this._currentOffscreen=this._modelRenderTargets.at(0),this._currentFbo=this._modelRenderTargets.at(0).getRenderTexture(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentFbo));{const i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,it,this.gl.STATIC_DRAW),this.gl.drawElements(this.gl.TRIANGLES,it.length,this.gl.UNSIGNED_SHORT,0),this.gl.deleteBuffer(i)}this.gl.useProgram(null),this.setClippingContextBufferForMask(null),this.setClippingContextBufferForOffscreen(null)}saveProfile(){this._rendererProfile.save()}restoreProfile(){this._rendererProfile.restore()}beforeDrawModelRenderTarget(){if(this._modelRenderTargets.getSize()!=0){for(let e=0;e<this._modelRenderTargets.getSize();++e)(this._modelRenderTargets.at(e).getBufferWidth()!=this._modelRenderTargetWidth||this._modelRenderTargets.at(e).getBufferHeight()!=this._modelRenderTargetHeight)&&this._modelRenderTargets.at(e).createOffscreenRenderTarget(this.gl,this._modelRenderTargetWidth,this._modelRenderTargetHeight,this._currentFbo);this._modelRenderTargets.at(0).beginDraw(),this._modelRenderTargets.at(0).clear(0,0,0,0)}}afterDrawModelRenderTarget(){if(this._modelRenderTargets.getSize()!=0){if(this._modelRenderTargets.at(0).endDraw(),j.getInstance().getShader(this.gl).setupShaderProgramForOffscreenRenderTarget(this),j.getInstance().getShader(this.gl)._isShaderLoaded){const e=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,it,this.gl.STATIC_DRAW),this.gl.drawElements(this.gl.TRIANGLES,it.length,this.gl.UNSIGNED_SHORT,0),this.gl.deleteBuffer(e)}this.gl.useProgram(null)}}getOffscreenMaskBuffer(e){return this._offscreenMasks.at(e)}static doStaticRelease(){j.deleteInstance()}setRenderState(e,t){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.viewport(t[0],t[1],t[2],t[3]),(this._modelRenderTargetWidth!=t[2]||this._modelRenderTargetHeight!=t[3])&&(this._modelRenderTargetWidth=t[2],this._modelRenderTargetHeight=t[3])}preDraw(){if(this._firstDraw&&(this._firstDraw=!1),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.BLEND),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.getAnisotropy()>0&&this._extension)for(let e=0;e<this._textures.getSize();++e)this.gl.bindTexture(this.gl.TEXTURE_2D,this._textures.getValue(e)),this.gl.texParameterf(this.gl.TEXTURE_2D,this._extension.TEXTURE_MAX_ANISOTROPY_EXT,this.getAnisotropy())}getDrawableMaskBuffer(e){return this._drawableMasks.at(e)}setClippingContextBufferForMask(e){this._clippingContextBufferForMask=e}getClippingContextBufferForMask(){return this._clippingContextBufferForMask}setClippingContextBufferForDrawable(e){this._clippingContextBufferForDraw=e}getClippingContextBufferForDrawable(){return this._clippingContextBufferForDraw}setClippingContextBufferForOffscreen(e){this._clippingContextBufferForOffscreen=e}getClippingContextBufferForOffscreen(){return this._clippingContextBufferForOffscreen}isGeneratingMask(){return this.getClippingContextBufferForMask()!=null}startUp(e){if(this.gl=e,this._drawableClippingManager&&this._drawableClippingManager.setGL(e),this._offscreenClippingManager&&this._offscreenClippingManager.setGL(e),j.getInstance().setGlContext(e),this._rendererProfile.setGl(e),this._extension=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._model.isUsingMasking()){this._drawableMasks.clear();for(let t=0;t<this._drawableClippingManager.getRenderTextureCount();++t){const i=new ae;i.createOffscreenRenderTarget(this.gl,this._drawableClippingManager.getClippingMaskBufferSize(),this._drawableClippingManager.getClippingMaskBufferSize(),this._currentFbo),this._drawableMasks.pushBack(i)}}if(this._model.isBlendModeEnabled()){this._modelRenderTargets.clear();const t=3;for(let s=0;s<t;++s){const r=new ae;r.createOffscreenRenderTarget(this.gl,this._modelRenderTargetWidth,this._modelRenderTargetHeight,this._currentFbo),this._modelRenderTargets.pushBack(r)}if(this._model.isUsingMaskingForOffscreen()){this._offscreenMasks.clear();for(let s=0;s<this._offscreenClippingManager.getRenderTextureCount();++s){const r=new ae;r.createOffscreenRenderTarget(this.gl,this._offscreenClippingManager.getClippingMaskBufferSize(),this._offscreenClippingManager.getClippingMaskBufferSize(),this._currentFbo),this._offscreenMasks.pushBack(r)}}const i=this._model.getOffscreenCount();if(i>0){this._offscreenList=new C(i);for(let s=0;s<i;++s){const r=new ae;r.createOffscreenRenderTarget(this.gl,this._modelRenderTargetWidth,this._modelRenderTargetHeight,this._currentFbo),r.setOffscreenIndex(s),this._offscreenList.pushBack(r)}this.setupParentOffscreens(this._model,i)}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentFbo)}}ut.staticRelease=()=>{It.doStaticRelease()};var $i;(a=>{a.CubismClippingContext=Ls,a.CubismClippingManager_WebGL=rt,a.CubismRenderer_WebGL=It})($i||($i={}));class We{static create(e,t){let i=null;if(t&&!this.hasMocConsistency(e))return w("Inconsistent MOC3."),i;const s=Live2DCubismCore.Moc.fromArrayBuffer(e);return s&&(i=new We(s),i._mocVersion=Live2DCubismCore.Version.csmGetMocVersion(s,e)),i}static delete(e){e._moc._release(),e._moc=null,e=null}createModel(){let e=null;const t=Live2DCubismCore.Model.fromMoc(this._moc);return t&&(e=new Vs(t),e.initialize(),++this._modelCount),e}deleteModel(e){e!=null&&(e.release(),e=null,--this._modelCount)}constructor(e){this._moc=e,this._modelCount=0,this._mocVersion=0}release(){G(this._modelCount==0),this._moc._release(),this._moc=null}getLatestMocVersion(){return Live2DCubismCore.Version.csmGetLatestMocVersion()}getMocVersion(){return this._mocVersion}static hasMocConsistency(e){return Live2DCubismCore.Moc.prototype.hasMocConsistency(e)===1}}var qi;(a=>{a.CubismMoc=We})(qi||(qi={}));const Ji="Meta",Xa="UserDataCount",Ga="TotalUserDataSize",bt="UserData",ja="Target",Ya="Id",Ha="Value";class As{constructor(e,t){this._json=U.create(e,t)}release(){U.delete(this._json)}getUserDataCount(){return this._json.getRoot().getValueByString(Ji).getValueByString(Xa).toInt()}getTotalUserDataSize(){return this._json.getRoot().getValueByString(Ji).getValueByString(Ga).toInt()}getUserDataTargetType(e){return this._json.getRoot().getValueByString(bt).getValueByIndex(e).getValueByString(ja).getRawString()}getUserDataId(e){return T.getIdManager().getId(this._json.getRoot().getValueByString(bt).getValueByIndex(e).getValueByString(Ya).getRawString())}getUserDataValue(e){return this._json.getRoot().getValueByString(bt).getValueByIndex(e).getValueByString(Ha).getRawString()}}var Ki;(a=>{a.CubismModelUserDataJson=As})(Ki||(Ki={}));const Wa="ArtMesh";class ks{}class je{static create(e,t){const i=new je;return i.parseUserData(e,t),i}static delete(e){e!=null&&(e.release(),e=null)}getArtMeshUserDatas(){return this._artMeshUserDataNode}parseUserData(e,t){let i=new As(e,t);if(!i){i.release(),i=void 0;return}const s=T.getIdManager().getId(Wa),r=i.getUserDataCount();for(let n=0;n<r;n++){const o=new ks;o.targetId=i.getUserDataId(n),o.targetType=T.getIdManager().getId(i.getUserDataTargetType(n)),o.value=new $(i.getUserDataValue(n)),this._userDataNodes.pushBack(o),o.targetType==s&&this._artMeshUserDataNode.pushBack(o)}i.release(),i=void 0}constructor(){this._userDataNodes=new C,this._artMeshUserDataNode=new C}release(){for(let e=0;e<this._userDataNodes.getSize();++e)this._userDataNodes.set(e,null);this._userDataNodes=null}}var Zi;(a=>{a.CubismModelUserData=je,a.CubismModelUserDataNode=ks})(Zi||(Zi={}));class ct{isInitialized(){return this._initialized}setInitialized(e){this._initialized=e}isUpdating(){return this._updating}setUpdating(e){this._updating=e}setDragging(e,t){this._dragManager.set(e,t)}setAcceleration(e,t,i){this._accelerationX=e,this._accelerationY=t,this._accelerationZ=i}getModelMatrix(){return this._modelMatrix}setRenderTargetSize(e,t){this._renderer&&this._renderer.setRenderTargetSize(e,t)}setOpacity(e){this._opacity=e}getOpacity(){return this._opacity}loadModel(e,t=!1){if(this._moc=We.create(e,t),this._moc==null){w("Failed to CubismMoc.create().");return}if(this._model=this._moc.createModel(),this._model==null){w("Failed to CreateModel().");return}this._model.saveParameters(),this._modelMatrix=new hs(this._model.getCanvasWidth(),this._model.getCanvasHeight())}loadMotion(e,t,i,s,r,n,o,l,h=!1){if(e==null||t==0)return w("Failed to loadMotion()."),null;const u=gt.create(e,t,s,r,h);if(u==null)return w("Failed to create motion from buffer in LoadMotion()"),null;if(n){const d=n.getMotionFadeInTimeValue(o,l);d>=0&&u.setFadeInTime(d);const _=n.getMotionFadeOutTimeValue(o,l);_>=0&&u.setFadeOutTime(_)}return u}loadExpression(e,t,i){return e==null||t==0?(w("Failed to loadExpression()."),null):re.create(e,t)}loadPose(e,t){if(e==null||t==0){w("Failed to loadPose().");return}this._pose=Ue.create(e,t)}loadUserData(e,t){if(e==null||t==0){w("Failed to loadUserData().");return}this._modelUserData=je.create(e,t)}loadPhysics(e,t){if(e==null||t==0){w("Failed to loadPhysics().");return}this._physics=Ge.create(e,t)}isHit(e,t,i){const s=this._model.getDrawableIndex(e);if(s<0)return!1;const r=this._model.getDrawableVertexCount(s),n=this._model.getDrawableVertices(s);let o=n[0],l=n[0],h=n[1],u=n[1];for(let g=1;g<r;++g){const c=n[Z.vertexOffset+g*Z.vertexStep],p=n[Z.vertexOffset+g*Z.vertexStep+1];c<o&&(o=c),c>l&&(l=c),p<h&&(h=p),p>u&&(u=p)}const d=this._modelMatrix.invertTransformX(t),_=this._modelMatrix.invertTransformY(i);return o<=d&&d<=l&&h<=_&&_<=u}getModel(){return this._model}getRenderer(){return this._renderer}createRenderer(e,t,i=1){this._renderer&&this.deleteRenderer(),this._renderer=new It(e,t),this._renderer.initialize(this._model,i)}deleteRenderer(){this._renderer!=null&&(this._renderer.release(),this._renderer=null)}motionEventFired(e){z("{0}",e.s)}static cubismDefaultMotionEventCallback(e,t,i){const s=i;s?.motionEventFired(t)}constructor(){this._moc=null,this._model=null,this._motionManager=null,this._expressionManager=null,this._eyeBlink=null,this._breath=null,this._modelMatrix=null,this._pose=null,this._dragManager=null,this._physics=null,this._modelUserData=null,this._initialized=!1,this._updating=!1,this._opacity=1,this._lipsync=!0,this._lastLipSyncValue=0,this._dragX=0,this._dragY=0,this._accelerationX=0,this._accelerationY=0,this._accelerationZ=0,this._mocConsistency=!1,this._debugMode=!1,this._renderer=null,this._motionManager=new Bs,this._motionManager.setEventCallback(ct.cubismDefaultMotionEventCallback,this),this._expressionManager=new _s,this._dragManager=new us}release(){this._motionManager!=null&&(this._motionManager.release(),this._motionManager=null),this._expressionManager!=null&&(this._expressionManager.release(),this._expressionManager=null),this._moc!=null&&(this._moc.deleteModel(this._model),this._moc.release(),this._moc=null),this._modelMatrix=null,Ue.delete(this._pose),Ne.delete(this._eyeBlink),He.delete(this._breath),this._dragManager=null,Ge.delete(this._physics),je.delete(this._modelUserData),this.deleteRenderer()}}var Qi;(a=>{a.CubismUserModel=ct})(Qi||(Qi={}));let Ce=null;class Vt{constructor(){this.loadFiletoBytes=(e,t)=>{this._byteReader._fileByte=e,this._byteReader._fileDataView=new DataView(this._byteReader._fileByte),this._byteReader._fileSize=t},this._pcmData=null,this._userTimeSeconds=0,this._lastRms=0,this._sampleOffset=0,this._wavFileInfo=new $a,this._byteReader=new qa}static getInstance(){return Ce==null&&(Ce=new Vt),Ce}static releaseInstance(){Ce!=null&&(Ce=void 0),Ce=null}update(e){let t,i;if(this._pcmData==null||this._sampleOffset>=this._wavFileInfo._samplesPerChannel)return this._lastRms=0,!1;this._userTimeSeconds+=e,t=Math.floor(this._userTimeSeconds*this._wavFileInfo._samplingRate),t>this._wavFileInfo._samplesPerChannel&&(t=this._wavFileInfo._samplesPerChannel),i=0;for(let s=0;s<this._wavFileInfo._numberOfChannels;s++)for(let r=this._sampleOffset;r<t;r++){const n=this._pcmData[s][r];i+=n*n}return i=Math.sqrt(i/(this._wavFileInfo._numberOfChannels*(t-this._sampleOffset))),this._lastRms=i,this._sampleOffset=t,!0}start(e){this._sampleOffset=0,this._userTimeSeconds=0,this._lastRms=0,this.loadWavFile(e)}getRms(){return this._lastRms}loadWavFile(e){return new Promise(t=>{let i=!1;this._pcmData!=null&&this.releasePcmData();const s=async()=>fetch(e).then(r=>r.arrayBuffer());(async()=>{if(this._byteReader._fileByte=await s(),this._byteReader._fileDataView=new DataView(this._byteReader._fileByte),this._byteReader._fileSize=this._byteReader._fileByte.byteLength,this._byteReader._readOffset=0,this._byteReader._fileByte==null||this._byteReader._fileSize<4){t(!1);return}this._wavFileInfo._fileName=e;try{if(!this._byteReader.getCheckSignature("RIFF"))throw i=!1,new Error('Cannot find Signeture "RIFF".');if(this._byteReader.get32LittleEndian(),!this._byteReader.getCheckSignature("WAVE"))throw i=!1,new Error('Cannot find Signeture "WAVE".');if(!this._byteReader.getCheckSignature("fmt "))throw i=!1,new Error('Cannot find Signeture "fmt".');const r=this._byteReader.get32LittleEndian();if(this._byteReader.get16LittleEndian()!=1)throw i=!1,new Error("File is not linear PCM.");for(this._wavFileInfo._numberOfChannels=this._byteReader.get16LittleEndian(),this._wavFileInfo._samplingRate=this._byteReader.get32LittleEndian(),this._byteReader.get32LittleEndian(),this._byteReader.get16LittleEndian(),this._wavFileInfo._bitsPerSample=this._byteReader.get16LittleEndian(),r>16&&(this._byteReader._readOffset+=r-16);!this._byteReader.getCheckSignature("data")&&this._byteReader._readOffset<this._byteReader._fileSize;)this._byteReader._readOffset+=this._byteReader.get32LittleEndian()+4;if(this._byteReader._readOffset>=this._byteReader._fileSize)throw i=!1,new Error('Cannot find "data" Chunk.');{const n=this._byteReader.get32LittleEndian();this._wavFileInfo._samplesPerChannel=n*8/(this._wavFileInfo._bitsPerSample*this._wavFileInfo._numberOfChannels)}this._pcmData=new Array(this._wavFileInfo._numberOfChannels);for(let n=0;n<this._wavFileInfo._numberOfChannels;n++)this._pcmData[n]=new Float32Array(this._wavFileInfo._samplesPerChannel);for(let n=0;n<this._wavFileInfo._samplesPerChannel;n++)for(let o=0;o<this._wavFileInfo._numberOfChannels;o++)this._pcmData[o][n]=this.getPcmSample();i=!0,t(i)}catch(r){console.log(r)}})().then(()=>{t(i)})})}getPcmSample(){let e;switch(this._wavFileInfo._bitsPerSample){case 8:e=this._byteReader.get8()-128,e<<=24;break;case 16:e=this._byteReader.get16LittleEndian()<<16;break;case 24:e=this._byteReader.get24LittleEndian()<<8;break;default:e=0;break}return e/2147483647}getPcmDataChannel(e){return!this._pcmData||!(e<this._pcmData.length)?null:Float32Array.from(this._pcmData[e])}getWavSamplingRate(){return!this._wavFileInfo||this._wavFileInfo._samplingRate<1?null:this._wavFileInfo._samplingRate}releasePcmData(){for(let e=0;e<this._wavFileInfo._numberOfChannels;e++)this._pcmData[e]=null;delete this._pcmData,this._pcmData=null}}class $a{constructor(){this._fileName="",this._numberOfChannels=0,this._bitsPerSample=0,this._samplingRate=0,this._samplesPerChannel=0}}class qa{constructor(){this._fileByte=null,this._fileDataView=null,this._fileSize=0,this._readOffset=0}get8(){const e=this._fileDataView.getUint8(this._readOffset);return this._readOffset++,e}get16LittleEndian(){const e=this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=2,e}get24LittleEndian(){const e=this._fileDataView.getUint8(this._readOffset+2)<<16|this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=3,e}get32LittleEndian(){const e=this._fileDataView.getUint8(this._readOffset+3)<<24|this._fileDataView.getUint8(this._readOffset+2)<<16|this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=4,e}getCheckSignature(e){const t=new Uint8Array(4),i=new TextEncoder().encode(e);if(e.length!=4)return!1;for(let s=0;s<4;s++)t[s]=this.get8();return t[0]==i[0]&&t[1]==i[1]&&t[2]==i[2]&&t[3]==i[3]}}class Ja extends ct{loadAssets(e,t){this._modelHomeDir=e,fetch(`${this._modelHomeDir}${t}`).then(i=>i.arrayBuffer()).then(i=>{const s=new os(i,i.byteLength);this._state=1,this.setupModel(s)}).catch(i=>{w(`Failed to load file ${this._modelHomeDir}${t}`)})}setupModel(e){if(this._updating=!0,this._initialized=!1,this._modelSetting=e,this._modelSetting.getModelFileName()!=""){const _=this._modelSetting.getModelFileName();fetch(`${this._modelHomeDir}${_}`).then(g=>{if(g.ok)return g.arrayBuffer();if(g.status>=400)return w(`Failed to load file ${this._modelHomeDir}${_}`),new ArrayBuffer(0)}).then(g=>{this.loadModel(g,this._mocConsistency),this._state=3,t()}),this._state=2}else V.printMessage("Model data does not exist.");const t=()=>{if(this._modelSetting.getExpressionCount()>0){const _=this._modelSetting.getExpressionCount();for(let g=0;g<_;g++){const c=this._modelSetting.getExpressionName(g),p=this._modelSetting.getExpressionFileName(g);fetch(`${this._modelHomeDir}${p}`).then(f=>{if(f.ok)return f.arrayBuffer();if(f.status>=400)return w(`Failed to load file ${this._modelHomeDir}${p}`),new ArrayBuffer(0)}).then(f=>{const x=this.loadExpression(f,f.byteLength,c);this._expressions.getValue(c)!=null&&(Fe.delete(this._expressions.getValue(c)),this._expressions.setValue(c,null)),this._expressions.setValue(c,x),this._expressionCount++,this._expressionCount>=_&&(this._state=5,i())})}this._state=4}else this._state=5,i()},i=()=>{if(this._modelSetting.getPhysicsFileName()!=""){const _=this._modelSetting.getPhysicsFileName();fetch(`${this._modelHomeDir}${_}`).then(g=>{if(g.ok)return g.arrayBuffer();if(g.status>=400)return w(`Failed to load file ${this._modelHomeDir}${_}`),new ArrayBuffer(0)}).then(g=>{this.loadPhysics(g,g.byteLength),this._state=7,s()}),this._state=6}else this._state=7,s()},s=()=>{if(this._modelSetting.getPoseFileName()!=""){const _=this._modelSetting.getPoseFileName();fetch(`${this._modelHomeDir}${_}`).then(g=>{if(g.ok)return g.arrayBuffer();if(g.status>=400)return w(`Failed to load file ${this._modelHomeDir}${_}`),new ArrayBuffer(0)}).then(g=>{this.loadPose(g,g.byteLength),this._state=9,r()}),this._state=8}else this._state=9,r()},r=()=>{this._modelSetting.getEyeBlinkParameterCount()>0&&(this._eyeBlink=Ne.create(this._modelSetting),this._state=10),n()},n=()=>{this._breath=He.create();const _=new C;_.pushBack(new ye(this._idParamAngleX,0,15,6.5345,.5)),_.pushBack(new ye(this._idParamAngleY,0,8,3.5345,.5)),_.pushBack(new ye(this._idParamAngleZ,0,10,5.5345,.5)),_.pushBack(new ye(this._idParamBodyAngleX,0,4,15.5345,.5)),_.pushBack(new ye(T.getIdManager().getId(b.ParamBreath),.5,.5,3.2345,1)),this._breath.setParameters(_),this._state=11,o()},o=()=>{if(this._modelSetting.getUserDataFile()!=""){const _=this._modelSetting.getUserDataFile();fetch(`${this._modelHomeDir}${_}`).then(g=>{if(g.ok)return g.arrayBuffer();if(g.status>=400)return w(`Failed to load file ${this._modelHomeDir}${_}`),new ArrayBuffer(0)}).then(g=>{this.loadUserData(g,g.byteLength),this._state=13,l()}),this._state=12}else this._state=13,l()},l=()=>{const _=this._modelSetting.getEyeBlinkParameterCount();for(let g=0;g<_;++g)this._eyeBlinkIds.pushBack(this._modelSetting.getEyeBlinkParameterId(g));this._state=14,h()},h=()=>{const _=this._modelSetting.getLipSyncParameterCount();for(let g=0;g<_;++g)this._lipSyncIds.pushBack(this._modelSetting.getLipSyncParameterId(g));this._state=15,u()},u=()=>{const _=new N;if(this._modelSetting==null||this._modelMatrix==null){w("Failed to setupLayout().");return}this._modelSetting.getLayoutMap(_),this._modelMatrix.setupFromLayout(_),this._state=16,d()},d=()=>{this._state=17,this._model.saveParameters(),this._allMotionCount=0,this._motionCount=0;const _=[],g=this._modelSetting.getMotionGroupCount();for(let c=0;c<g;c++)_[c]=this._modelSetting.getMotionGroupName(c),this._allMotionCount+=this._modelSetting.getMotionCount(_[c]);for(let c=0;c<g;c++)this.preLoadMotionGroup(_[c]);g==0&&(this._state=20,this._motionManager.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(this._subdelegate.getCanvas().width,this._subdelegate.getCanvas().height),this.setupTextures(),this.getRenderer().startUp(this._subdelegate.getGlManager().getGl()))}}setupTextures(){if(this._state==20){const t=this._modelSetting.getTextureCount();for(let i=0;i<t;i++){if(this._modelSetting.getTextureFileName(i)==""){console.log("getTextureFileName null");continue}let s=this._modelSetting.getTextureFileName(i);s=this._modelHomeDir+s;const r=n=>{this.getRenderer().bindTexture(i,n.id),this._textureCount++,this._textureCount>=t&&(this._state=22)};this._subdelegate.getTextureManager().createTextureFromPngFile(s,!0,r),this.getRenderer().setIsPremultipliedAlpha(!0)}this._state=21}}reloadRenderer(){this.deleteRenderer(),this.createRenderer(this._subdelegate.getCanvas().width,this._subdelegate.getCanvas().height),this.setupTextures()}update(){if(this._state!=22)return;const e=V.getDeltaTime();this._userTimeSeconds+=e,this._dragManager.update(e),this._dragX=this._dragManager.getX(),this._dragY=this._dragManager.getY();let t=!1;if(this._model.loadParameters(),this._motionManager.isFinished()?this.startRandomMotion(sr,nr):t=this._motionManager.updateMotion(this._model,e),this._model.saveParameters(),t||this._eyeBlink!=null&&this._eyeBlink.updateParameters(this._model,e),this._expressionManager!=null&&this._expressionManager.updateMotion(this._model,e),this._model.addParameterValueById(this._idParamAngleX,this._dragX*30),this._model.addParameterValueById(this._idParamAngleY,this._dragY*30),this._model.addParameterValueById(this._idParamAngleZ,this._dragX*this._dragY*-30),this._model.addParameterValueById(this._idParamBodyAngleX,this._dragX*10),this._model.addParameterValueById(this._idParamEyeBallX,this._dragX),this._model.addParameterValueById(this._idParamEyeBallY,this._dragY),this._breath!=null&&this._breath.updateParameters(this._model,e),this._physics!=null&&this._physics.evaluate(this._model,e),this._lipsync){let i=0;this._wavFileHandler.update(e),i=this._wavFileHandler.getRms();for(let s=0;s<this._lipSyncIds.getSize();++s)this._model.addParameterValueById(this._lipSyncIds.at(s),i,.8)}this._pose!=null&&this._pose.updateParameters(this._model,e),this._model.update()}startMotion(e,t,i,s,r){if(i==lr)this._motionManager.setReservePriority(i);else if(!this._motionManager.reserveMotion(i))return this._debugMode&&V.printMessage("[APP]can't start motion."),Oe;const n=this._modelSetting.getMotionFileName(e,t),o=`${e}_${t}`;let l=this._motions.getValue(o),h=!1;if(l==null)if(fetch(`${this._modelHomeDir}${n}`).then(d=>{if(d.ok)return d.arrayBuffer();if(d.status>=400)return w(`Failed to load file ${this._modelHomeDir}${n}`),new ArrayBuffer(0)}).then(d=>{l=this.loadMotion(d,d.byteLength,null,s,r,this._modelSetting,e,t,this._motionConsistency)}),l)l.setEffectIds(this._eyeBlinkIds,this._lipSyncIds),h=!0;else return w("Can't start motion {0} .",n),this._motionManager.setReservePriority(ar),Oe;else l.setBeganMotionHandler(r),l.setFinishedMotionHandler(s);const u=this._modelSetting.getMotionSoundFileName(e,t);if(u.localeCompare("")!=0){let d=u;d=this._modelHomeDir+d,this._wavFileHandler.start(d)}return this._debugMode&&V.printMessage(`[APP]start motion: [${e}_${t}]`),this._motionManager.startMotionPriority(l,h,i)}startRandomMotion(e,t,i,s){if(this._modelSetting.getMotionCount(e)==0)return Oe;const r=Math.floor(Math.random()*this._modelSetting.getMotionCount(e));return this.startMotion(e,r,t,i,s)}setExpression(e){const t=this._expressions.getValue(e);this._debugMode&&V.printMessage(`[APP]expression: [${e}]`),t!=null?this._expressionManager.startMotion(t,!1):this._debugMode&&V.printMessage(`[APP]expression[${e}] is null`)}setRandomExpression(){if(this._expressions.getSize()==0)return;const e=Math.floor(Math.random()*this._expressions.getSize());for(let t=0;t<this._expressions.getSize();t++)if(t==e){const i=this._expressions._keyValues[t].first;this.setExpression(i);return}}motionEventFired(e){z("{0} is fired on LAppModel!!",e.s)}hitTest(e,t,i){if(this._opacity<1)return!1;const s=this._modelSetting.getHitAreasCount();for(let r=0;r<s;r++)if(this._modelSetting.getHitAreaName(r)==e){const n=this._modelSetting.getHitAreaId(r);return this.isHit(n,t,i)}return!1}preLoadMotionGroup(e){for(let t=0;t<this._modelSetting.getMotionCount(e);t++){const i=this._modelSetting.getMotionFileName(e,t),s=`${e}_${t}`;this._debugMode&&V.printMessage(`[APP]load motion: ${i} => [${s}]`),fetch(`${this._modelHomeDir}${i}`).then(r=>{if(r.ok)return r.arrayBuffer();if(r.status>=400)return w(`Failed to load file ${this._modelHomeDir}${i}`),new ArrayBuffer(0)}).then(r=>{const n=this.loadMotion(r,r.byteLength,s,null,null,this._modelSetting,e,t,this._motionConsistency);n!=null?(n.setEffectIds(this._eyeBlinkIds,this._lipSyncIds),this._motions.getValue(s)!=null&&Fe.delete(this._motions.getValue(s)),this._motions.setValue(s,n),this._motionCount++):this._allMotionCount--,this._motionCount>=this._allMotionCount&&(this._state=20,this._motionManager.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(this._subdelegate.getCanvas().width,this._subdelegate.getCanvas().height),this.setupTextures(),this.getRenderer().startUp(this._subdelegate.getGlManager().getGl()))})}}releaseMotions(){this._motions.clear()}releaseExpressions(){this._expressions.clear()}doDraw(){if(this._model==null)return;const e=this._subdelegate.getCanvas(),t=[0,0,e.width,e.height];this.getRenderer().setRenderState(this._subdelegate.getFrameBuffer(),t),this.getRenderer().drawModel()}draw(e){this._model!=null&&this._state==22&&(e.multiplyByMatrix(this._modelMatrix),this.getRenderer().setMvpMatrix(e),this.doDraw())}async hasMocConsistencyFromFile(){if(G(this._modelSetting.getModelFileName().localeCompare("")),this._modelSetting.getModelFileName()!=""){const e=this._modelSetting.getModelFileName(),i=await(await fetch(`${this._modelHomeDir}${e}`)).arrayBuffer();return this._consistency=We.hasMocConsistency(i),this._consistency?z("Consistent MOC3."):z("Inconsistent MOC3."),this._consistency}else V.printMessage("Model data does not exist.")}setSubdelegate(e){this._subdelegate=e}constructor(){super(),this._modelSetting=null,this._modelHomeDir=null,this._userTimeSeconds=0,this._eyeBlinkIds=new C,this._lipSyncIds=new C,this._motions=new N,this._expressions=new N,this._hitArea=new C,this._userArea=new C,this._idParamAngleX=T.getIdManager().getId(b.ParamAngleX),this._idParamAngleY=T.getIdManager().getId(b.ParamAngleY),this._idParamAngleZ=T.getIdManager().getId(b.ParamAngleZ),this._idParamEyeBallX=T.getIdManager().getId(b.ParamEyeBallX),this._idParamEyeBallY=T.getIdManager().getId(b.ParamEyeBallY),this._idParamBodyAngleX=T.getIdManager().getId(b.ParamBodyAngleX),this._mocConsistency=!0,this._motionConsistency=!0,this._state=0,this._expressionCount=0,this._textureCount=0,this._motionCount=0,this._allMotionCount=0,this._wavFileHandler=new Vt,this._consistency=!1}}class Ka{constructor(){this.beganMotion=e=>{V.printMessage("Motion Began:"),console.log(e)},this.finishedMotion=e=>{V.printMessage("Motion Finished:"),console.log(e)},this._subdelegate=null,this._viewMatrix=new E,this._models=new C,this._sceneIndex=0}releaseAllModel(){this._models.clear()}setOffscreenSize(e,t){for(let i=0;i<this._models.getSize();i++)this._models.at(i)?.setRenderTargetSize(e,t)}onDrag(e,t){const i=this._models.at(0);i&&i.setDragging(e,t)}onTap(e,t){V.printMessage(`[APP]tap point: {x: ${e.toFixed(2)} y: ${t.toFixed(2)}}`);const i=this._models.at(0);i.hitTest(qt,e,t)?(V.printMessage(`[APP]hit area: [${qt}]`),i.setRandomExpression()):i.hitTest(Jt,e,t)&&(V.printMessage(`[APP]hit area: [${Jt}]`),i.startRandomMotion(rr,or,this.finishedMotion,this.beganMotion))}onUpdate(){const{width:e,height:t}=this._subdelegate.getCanvas(),i=new E,s=this._models.at(0);s.getModel()&&(s.getModel().getCanvasWidth()>1&&e<t?(s.getModelMatrix().setWidth(2),i.scale(1,e/t)):i.scale(t/e,1),this._viewMatrix!=null&&i.multiplyByMatrix(this._viewMatrix)),s.update(),s.draw(i)}nextScene(){const e=(this._sceneIndex+1)%ir;this.changeScene(e)}changeScene(e){this._sceneIndex=e,V.printMessage(`[APP]model index: ${this._sceneIndex}`);const t=xt[e],i=rs+t+"/";let s=xt[e];s+=".model3.json",this.releaseAllModel();const r=new Ja;r.setSubdelegate(this._subdelegate),r.loadAssets(i,s),this._models.pushBack(r)}setViewMatrix(e){for(let t=0;t<16;t++)this._viewMatrix.getArray()[t]=e.getArray()[t]}addModel(e=0){this._sceneIndex=e,this.changeScene(this._sceneIndex)}release(){}initialize(e){this._subdelegate=e,this.changeScene(this._sceneIndex)}}class Za{constructor(){this._textures=new C}release(){for(let e=this._textures.begin();e.notEqual(this._textures.end());e.preIncrement())this._glManager.getGl().deleteTexture(e.ptr().id);this._textures=null}createTextureFromPngFile(e,t,i){for(let r=this._textures.begin();r.notEqual(this._textures.end());r.preIncrement())if(r.ptr().fileName==e&&r.ptr().usePremultply==t){r.ptr().img=new Image,r.ptr().img.addEventListener("load",()=>i(r.ptr()),{passive:!0}),r.ptr().img.src=e;return}const s=new Image;s.addEventListener("load",()=>{const r=this._glManager.getGl().createTexture();this._glManager.getGl().bindTexture(this._glManager.getGl().TEXTURE_2D,r),this._glManager.getGl().texParameteri(this._glManager.getGl().TEXTURE_2D,this._glManager.getGl().TEXTURE_MIN_FILTER,this._glManager.getGl().LINEAR_MIPMAP_LINEAR),this._glManager.getGl().texParameteri(this._glManager.getGl().TEXTURE_2D,this._glManager.getGl().TEXTURE_MAG_FILTER,this._glManager.getGl().LINEAR),t&&this._glManager.getGl().pixelStorei(this._glManager.getGl().UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),this._glManager.getGl().texImage2D(this._glManager.getGl().TEXTURE_2D,0,this._glManager.getGl().RGBA,this._glManager.getGl().RGBA,this._glManager.getGl().UNSIGNED_BYTE,s),this._glManager.getGl().generateMipmap(this._glManager.getGl().TEXTURE_2D),this._glManager.getGl().bindTexture(this._glManager.getGl().TEXTURE_2D,null);const n=new Qa;n!=null&&(n.fileName=e,n.width=s.width,n.height=s.height,n.id=r,n.img=s,n.usePremultply=t,this._textures!=null&&this._textures.pushBack(n)),i(n)},{passive:!0}),s.src=e}releaseTextures(){for(let e=0;e<this._textures.getSize();e++)this._glManager.getGl().deleteTexture(this._textures.at(e).id),this._textures.set(e,null);this._textures.clear()}releaseTextureByTexture(e){for(let t=0;t<this._textures.getSize();t++)if(this._textures.at(t).id==e){this._glManager.getGl().deleteTexture(this._textures.at(t).id),this._textures.set(t,null),this._textures.remove(t);break}}releaseTextureByFilePath(e){for(let t=0;t<this._textures.getSize();t++)if(this._textures.at(t).fileName==e){this._glManager.getGl().deleteTexture(this._textures.at(t).id),this._textures.set(t,null),this._textures.remove(t);break}}setGlManager(e){this._glManager=e}}class Qa{constructor(){this.id=null,this.width=0,this.height=0}}class Ns extends E{constructor(){super(),this._screenLeft=0,this._screenRight=0,this._screenTop=0,this._screenBottom=0,this._maxLeft=0,this._maxRight=0,this._maxTop=0,this._maxBottom=0,this._maxScale=0,this._minScale=0}adjustTranslate(e,t){this._tr[0]*this._maxLeft+(this._tr[12]+e)>this._screenLeft&&(e=this._screenLeft-this._tr[0]*this._maxLeft-this._tr[12]),this._tr[0]*this._maxRight+(this._tr[12]+e)<this._screenRight&&(e=this._screenRight-this._tr[0]*this._maxRight-this._tr[12]),this._tr[5]*this._maxTop+(this._tr[13]+t)<this._screenTop&&(t=this._screenTop-this._tr[5]*this._maxTop-this._tr[13]),this._tr[5]*this._maxBottom+(this._tr[13]+t)>this._screenBottom&&(t=this._screenBottom-this._tr[5]*this._maxBottom-this._tr[13]);const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e,t,0,1]);E.multiply(i,this._tr,this._tr)}adjustScale(e,t,i){const s=this.getMaxScale(),r=this.getMinScale(),n=i*this._tr[0];n<r?this._tr[0]>0&&(i=r/this._tr[0]):n>s&&this._tr[0]>0&&(i=s/this._tr[0]);const o=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e,t,0,1]),l=new Float32Array([i,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1]),h=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-e,-t,0,1]);E.multiply(h,this._tr,this._tr),E.multiply(l,this._tr,this._tr),E.multiply(o,this._tr,this._tr)}setScreenRect(e,t,i,s){this._screenLeft=e,this._screenRight=t,this._screenBottom=i,this._screenTop=s}setMaxScreenRect(e,t,i,s){this._maxLeft=e,this._maxRight=t,this._maxTop=s,this._maxBottom=i}setMaxScale(e){this._maxScale=e}setMinScale(e){this._minScale=e}getMaxScale(){return this._maxScale}getMinScale(){return this._minScale}isMaxScale(){return this.getScaleX()>=this._maxScale}isMinScale(){return this.getScaleX()<=this._minScale}getScreenLeft(){return this._screenLeft}getScreenRight(){return this._screenRight}getScreenBottom(){return this._screenBottom}getScreenTop(){return this._screenTop}getMaxLeft(){return this._maxLeft}getMaxRight(){return this._maxRight}getMaxBottom(){return this._maxBottom}getMaxTop(){return this._maxTop}}var es;(a=>{a.CubismViewMatrix=Ns})(es||(es={}));class ts{constructor(e,t,i,s,r){this._rect=new en,this._rect.left=e-i*.5,this._rect.right=e+i*.5,this._rect.up=t+s*.5,this._rect.down=t-s*.5,this._texture=r,this._vertexBuffer=null,this._uvBuffer=null,this._indexBuffer=null,this._positionLocation=null,this._uvLocation=null,this._textureLocation=null,this._positionArray=null,this._uvArray=null,this._indexArray=null,this._firstDraw=!0}release(){this._rect=null;const e=this._subdelegate.getGlManager().getGl();e.deleteTexture(this._texture),this._texture=null,e.deleteBuffer(this._uvBuffer),this._uvBuffer=null,e.deleteBuffer(this._vertexBuffer),this._vertexBuffer=null,e.deleteBuffer(this._indexBuffer),this._indexBuffer=null}getTexture(){return this._texture}render(e){if(this._texture==null)return;const t=this._subdelegate.getGlManager().getGl();if(this._firstDraw){this._positionLocation=t.getAttribLocation(e,"position"),t.enableVertexAttribArray(this._positionLocation),this._uvLocation=t.getAttribLocation(e,"uv"),t.enableVertexAttribArray(this._uvLocation),this._textureLocation=t.getUniformLocation(e,"texture"),t.uniform1i(this._textureLocation,0),this._uvArray=new Float32Array([1,0,0,0,0,1,1,1]),this._uvBuffer=t.createBuffer();{const i=this._subdelegate.getCanvas().width,s=this._subdelegate.getCanvas().height;this._positionArray=new Float32Array([(this._rect.right-i*.5)/(i*.5),(this._rect.up-s*.5)/(s*.5),(this._rect.left-i*.5)/(i*.5),(this._rect.up-s*.5)/(s*.5),(this._rect.left-i*.5)/(i*.5),(this._rect.down-s*.5)/(s*.5),(this._rect.right-i*.5)/(i*.5),(this._rect.down-s*.5)/(s*.5)]),this._vertexBuffer=t.createBuffer()}this._indexArray=new Uint16Array([0,1,2,3,2,0]),this._indexBuffer=t.createBuffer(),this._firstDraw=!1}t.bindBuffer(t.ARRAY_BUFFER,this._uvBuffer),t.bufferData(t.ARRAY_BUFFER,this._uvArray,t.STATIC_DRAW),t.vertexAttribPointer(this._uvLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,this._positionArray,t.STATIC_DRAW),t.vertexAttribPointer(this._positionLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indexArray,t.DYNAMIC_DRAW),t.bindTexture(t.TEXTURE_2D,this._texture),t.drawElements(t.TRIANGLES,this._indexArray.length,t.UNSIGNED_SHORT,0)}isHit(e,t){const{height:i}=this._subdelegate.getCanvas(),s=i-t;return e>=this._rect.left&&e<=this._rect.right&&s<=this._rect.up&&s>=this._rect.down}setSubdelegate(e){this._subdelegate=e}}class en{}class tn{constructor(){this._startX=0,this._startY=0,this._lastX=0,this._lastY=0,this._lastX1=0,this._lastY1=0,this._lastX2=0,this._lastY2=0,this._lastTouchDistance=0,this._deltaX=0,this._deltaY=0,this._scale=1,this._touchSingle=!1,this._flipAvailable=!1}getCenterX(){return this._lastX}getCenterY(){return this._lastY}getDeltaX(){return this._deltaX}getDeltaY(){return this._deltaY}getStartX(){return this._startX}getStartY(){return this._startY}getScale(){return this._scale}getX(){return this._lastX}getY(){return this._lastY}getX1(){return this._lastX1}getY1(){return this._lastY1}getX2(){return this._lastX2}getY2(){return this._lastY2}isSingleTouch(){return this._touchSingle}isFlickAvailable(){return this._flipAvailable}disableFlick(){this._flipAvailable=!1}touchesBegan(e,t){this._lastX=e,this._lastY=t,this._startX=e,this._startY=t,this._lastTouchDistance=-1,this._flipAvailable=!0,this._touchSingle=!0}touchesMoved(e,t){this._lastX=e,this._lastY=t,this._lastTouchDistance=-1,this._touchSingle=!0}getFlickDistance(){return this.calculateDistance(this._startX,this._startY,this._lastX,this._lastY)}calculateDistance(e,t,i,s){return Math.sqrt((e-i)*(e-i)+(t-s)*(t-s))}calculateMovingAmount(e,t){if(e>0!=t>0)return 0;const i=e>0?1:-1,s=Math.abs(e),r=Math.abs(t);return i*(s<r?s:r)}}class sn{constructor(){this._programId=null,this._back=null,this._gear=null,this._touchManager=new tn,this._deviceToScreen=new E,this._viewMatrix=new Ns}initialize(e){this._subdelegate=e;const{width:t,height:i}=e.getCanvas(),s=t/i,r=-s,n=s,o=$s,l=qs;if(this._viewMatrix.setScreenRect(r,n,o,l),this._viewMatrix.scale($t,$t),this._deviceToScreen.loadIdentity(),t>i){const h=Math.abs(n-r);this._deviceToScreen.scaleRelative(h/t,-h/t)}else{const h=Math.abs(l-o);this._deviceToScreen.scaleRelative(h/i,-h/i)}this._deviceToScreen.translateRelative(-t*.5,-i*.5),this._viewMatrix.setMaxScale(Hs),this._viewMatrix.setMinScale(Ws),this._viewMatrix.setMaxScreenRect(Js,Ks,Zs,Qs)}release(){this._viewMatrix=null,this._touchManager=null,this._deviceToScreen=null,this._gear.release(),this._gear=null,this._back.release(),this._back=null,this._subdelegate.getGlManager().getGl().deleteProgram(this._programId),this._programId=null}render(){this._subdelegate.getGlManager().getGl().useProgram(this._programId),this._back&&this._back.render(this._programId),this._gear&&this._gear.render(this._programId),this._subdelegate.getGlManager().getGl().flush();const e=this._subdelegate.getLive2DManager();e!=null&&(e.setViewMatrix(this._viewMatrix),e.onUpdate())}initializeSprite(){const e=this._subdelegate.getCanvas().width,t=this._subdelegate.getCanvas().height,i=this._subdelegate.getTextureManager(),s=rs;let r="";r=er;const n=l=>{const h=e*.5,u=t*.5,d=l.width*2,_=t*.95;this._back=new ts(h,u,d,_,l.id),this._back.setSubdelegate(this._subdelegate)};i.createTextureFromPngFile(s+r,!1,n),r=tr;const o=l=>{const h=e-l.width*.5,u=t-l.height*.5,d=l.width,_=l.height;this._gear=new ts(h,u,d,_,l.id),this._gear.setSubdelegate(this._subdelegate)};i.createTextureFromPngFile(s+r,!1,o),this._programId==null&&(this._programId=this._subdelegate.createShader())}onTouchesBegan(e,t){this._touchManager.touchesBegan(e*window.devicePixelRatio,t*window.devicePixelRatio)}onTouchesMoved(e,t){const i=e*window.devicePixelRatio,s=t*window.devicePixelRatio,r=this._subdelegate.getLive2DManager(),n=this.transformViewX(this._touchManager.getX()),o=this.transformViewY(this._touchManager.getY());this._touchManager.touchesMoved(i,s),r.onDrag(n,o)}onTouchesEnded(e,t){const i=e*window.devicePixelRatio,s=t*window.devicePixelRatio,r=this._subdelegate.getLive2DManager();r.onDrag(0,0);const n=this.transformViewX(i),o=this.transformViewY(s);r.onTap(n,o),this._gear.isHit(i,s)&&r.nextScene()}transformViewX(e){const t=this._deviceToScreen.transformX(e);return this._viewMatrix.invertTransformX(t)}transformViewY(e){const t=this._deviceToScreen.transformY(e);return this._viewMatrix.invertTransformY(t)}transformScreenX(e){return this._deviceToScreen.transformX(e)}transformScreenY(e){return this._deviceToScreen.transformY(e)}}class rn{constructor(){this._canvas=null,this._glManager=new ur,this._textureManager=new Za,this._live2dManager=new Ka,this._view=new sn,this._frameBuffer=null,this._captured=!1}release(){this._resizeObserver.unobserve(this._canvas),this._resizeObserver.disconnect(),this._resizeObserver=null,this._live2dManager.release(),this._live2dManager=null,this._view.release(),this._view=null,this._textureManager.release(),this._textureManager=null,this._glManager.release(),this._glManager=null}initialize(e){if(!this._glManager.initialize(e))return!1;this._canvas=e,this.resizeCanvas(),this._textureManager.setGlManager(this._glManager);const t=this._glManager.getGl();return this._frameBuffer||(this._frameBuffer=t.getParameter(t.FRAMEBUFFER_BINDING)),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this._view.initialize(this),this._live2dManager.setOffscreenSize(this._canvas.width,this._canvas.height),this._view.initializeSprite(),this._live2dManager.initialize(this),this._resizeObserver=new ResizeObserver((i,s)=>this.resizeObserverCallback.call(this,i,s)),this._resizeObserver.observe(this._canvas),!0}onResize(){this.resizeCanvas(),this._view.initialize(this),this._view.initializeSprite()}resizeObserverCallback(e,t){this._needResize=!0}update(){if(this._glManager.getGl().isContextLost())return;this._needResize&&(this.onResize(),this._needResize=!1);const e=this._glManager.getGl();e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this._view.render()}createShader(){const e=this._glManager.getGl(),t=e.createShader(e.VERTEX_SHADER);if(t==null)return V.printMessage("failed to create vertexShader"),null;e.shaderSource(t,"precision mediump float;attribute vec3 position;attribute vec2 uv;varying vec2 vuv;void main(void){   gl_Position = vec4(position, 1.0);   vuv = uv;}"),e.compileShader(t);const s=e.createShader(e.FRAGMENT_SHADER);if(s==null)return V.printMessage("failed to create fragmentShader"),null;e.shaderSource(s,"precision mediump float;varying vec2 vuv;uniform sampler2D texture;void main(void){   gl_FragColor = texture2D(texture, vuv);}"),e.compileShader(s);const n=e.createProgram();return e.attachShader(n,t),e.attachShader(n,s),e.deleteShader(t),e.deleteShader(s),e.linkProgram(n),e.useProgram(n),n}getTextureManager(){return this._textureManager}getFrameBuffer(){return this._frameBuffer}getCanvas(){return this._canvas}getGlManager(){return this._glManager}getLive2DManager(){return this._live2dManager}resizeCanvas(){this._canvas.width=this._canvas.clientWidth*window.devicePixelRatio,this._canvas.height=this._canvas.clientHeight*window.devicePixelRatio;const e=this._glManager.getGl();e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)}onPointBegan(e,t){if(!this._view){V.printMessage("view notfound");return}this._captured=!0;const i=e-this._canvas.offsetLeft,s=t-this._canvas.offsetTop;this._view.onTouchesBegan(i,s)}onPointMoved(e,t){if(!this._captured)return;const i=e-this._canvas.offsetLeft,s=t-this._canvas.offsetTop;this._view.onTouchesMoved(i,s)}onPointEnded(e,t){if(this._captured=!1,!this._view){V.printMessage("view notfound");return}const i=e-this._canvas.offsetLeft,s=t-this._canvas.offsetTop;this._view.onTouchesEnded(i,s)}onTouchCancel(e,t){if(this._captured=!1,!this._view){V.printMessage("view notfound");return}const i=e-this._canvas.offsetLeft,s=t-this._canvas.offsetTop;this._view.onTouchesEnded(i,s)}isContextLost(){return this._glManager.getGl().isContextLost()}}let he=null;class Ye{static getInstance(){return he==null&&(he=new Ye),he}static releaseInstance(){he?.release(),he=null}onPointerBegan(e){for(let t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onPointBegan(e.pageX,e.pageY)}onPointerMoved(e){for(let t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onPointMoved(e.pageX,e.pageY)}onPointerEnded(e){for(let t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onPointEnded(e.pageX,e.pageY)}onPointerCancel(e){for(let t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onTouchCancel(e.pageX,e.pageY)}onResize(){for(let e=0;e<this._subdelegates.getSize();e++)this._subdelegates.at(e).onResize()}run(){const e=()=>{if(he!=null){V.updateTime();for(let t=0;t<this._subdelegates.getSize();t++)this._subdelegates.at(t).update();requestAnimationFrame(e)}};e()}release(){this.releaseEventListener(),this.releaseSubdelegates(),T.dispose(),this._cubismOption=null}releaseEventListener(){document.removeEventListener("pointerup",this.pointBeganEventListener),this.pointBeganEventListener=null,document.removeEventListener("pointermove",this.pointMovedEventListener),this.pointMovedEventListener=null,document.removeEventListener("pointerdown",this.pointEndedEventListener),this.pointEndedEventListener=null,document.removeEventListener("pointerdown",this.pointCancelEventListener),this.pointCancelEventListener=null}releaseSubdelegates(){for(let e=this._subdelegates.begin();e.notEqual(this._subdelegates.end());e.preIncrement())e.ptr().release();this._subdelegates.clear(),this._subdelegates=null}initialize(){return this.initializeCubism(),this.initializeSubdelegates(),this.initializeEventListener(),!0}initializeEventListener(){this.pointBeganEventListener=this.onPointerBegan.bind(this),this.pointMovedEventListener=this.onPointerMoved.bind(this),this.pointEndedEventListener=this.onPointerEnded.bind(this),this.pointCancelEventListener=this.onPointerCancel.bind(this),document.addEventListener("pointerdown",this.pointBeganEventListener,{passive:!0}),document.addEventListener("pointermove",this.pointMovedEventListener,{passive:!0}),document.addEventListener("pointerup",this.pointEndedEventListener,{passive:!0}),document.addEventListener("pointercancel",this.pointCancelEventListener,{passive:!0})}initializeCubism(){V.updateTime(),this._cubismOption.logFunction=V.printMessage,this._cubismOption.loggingLevel=hr,T.startUp(this._cubismOption),T.initialize()}initializeSubdelegates(){let e=100,t=100;e=100/Re,this._canvases.prepareCapacity(Re),this._subdelegates.prepareCapacity(Re);for(let i=0;i<Re;i++){const s=document.createElement("canvas");this._canvases.pushBack(s),s.style.width=`${e}vw`,s.style.height=`${t}vh`,document.body.appendChild(s)}for(let i=0;i<this._canvases.getSize();i++){const s=new rn;s.initialize(this._canvases.at(i)),this._subdelegates.pushBack(s)}for(let i=0;i<Re;i++)this._subdelegates.at(i).isContextLost()&&w(`The context for Canvas at index ${i} was lost, possibly because the acquisition limit for WebGLRenderingContext was reached.`)}constructor(){this._cubismOption=new Ys,this._subdelegates=new C,this._canvases=new C}}window.addEventListener("load",()=>{Ye.getInstance().initialize()&&Ye.getInstance().run()},{passive:!0});window.addEventListener("beforeunload",()=>Ye.releaseInstance(),{passive:!0});
//# sourceMappingURL=index-CRI3lV-H.js.map
